<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Carregamento de Caminhões</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
    <link rel="stylesheet" href="./css/teste.css">
</head>
<body>
    <!-- Tela de Login/Seleção de Unidade -->
    <div id="loginContainer" class="container login-container">
        <div class="text-center mb-4">
            <h2>Sistema de Carregamento</h2>
            <p class="text-muted">Selecione sua unidade para continuar</p>
        </div>
        <div class="mb-3">
            <label for="unidade" class="form-label">Unidade</label>
            <select class="form-select" id="unidade">
                <option value="">Selecione a unidade</option>
                <option value="cd_cariacica">CD Cariacica</option>
                <option value="fabrica_belem">Fábrica Belém</option>
                <option value="fabrica_maracanau">Fábrica Maracanau</option>
                <option value="fabrica_imperatriz">Fábrica Imperatriz</option>
                <option value="fabrica_Mogi_Das_Cruzes">Fábrica Mogi Das Cruzes</option>
                <option value="fabrica_aracruz">Fábrica Aracruz</option>
                <option value="teste">teste</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="senha" class="form-label">Senha</label>
            <input type="password" class="form-control" id="senha" placeholder="Digite sua senha">
        </div>
        <button id="btnLogin" class="btn btn-primary w-100">Entrar</button>
        <div id="loginError" class="alert alert-danger mt-3 d-none"></div>
    </div>

    <!-- Sistema Principal (oculto inicialmente) -->
    <div id="mainContainer" class="container" style="display: none;">
        <h1 class="text-center mb-4">Sistema de Carregamento de Caminhões</h1>

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="home" aria-selected="true">Operação</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cadastro-tab" data-bs-toggle="tab" data-bs-target="#cadastro" type="button" role="tab" aria-controls="cadastro" aria-selected="false">Cadastrar Funcionário</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="busca-tab" data-bs-toggle="tab" data-bs-target="#busca" type="button" role="tab" aria-controls="busca" aria-selected="false">Buscar Funcionário</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="false">Dashboard</button>
            </li>
            <li class="nav-item" role="presentation">
            </li>
             <li class="nav-item" role="presentation">
                <button class="nav-link" id="ranking-tab" data-bs-toggle="tab" data-bs-target="#ranking" type="button" role="tab" aria-controls="ranking" aria-selected="false">Ranking</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="docas-tab" data-bs-toggle="tab" data-bs-target="#docas" type="button" role="tab" aria-controls="docas" aria-selected="false">Painel de Controle</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="historico-tab" data-bs-toggle="tab" data-bs-target="#historico" type="button" role="tab" aria-controls="historico" aria-selected="false">Histórico</button>
            </li>
        </ul>

        <button id="dashboard2-tab"></button>

        <div class="tab-content" id="myTabContent">
            
            <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Operações de Carregamento</h5>
                                <button id="btnIniciarCarregamento" class="btn btn-primary btn-lg w-100 mb-3">Iniciar Carregamento</button>
                                <button id="btnFinalizarCarregamento" class="btn btn-success btn-lg w-100">Finalizar Carregamento</button>
                                <button id="btnPausarCarregamento" class="btn btn-warning btn-lg w-100 mt-3">Pausar/Retomar Carregamento</button>
                                <button id="btnAddFuncionarioCarregamento" class="btn btn-secondary btn-lg w-100 mt-3">Adicionar Funcionário a Carregamento Existente</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Informações</h5>
                                <p>Use a câmera para ler o QR code do funcionário ou digite manualmente o código.</p>
                                <p>Os códigos começam com <strong>GZL-EO</strong> seguido de identificação única.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-3" id="formContainer" style="display: none;">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title" id="formTitle">Informações do Carregamento</h5>
                
                <!-- Campos comuns a ambos os tipos -->
                <div class="mb-3">
                    <label for="funcionarioPrincipal" class="form-label">Código do Funcionário Principal</label>
                    <div class="input-group">
                        <input type="text" id="funcionarioPrincipal" class="form-control funcionario-input" placeholder="Ex: GZL-EO-1234">
                        <button class="btn btn-outline-secondary btn-scan" type="button">
                            <i class="bi bi-camera"></i> Ler QR Code
                        </button>
                    </div>
                </div>
                <!-- Container para carregadores adicionais -->
                <div id="carregadoresContainer"></div>
                <button id="btnAddCarregador" class="btn btn-outline-primary btn-sm mb-3">
                    <i class="bi bi-plus"></i> Adicionar carregador
                </button>
                
                <!-- Tipo de Operação (sempre visível) -->
                <div class="mb-3">
                    <label class="form-label">Tipo de Operação</label>
                    <select id="tipoOperacao" class="form-select">
                        <option value="carregamento">Carregamento</option>
                        <option value="separacao">Separação</option>
                        <option value="descarregamento">Descarregamento</option>
                    </select>
                </div>
                
                <!-- Doca (sempre visível) -->
                <div class="mb-3">
                    <label class="form-label">Doca</label>
                    <select class="form-select" id="docaNumero">
                        <option value="">Selecione a Doca</option>
                        <option value="1">Doca 1</option>
                        <option value="2">Doca 2</option>
                        <option value="3">Doca 3</option>
                        <option value="4">Doca 4</option>
                        <option value="5">Doca 5</option>
                        <option value="6">Doca 6</option>
                        <option value="7">Doca 7</option>
                        <option value="8">Doca 8</option>
                        <option value="9">Doca 9</option>
                        <option value="10">Doca 10</option>
                        <option value="11">Doca 11</option>
                    </select>
                </div>
                
                <!-- Campos específicos para CARREGAMENTO (inicialmente visíveis) -->
                <div class="mb-3" id="placaContainer">
                    <label class="form-label">DT</label>
                    <input type="text" class="form-control" id="placaCaminhao" placeholder="Ex: 12345">
                </div>
                
                <div class="mb-3" id="tipoVeiculoContainer">
                    <label class="form-label">Tipo de Veículo</label>
                    <select class="form-select" id="tipoVeiculo">
                        <option value="">Selecione...</option>
                        <option value="carreta">Carreta</option>
                        <option value="rodotrem">Rodotrem</option>
                        <option value="truck">Truck</option>
                        <option value="608">608</option>
                        <option value="kombi">Kombi</option>
                    </select>
                </div>
                
                <div class="mb-3" id="armagensContainer">
                    <label class="form-label">Armazens (onde foi buscar material)</label>
                    <select class="form-select" id="armagens" multiple="multiple">
                        <option value="Unico Armazém">Unico Armazém</option>
                                        <option value="Armazém 1">Armazém 1</option>
                                        <option value="Armazém 2">Armazém 2</option>
                                        <option value="Armazém 3">Armazém 3</option>
                                        <option value="Armazém 4">Armazém 4</option>
                                        <option value="Armazém 5">Armazém 5</option>
                                        <option value="Armazém 6">Armazém 6</option>
                                        <option value="Armazém 7">Armazém 7</option>
                                        <option value="Armazém 8">Armazém 8</option>
                                        <option value="Armazém Externo 1">Armazém Externo 1</option>
                                        <option value="Armazém Externo 2">Armazém Externo 2</option>
                                        <option value="Armazém Externo 3">Armazém Externo 3</option>
                                        <option value="Armazém Externo 4">Armazém Externo 4</option>
                                        <option value="Armazém Externo 5">Armazém Externo 5</option>
                    </select>
                </div>
                
                <!-- Campos do FINALIZAR (sempre ocultos no início) -->
                <div id="mixContainer" style="display: none;">
                    <div class="mb-3">
                        <label class="form-label">Quantidade de Mix de Material</label>
                        <input type="number" class="form-control" id="mixMaterial" placeholder="Ex: 5" min="1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Toneladas Carregadas</label>
                        <input type="number" class="form-control" id="toneladas" placeholder="Ex: 10.5" step="0.1" min="0" max="9.9">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observação:</label>
                        <input type="text" class="form-control" id="Just" placeholder="Justifique">
                    </div>
                </div>
                
                <div class="d-flex justify-content-between">
                    <button id="btnConfirmar" class="btn btn-primary">Confirmar</button>
                    <button id="btnCancelar" class="btn btn-secondary">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
</div>

                 <!-- Formulário para Adicionar Funcionário a Carregamento Existente -->
                 <div class="row mt-3" id="formAddFuncionarioContainer" style="display: none;">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Adicionar Funcionário a Carregamento Existente</h5>
                <div class="mb-3">
                    <label for="addFuncionarioId" class="form-label">Código do Funcionário a Adicionar</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="addFuncionarioId" placeholder="Ex: GZL-EO-1234">
                        <button class="btn btn-outline-secondary btn-scan" type="button" data-target-input="#addFuncionarioId">
                            <i class="bi bi-camera"></i> Ler QR Code
                        </button>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="carregamentoDestino" class="form-label">Selecionar Carregamento (Doca - DT)</label>
                    <select class="form-select" id="carregamentoDestino">
                        <option value="">Selecione um carregamento em andamento</option>
                        <!-- Opções serão preenchidas via JS -->
                    </select>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="forcarRemocaoPausados">
                    <label class="form-check-label" for="forcarRemocaoPausados">Permitir remoção de carregamentos pausados</label>
                </div>
                <button id="btnConfirmarAddFuncionario" class="btn btn-primary">Adicionar Funcionário</button>
                <button id="btnCancelarAddFuncionario" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>
</div>

                <!-- Formulário para Pausar/Retomar Carregamento -->
                <div class="row mt-3" id="formPausarContainer" style="display: none;">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Pausar/Retomar Carregamento</h5>
                                <div class="mb-3">
                                    <label for="pausarFuncionarioId" class="form-label">Código do Funcionário</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="pausarFuncionarioId" placeholder="Ex: GZL-EO-1234">
                                        <button class="btn btn-outline-secondary btn-scan" type="button" data-target-input="#pausarFuncionarioId">
                                            <i class="bi bi-camera"></i> Ler QR Code
                                        </button>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="carregamentoPausar" class="form-label">Selecionar Carregamento (Doca - DT)</label>
                                    <select class="form-select" id="carregamentoPausar">
                                        <option value="">Selecione um carregamento em andamento</option>
                                        <!-- Opções serão preenchidas via JS -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="acaoPausar" class="form-label">Ação</label>
                                    <select class="form-select" id="acaoPausar">
                                        <option value="pausar_refeicao">Pausar (Refeição)</option>
                                        <option value="retomar_refeicao">Retomar (Após Refeição)</option>
                                        <option value="pausar_faturar">Pausar (Aguardando Faturar)</option>
                                        <option value="retomar_faturar">Retomar (Após Faturar)</option>
                                        <option value="pausar_treinamento">Pausar (Treinamento)</option>
                                        <option value="retomar_treinamento">Retomar (Após Treinamento)</option>
                                        <option value="pausar_sna">Pausar (SNA)</option>
                                        <option value="retomar_sna">Retomar (Após SNA)</option>
                                        <option value="pausar_prioridade">Pausar (Prioridade Operacional)</option>
                                        <option value="retomar_prioridade">Retomar (Após Prioridade)</option>
                                        <option value="pausar_limpeza">Pausar (Limpeza/Organização)</option>
                                        <option value="retomar_limpeza">Retomar (Após Limpeza)</option>
                                        <option value="pausar_ocorrencia">Pausar (Ocorrência)</option>
                                        <option value="retomar_ocorrencia">Retomar (Após Ocorrência)</option>
                                        <option value="pausar_tombamento">Pausar (Tombamento)</option>
                                        <option value="retomar_tombamento">Retomar (Após Tombamento)</option>
                                        <option value="pausar_chuva">Pausar (Chuva)</option>
                                        <option value="retomar_chuva">Retomar (Após Chuva)</option>
                                    </select>
                                </div>
                                <button id="btnConfirmarPausar" class="btn btn-primary">Confirmar</button>
                                <button id="btnCancelarPausar" class="btn btn-secondary">Cancelar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Scanner de QR Code -->
                <div class="row mt-3" id="scannerContainer" style="display: none;">
                    <div class="col-md-6 offset-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Scanner de QR Code</h5>
                                <div id="videoContainer">
                                    <video id="video" playsinline></video>
                                    <div id="scanOverlay">
                                        <div id="scanBox"></div>
                                    </div>
                                    <button id="btnCloseScanner" class="btn btn-danger btn-sm">X Fechar</button>
                                </div>
                                <div id="scanResult" class="mt-3 alert alert-info" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Carregamentos em Andamento</h5>
                                <div id="carregamentosAndamento"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ABA DE CADASTRO -->
            <div class="tab-pane fade" id="cadastro" role="tabpanel" aria-labelledby="cadastro-tab">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="novoNome" class="form-label">Nome Completo</label>
                            <input type="text" class="form-control" id="novoNome" placeholder="Ex: João da Silva">
                        </div>
                        <div class="mb-3">
                            <label for="novoCargo" class="form-label">Cargo</label>
                            <input type="text" class="form-control" id="novoCargo" placeholder="Ex: Carregador">
                        </div>
                        <button id="btnCadastrar" class="btn btn-primary">Cadastrar Funcionário</button>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Código do Funcionário</h5>
                                <div id="codigoGerado" class="codigo-funcionario mb-3" style="display: none;"></div>
                                <div id="qrCodeContainer" style="display: none;">
                                    <canvas id="qrCodeCanvas"></canvas>
                                </div>
                                <div id="infoCadastro"></div>
                                <button id="btnDownloadPDF" class="btn btn-success mt-2" style="display: none;">Download PDF</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ABA DE BUSCA -->
            <div class="tab-pane fade" id="busca" role="tabpanel" aria-labelledby="busca-tab">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="buscarFuncionario" class="form-label">Código ou Nome do Funcionário</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="buscarFuncionario" placeholder="Ex: GZL-EO-1234 ou João Silva">
                                <button class="btn btn-outline-secondary btn-scan" type="button" data-target-input="#buscarFuncionario">
                                    <i class="bi bi-camera"></i> Ler QR Code
                                </button>
                            </div>
                        </div>
                        <button id="btnBuscar" class="btn btn-info">Buscar</button>
                        <div id="infoFuncionario" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- Substitua a seção de dashboard por este código organizado -->
            <div class="tab-pane fade" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                <div class="container-fluid">
                    <!-- Cabeçalho -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h3>Dashboard Gerencial</h3>
                            <div class="alert alert-info py-2 d-flex align-items-center">
                                <i class="bi bi-building me-2"></i>
                                <div>
                                    <strong>Unidade:</strong>
                                    <span id="dashboardUnidade">—</span>
                                </div>
                                <div class="ms-3 d-flex align-items-center">
                                    <i class="bi bi-calendar me-2"></i>
                                    <span id="dashboardDataAtual"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Seção de Metas -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Definir Metas</h5>
                                    <div class="mb-3">
                                        <label for="inputMetaCaminhoesDia" class="form-label">Meta Diária de Caminhões</label>
                                        <input type="number" class="form-control" id="inputMetaCaminhoesDia">
                                    </div>
                                    <div class="mb-3">
                                        <label for="inputMetaToneladasDia" class="form-label">Meta Diária de Toneladas</label>
                                        <input type="number" step="0.1" class="form-control" id="inputMetaToneladasDia">
                                    </div>
                                    <button id="btnSalvarMetas" class="btn btn-primary">Salvar Metas</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Resumo do Dia -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <div class="row">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Linha 1 - Gráficos principais -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="card dashboard-card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">Produtividade por Hora (Hoje)</h5>
                                    <div class="chart-container">
                                        <canvas id="produtividadeHoraChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card dashboard-card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">Top 5 Carregadores (Mês)</h5>
                                    <div class="chart-container">
                                        <canvas id="topCarregadoresChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Linha 2 - Gráficos secundários -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="card dashboard-card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">Distribuição de Armagens</h5>
                                    <div class="chart-container">
                                        <canvas id="armagensChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card dashboard-card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">Distribuição de Tipos de Caminhões</h5>
                                    <div class="chart-container">
                                        <canvas id="tiposCaminhoesChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Linha 3 - Outros gráficos -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="card dashboard-card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">Distribuição de Mix de Material</h5>
                                    <div class="chart-container">
                                        <canvas id="mixMaterialChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card dashboard-card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">Colaboradores com Mais Tempo Excedido</h5>
                                    <div class="chart-container">
                                        <canvas id="pioresColaboradoresChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            

             <!-- ABA RANKING -->
             <div class="tab-pane fade" id="ranking" role="tabpanel" aria-labelledby="ranking-tab">
                 <div class="row mt-3">
                     <div class="col-12 text-center">
                         <h2>Ranking Mensal de Carregamentos</h2>
                         <p class="text-muted">Os funcionários com mais carregamentos finalizados no mês.</p>
                     </div>
                 </div>
                 <div class="row mt-4">
                     <div class="col-12">
                         <div class="card dashboard-card">
                             <div class="card-body">
                                 <h5 id="card-title-text-centerrr" class="card-title text-center">Pódio</h5>
                                 <div id="podiumContainer" class="podium-container">
                                     <!-- Pódio será preenchido via JS -->
                                 </div>
                                  <p class="text-center mt-4" id="rankingMesAno"></p>
                                  <div id="rankingLoading" class="text-center" style="display: none;">
                                      <div class="spinner-border text-primary" role="status">
                                          <span class="visually-hidden">Carregando...</span>
                                      </div>
                                  </div>
                                 <div id="rankingEmpty" class="alert alert-info text-center mt-3" style="display: none;">
                                     Sem dados suficientes para o ranking deste mês.
                                 </div>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>

            <!-- ABA DOCAS -->
            <div class="tab-pane fade" id="docas" role="tabpanel" aria-labelledby="docas-tab">
                <div class="row">
                    <div class="col-12">
                        <h3>Status das Docas</h3>
                        <p class="text-muted">Monitoramento em tempo real das docas de carregamento</p>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="card text-center summary-card">
                            <div class="card-body">
                                <h6 class="card-title">Caminhões (Dia)</h6>
                                <p class="display-5" id="resumoCaminhoesDia">0</p>
                                <p class="mb-0"><small>Meta: <span id="metaCaminhoesDia">0</span></small></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center summary-card">
                            <div class="card-body">
                                <h6 class="card-title">Toneladas (Dia)</h6>
                                <p class="display-5" id="resumoToneladasDia">0</p>
                                <p class="mb-0"><small>Meta: <span id="metaToneladasDia">0</span></small></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center summary-card">
                            <div class="card-body">
                                <h6 class="card-title">Tempo Médio (Dia)</h6>
                                <p class="display-5" id="resumoTempoMedioDia">0:00h</p>
                                <p class="mb-0"><small>Limite: 2:20h</small></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center summary-card">
                            <div class="card-body">
                                <h6 class="card-title">Mix Médio (Dia)</h6>
                                <p class="display-5" id="resumoMixMedio">0</p>
                                <p class="mb-0"><small>Por caminhão</small></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2ª Linha: Resumo do Mês -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="card text-center summary-card">
                            <div class="card-body">
                                <h6 class="card-title">Caminhões (Mês)</h6>
                                <p class="display-5" id="resumoCaminhoesMes">0</p>
                                <p class="mb-0"><small>Meta mensal: <span id="metaCaminhoesMes">0</span></small></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center summary-card">
                            <div class="card-body">
                                <h6 class="card-title">Toneladas (Mês)</h6>
                                <p class="display-5" id="resumoToneladasMes">0</p>
                                <p class="mb-0"><small>Meta mensal: <span id="metaToneladasMes">0</span></small></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center summary-card">
                            <div class="card-body">
                                <h6 class="card-title">Tempo Médio (Mês)</h6>
                                <p class="display-5" id="resumoTempoMedioMes">0:00h</p>
                                <p class="mb-0"><small>Melhor: <span id="melhorTempoMes">0:00h</span></small></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center summary-card">
                            <div class="card-body">
                                <h6 class="card-title">Mix Médio (Mês)</h6>
                                <p class="display-5" id="resumoMixMedioMes">0</p>
                                <p class="mb-0"><small>Por caminhão</small></p>
                            </div>
                        </div>
                    </div>
                </div>
            

                <div class="row mt-3" id="docasContainer">
                    <!-- As docas serão preenchidas via JavaScript -->
                </div>
            </div>

            <!-- ABA HISTÓRICO -->
            <div class="tab-pane fade" id="historico" role="tabpanel" aria-labelledby="historico-tab">
                <!-- Conteúdo do histórico (inicialmente oculto) -->
                <div id="historicoContent">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="filtroMes" class="form-label">Mês</label>
                                <select class="form-select" id="filtroMes">
                                    <option value="01">Janeiro</option>
                                    <option value="02">Fevereiro</option>
                                    <option value="03">Março</option>
                                    <option value="04">Abril</option>
                                    <option value="05">Maio</option>
                                    <option value="06">Junho</option>
                                    <option value="07">Julho</option>
                                    <option value="08">Agosto</option>
                                    <option value="09">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="filtroAno" class="form-label">Ano</label>
                                <select class="form-select" id="filtroAno">
                                    <option value="2023">2023</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="filtroFuncionario" class="form-label">Funcionário (opcional)</label>
                                <input type="text" class="form-control" id="filtroFuncionario" placeholder="Código do Funcionário">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <button id="btnFiltrar" class="btn btn-primary">Filtrar</button>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Estatísticas Gerais (Mês/Filtro)</h5>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="card bg-light mb-3">
                                                <div class="card-body">
                                                    <h6 class="card-title">Total de Caminhões</h6>
                                                    <p class="display-4 text-center" id="totalCaminhoes">0</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card bg-light mb-3">
                                                <div class="card-body">
                                                    <h6 class="card-title">Média de Tempo</h6>
                                                    <p class="display-4 text-center" id="mediaTempo">0 min</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card bg-light mb-3">
                                                <div class="card-body">
                                                    <h6 class="card-title">Valor Total Estimado</h6>
                                                    <p class="display-4 text-center" id="valorTotal">R$ 0,00</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Ranking Completo (Mês/Filtro)</h5>
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Posição</th>
                                                    <th>Funcionário</th>
                                                    <th>Carregamentos</th>
                                                    <th>Tempo Médio</th>
                                                    <th>Valor Ganho Estimado</th>
                                                </tr>
                                            </thead>
                                            <tbody id="topFuncionariosHistorico">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Histórico Completo (Mês/Filtro)</h5>
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Data</th>
                                                    <th>DT</th>
                                                    <th>Funcionário Principal</th>
                                                    <th>Início</th>
                                                    <th>Fim</th>
                                                    <th>Tempo</th>
                                                    <th>Doca</th>
                                                    <th>Armagens</th>
                                                    <th>Mix</th>
                                                    <th>Toneladas</th>
                                                    <th>Pausas</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tabelaHistorico">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                 <!-- Mensagem de acesso restrito -->
                <div id="historicoRestrito" class="alert alert-warning mt-3 text-center">
                    Acesso ao histórico restrito. Por favor, autentique-se para visualizar.
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para detalhes do funcionário -->
    <div class="modal fade" id="modalFuncionario" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalFuncionarioTitle">Detalhes do Funcionário</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalFuncionarioBody">
                    <!-- Conteúdo será preenchido via JS -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalSenhaDashboard" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Acesso ao Dashboard</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="inputSenhaDashboard" class="form-label">Digite a senha de acesso:</label>
                        <input type="password" class="form-control" id="inputSenhaDashboard" placeholder="Digite a senha">
                    </div>
                    <div id="senhaDashboardIncorreta" class="alert alert-danger d-none">Senha incorreta!</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnAcessarDashboard">Acessar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de senha para histórico -->
    <div class="modal fade" id="modalSenhaHistorico" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Acesso ao Histórico</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="inputSenhaHistorico" class="form-label">Digite a senha de acesso:</label>
                        <input type="password" class="form-control" id="inputSenhaHistorico" placeholder="Digite a senha">
                    </div>
                    <div id="senhaIncorreta" class="alert alert-danger d-none">Senha incorreta!</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnAcessarHistorico">Acessar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="text-end fixed-bottom mb-3 me-3">
        <button id="btnLogout" class="btn btn-sm btn-outline-danger">
            <i class="bi bi-box-arrow-right"></i> Sair
        </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>

    <script>

        function loadScript(src) {
        return new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = src;
            s.onload = resolve;
            s.onerror = reject;
            document.head.appendChild(s);
        });
        }
        document.getElementById('btnLogin').addEventListener('click', async () => {
        const unidade = document.getElementById('unidade').value;
        const senha = document.getElementById('senha').value;
        const erroDiv = document.getElementById('loginError');

        erroDiv.classList.add('d-none');
        if (!unidade || !senha) {
            erroDiv.textContent = 'Preencha unidade e senha.';
            erroDiv.classList.remove('d-none');
            return;
        }
        if (senha !== '123456') {
            erroDiv.textContent = 'Senha incorreta.';
            erroDiv.classList.remove('d-none');
            return;
        }

        // Define a unidade atual antes de carregar o script de configuração
        window.unidadeAtual = unidade;

        let configFile;
        if (unidade === 'cd_cariacica') {
            configFile = './js/firebase_config_cariacica.js';
        } 
        
        else if (unidade === 'fabrica_belem') {
            configFile = './js/firebase_config_belem.js';
        } 
        
        else if (unidade === 'fabrica_maracanau') {
            configFile = './js/firebase_config_maracanau.js';
        }

        else if (unidade === 'teste') {
            configFile = './js/firebase_config_teste.js';
        }

        else if (unidade === 'fabrica_Mogi_Das_Cruzes') {
            configFile = './js/firebase_config_Mogi_Das_Cruzes.js';
        }

        else if (unidade === 'fabrica_aracruz') {
            configFile = './js/firebase_config_aracruz.js';
        }

        else {
            configFile = './js/firebase_config_imperatriz.js';
        }
        

        try {
            // Carrega o config e aguarda
            await loadScript(configFile);
            
            // Inicializa o Firebase com a configuração carregada
            firebase.initializeApp(firebaseConfig);
            window.database = firebase.database();
            window.auth = firebase.auth();

            // Esconde login e mostra app
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';

            // Chama a inicialização principal
            inicializarSistema();

        } catch (err) {
            console.error(err);
            erroDiv.textContent = 'Erro ao carregar config do Firebase.';
            erroDiv.classList.remove('d-none');
        }
    });
    </script>
    

    <script>

        // Variáveis globais
        let operacaoAtual = null; // 'iniciar', 'finalizar', 'addFuncionario', 'pausar'
        let carregamentosEmAndamento = {};
        let intervalos = {};
        let scannerActive = false;
        let stream = null;
        let currentScannerInput = null;
        let historicoAutenticado = false;
        let unidadeAtual = null; // Armazena a unidade selecionada
        let metaToneladas = 0;
        let metaCaminhoes = 0;
        let toneladasHoje = 0;
        let caminhoesHoje = 0;
        let produtividadeChart = null;
        let topCarregadoresChart = null;
        let dashboardAutenticado = false;
        let forcarRemocaoPausados = false;
        

        // Valor base por colaborador por carregamento COMPLETO
        const VALOR_POR_COLABORADOR_POR_CARREGAMENTO = 2.50;
        const TEMPO_LIMITE_MINUTOS = 140; // 2 horas e 20 minutos
        const SENHA_HISTORICO = "195#%$*7advan!7";
        const SENHA_DASHBOARD = "195#%$*7advan!7"; 
        const LIMITE_MIN = TEMPO_LIMITE_MINUTOS; // Alias para compatibilidade
        const AMARELO = 40;
        const VERMELHO = 20;
        let intervaloAtualizacaoDoca;

        // Inicializa o Select2 para o campo de armagens
        $(document).ready(function() {
            $('#armagens').select2({
                theme: 'bootstrap-5',
                placeholder: 'Selecione as armagens',
                closeOnSelect: false,
                width: '100%'
            });
        });

        // Função principal de inicialização após autenticação
        function inicializarSistema() {
            // Oculta o conteúdo do histórico inicialmente e mostra a mensagem de restrição
            document.getElementById('historicoContent').style.display = 'none';
            document.getElementById('historicoRestrito').style.display = 'block';

            // Atualiza o nome da unidade no dashboard
            document.getElementById('dashboardUnidade').textContent = unidadeAtual === 'cd_cariacica' ? 'CD Cariacica' : 'Fábrica Belém';

            // Carrega as metas do dia
            carregarMetasDoDia();
            
            atualizarTemposContinuamente();
            atualizarDashboard();
            atualizarRankingDashboard();
            atualizarDashboardCompleto();
            iniciarAtualizacaoAutomatica();
            atualizarTemposContinuamente();
            iniciarAtualizacaoAutomatica();


            carregamentosRef.orderByChild('finalizado').equalTo(false).on('value', (snapshot) => {
                atualizarCarregamentosAndamento();
            });

            document.getElementById('toneladas').addEventListener('input', function(e) {            
            // Limita a uma casa decimal
            if (parts.length > 1) {
                value = parts[0] + '.' + parts[1].slice(0, 1);
            }
            
            // Limita o valor máximo
            if (parseFloat(value) > 9.9) {
                value = '9.9';
            }
            
            // Limita o valor mínimo
            if (value && parseFloat(value) < 0) {
                value = '0';
            }
            
            this.value = value;
        });

            // Configura o filtro do histórico para o mês/ano atual
            const hoje = new Date();
            const mesAtual = (hoje.getMonth() + 1).toString().padStart(2, '0');
            const anoAtual = hoje.getFullYear().toString();

            document.getElementById('filtroMes').value = mesAtual;
            document.getElementById('filtroAno').value = anoAtual;

            document.getElementById('tipoOperacao').addEventListener('change', function() {
                const tipo = this.value;
                const isCarregamento = tipo === 'carregamento';
                const isDescarregamento = tipo === 'descarregamento';
                
                // Mostra/oculta campos conforme o tipo de operação
                document.getElementById('placaContainer').style.display = (isCarregamento || isDescarregamento) ? 'block' : 'none';
                document.getElementById('tipoVeiculoContainer').style.display = isCarregamento ? 'block' : 'none';
                document.getElementById('armagensContainer').style.display = isCarregamento ? 'block' : 'none';
                
                // Adiciona campos específicos para descarregamento
                if (isDescarregamento) {
                    // Se o container de motivo de descarregamento não existir, criamos
                    if (!document.getElementById('descarregamentoContainer')) {
                        const container = document.createElement('div');
                        container.id = 'descarregamentoContainer';
                        container.innerHTML = `
                            <div class="mb-3">
                                <label class="form-label">Tipo de Descarregamento</label>
                                <select class="form-select" id="tipoDescarregamento">
                                    <option value="transferencia">Transferência</option>
                                    <option value="devolucao">Devolução</option>
                                    <option value="erro_operacional">Erro Operacional</option>
                                </select>
                            </div>
                            <div class="mb-3" id="motivoErroContainer" style="display: none;">
                                <label class="form-label">Motivo do Erro</label>
                                <select class="form-select" id="motivoErro">
                                    <option value="ordem_invertida">Ordem De Entrega Invertida</option>
                                    <option value="material_errado">Material Errado</option>
                                    <option value="quantidade_errada">Quantidade Errada</option>
                                    <option value="aguardando_complemento">Pedido Aguardando Complemento</option>
                                    <option value="placas_erradas">Placas Erradas</option>
                                    <option value="inversao_material">Inversão De Material</option>
                                    <option value="material_baguncado">Material Bagunçado</option>
                                </select>
                            </div>
                        `;
                        document.getElementById('formContainer').querySelector('.card-body').appendChild(container);
                        
                        // Adiciona evento para mostrar motivo quando for erro operacional
                        document.getElementById('tipoDescarregamento').addEventListener('change', function() {
                            document.getElementById('motivoErroContainer').style.display = 
                                this.value === 'erro_operacional' ? 'block' : 'none';
                        });
                    }
                } else {
                    // Remove o container se não for descarregamento
                    const container = document.getElementById('descarregamentoContainer');
                    if (container) {
                        container.remove();
                    }
                }
            });


            atualizarTemposContinuamente();
            // Event Listeners
            document.getElementById('btnIniciarCarregamento').addEventListener('click', function() {
                operacaoAtual = 'iniciar';
                hideAllForms();
                document.getElementById('formContainer').style.display = 'block';
                document.getElementById('formTitle').textContent = 'Iniciar Operação';
                document.getElementById('btnConfirmar').textContent = 'Iniciar';
                
                // Mostra campos conforme o tipo selecionado
                const tipo = document.getElementById('tipoOperacao').value;
                const isCarregamento = tipo === 'carregamento';

                // Campos específicos para carregamento
                document.getElementById('placaContainer').style.display = isCarregamento ? 'block' : 'none';
                document.getElementById('tipoVeiculoContainer').style.display = isCarregamento ? 'block' : 'none';
                document.getElementById('armagensContainer').style.display = isCarregamento ? 'block' : 'none';
                
                // Sempre oculta campos do finalizar
                document.getElementById('mixContainer').style.display = 'none';
                
                // Limpa os inputs
                document.querySelectorAll('#carregadoresContainer .funcionario-input').forEach(input => input.value = '');
                $('#armagens').val(null).trigger('change');
                
                // Remove carregadores adicionais, exceto o primeiro
                const carregadoresContainer = document.getElementById('carregadoresContainer');
                while (carregadoresContainer.children.length > 1) {
                    carregadoresContainer.removeChild(carregadoresContainer.lastChild);
                }
            });
            atualizarTemposContinuamente();

            document.getElementById('btnFinalizarCarregamento').addEventListener('click', function() {
                operacaoAtual = 'finalizar';
                hideAllForms();
                document.getElementById('formContainer').style.display = 'block';
                document.getElementById('formTitle').textContent = 'Finalizar Operação';
                document.getElementById('btnConfirmar').textContent = 'Finalizar';
                
                // Mostra apenas os campos do finalizar
                document.getElementById('mixContainer').style.display = 'block';
                
                // Oculta TODOS os campos específicos do início (independente do tipo de operação)
                document.getElementById('placaContainer').style.display = 'none';
                document.getElementById('tipoVeiculoContainer').style.display = 'none';
                document.getElementById('armagensContainer').style.display = 'none';
                document.getElementById('btnAddCarregador').style.display = 'none';
                document.getElementById('tipoOperacao').style.display = 'none';
                
                // Mantém visível apenas os campos comuns necessários
                document.getElementById('docaNumero').closest('.mb-3').style.display = 'none'; // Oculta doca no finalizar
                document.getElementById('tipoOperacao').closest('.mb-3').style.display = 'none'; // Mantém tipo operação visível
                
                // Limpa os inputs
                document.querySelectorAll('#carregadoresContainer .funcionario-input').forEach(input => input.value = '');
                document.getElementById('mixMaterial').value = '';
                document.getElementById('toneladas').value = '';
                document.getElementById('Just').value = '';
                
                // Remove carregadores adicionais, exceto o primeiro
                const carregadoresContainer = document.getElementById('carregadoresContainer');
                while (carregadoresContainer.children.length > 1) {
                    carregadoresContainer.removeChild(carregadoresContainer.lastChild);
                }
            });

            document.getElementById('btnPausarCarregamento').addEventListener('click', function() {
                operacaoAtual = 'pausar';
                hideAllForms();
                document.getElementById('formPausarContainer').style.display = 'block';
                preencherSelectCarregamentosPausar();
            });

            document.getElementById('btnAddFuncionarioCarregamento').addEventListener('click', function() {
                operacaoAtual = 'addFuncionario';
                hideAllForms();
                document.getElementById('formAddFuncionarioContainer').style.display = 'block';
                document.getElementById('addFuncionarioId').value = '';
                preencherSelectCarregamentos();
            });

            document.getElementById('btnConfirmar').addEventListener('click', function() {
                if (operacaoAtual === 'iniciar') {
                    iniciarCarregamento();
                } else if (operacaoAtual === 'finalizar') {
                    finalizarCarregamento();
                }
            });

            document.getElementById('btnSalvarMetas').addEventListener('click', salvarMetas);

            document.getElementById('btnCancelar').addEventListener('click', function() {
                hideAllForms();
                document.getElementById('placaCaminhao').closest('.mb-3').style.display = 'block';
                document.getElementById('docaNumero').closest('.mb-3').style.display = 'block';
                document.getElementById('btnAddCarregador').style.display = 'block';
                document.querySelectorAll('#carregadoresContainer .funcionario-input').forEach(input => input.value = '');
                const carregadoresContainer = document.getElementById('carregadoresContainer');
                while (carregadoresContainer.children.length > 1) {
                    carregadoresContainer.removeChild(carregadoresContainer.lastChild);
                }
            });

            document.getElementById('btnCancelarAddFuncionario').addEventListener('click', function() {
                hideAllForms();
            });

            document.getElementById('btnCancelarPausar').addEventListener('click', function() {
                hideAllForms();
            });

            document.getElementById('btnConfirmarPausar').addEventListener('click', pausarRetomarCarregamento);

            document.getElementById('btnConfirmarAddFuncionario').addEventListener('click', function() {
                forcarRemocaoPausados = document.getElementById('forcarRemocaoPausados').checked;
                addFuncionarioToCarregamento();
            });

            document.getElementById('btnAddCarregador').addEventListener('click', function() {
                const container = document.getElementById('carregadoresContainer');
                const newInput = document.createElement('div');
                newInput.className = 'mb-3';
                newInput.innerHTML = `
                    <label class="form-label">Código do Carregador Adicional</label>
                    <div class="input-group">
                        <input type="text" class="form-control funcionario-input" placeholder="Ex: GZL-EO-1234">
                        <button class="btn btn-outline-secondary btn-scan" type="button">
                            <i class="bi bi-camera"></i> Ler QR Code
                        </button>
                    </div>
                `;
                container.appendChild(newInput);

                newInput.querySelector('.btn-scan').addEventListener('click', function() {
                    iniciarScanner(newInput.querySelector('.funcionario-input'));
                });
            });
            atualizarTemposContinuamente();

            document.querySelectorAll('.btn-scan').forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetInputSelector = this.getAttribute('data-target-input');
                    const input = targetInputSelector ? document.querySelector(targetInputSelector) : this.closest('.input-group').querySelector('.funcionario-input');
                    if (input) {
                        iniciarScanner(input);
                    } else {
                        console.error("Input target não encontrado para o scanner.");
                    }
                });
            });

            document.getElementById('btnCloseScanner').addEventListener('click', pararScanner);

            // Cadastro de funcionário
            document.getElementById('btnCadastrar').addEventListener('click', function() {
                const nome = document.getElementById('novoNome').value.trim();
                const cargo = document.getElementById('novoCargo').value.trim();

                if (!nome || !cargo) {
                    alert('Preencha todos os campos!');
                    return;
                }

                const codigo = gerarCodigoFuncionario();
                document.getElementById('codigoGerado').textContent = codigo;
                document.getElementById('codigoGerado').style.display = 'block';

                gerarQRCode(codigo);
                document.getElementById('qrCodeContainer').style.display = 'block';

                document.getElementById('infoCadastro').innerHTML = `
                    <div class="alert alert-success mt-3">
                        <strong>Funcionário cadastrado com sucesso!</strong><br>
                        Nome: ${nome}<br>
                        Cargo: ${cargo}
                    </div>
                `;

                document.getElementById('btnDownloadPDF').style.display = 'block';

                funcionariosRef.child(codigo).set({
                    nome,
                    cargo,
                    dataCadastro: new Date().getTime(),
                    unidade: unidadeAtual // Adiciona a unidade ao cadastrar funcionário
                });
            });

            // Download PDF
            document.getElementById('btnDownloadPDF').addEventListener('click', function() {
                const codigo = document.getElementById('codigoGerado').textContent;
                const nome = document.getElementById('novoNome').value.trim();
                const cargo = document.getElementById('novoCargo').value.trim();
                gerarPDFCodigo(codigo, nome, cargo);
            });

            // Buscar funcionário
            document.getElementById('btnBuscar').addEventListener('click', function() {
                const termoBusca = document.getElementById('buscarFuncionario').value.trim();
                if (!termoBusca) {
                    alert('Informe o código ou nome do funcionário!');
                    return;
                }

                if (termoBusca.startsWith('GZL-EO')) {
                    buscarFuncionario(termoBusca, true);
                } else {
                    funcionariosRef.orderByChild('nome').once('value', (snapshot) => {
                        const funcionarios = snapshot.val() || {};
                        const resultados = Object.entries(funcionarios)
                            .filter(([id, func]) =>
                                func.nome && func.nome.toLowerCase().includes(termoBusca.toLowerCase())
                            )
                            .map(([id, func]) => ({ id, ...func }));

                        if (resultados.length === 0) {
                            alert('Nenhum funcionário encontrado com esse nome!');
                        } else if (resultados.length === 1) {
                            buscarFuncionario(resultados[0].id, true);
                        } else {
                            let html = '<div class="list-group mb-3">';
                            resultados.forEach(func => {
                                html += `
                                    <a href="#" class="list-group-item list-group-item-action"
                                    onclick="buscarFuncionario('${func.id}', true); return false;">
                                        ${func.nome} <small class="text-muted">${func.id}</small>
                                    </a>
                                `;
                            });
                            html += '</div>';
                            document.getElementById('infoFuncionario').innerHTML = html;
                        }
                    });
                }
            });

            // Acesso ao dashboard
            document.getElementById('dashboard-tab').addEventListener('click', function(e) {
                if (!dashboardAutenticado) {
                    e.preventDefault();
                    document.getElementById('inputSenhaDashboard').value = '';
                    document.getElementById('senhaDashboardIncorreta').classList.add('d-none');
                    const modal = new bootstrap.Modal(document.getElementById('modalSenhaDashboard'));
                    modal.show();
                } else {
                    // Atualiza o dashboard se já estiver autenticado
                    atualizarDashboardCompleto();
                }
            });

            // Acesso ao histórico
            document.getElementById('historico-tab').addEventListener('click', function(e) {
                if (!historicoAutenticado) {
                    e.preventDefault();
                    document.getElementById('inputSenhaHistorico').value = '';
                    document.getElementById('senhaIncorreta').classList.add('d-none');
                    const modal = new bootstrap.Modal(document.getElementById('modalSenhaHistorico'));
                    modal.show();
                } else {
                    const hoje = new Date();
                    atualizarHistorico(hoje.getMonth() + 1, hoje.getFullYear());
                }
            });

            document.getElementById('btnAcessarDashboard').addEventListener('click', function() {
            const senhaDigitada = document.getElementById('inputSenhaDashboard').value;
           if (senhaDigitada === SENHA_DASHBOARD) {
            dashboardAutenticado = true;
            verifydash(); // Aqui garante que o painel seja exibido
            // código para ativar a aba do dashboard
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalSenhaDashboard'));
            modal.hide();

            // Ativa a aba dashboard
            document.querySelectorAll('.nav-link').forEach(tab => tab.classList.remove('active'));
            document.querySelector('#dashboard-tab').classList.add('active');

            // Mostra o painel do dashboard
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('show', 'active'));
            document.getElementById('dashboard').classList.add('show', 'active');

            // Atualiza o dashboard
            atualizarDashboardCompleto();
        } else {
                document.getElementById('senhaDashboardIncorreta').classList.remove('d-none');
            }
        });

            document.getElementById('btnAcessarHistorico').addEventListener('click', verificarSenhaHistorico);

            document.getElementById('inputSenhaHistorico').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    verificarSenhaHistorico();
                }
            });

            document.getElementById('btnFiltrar').addEventListener('click', function() {
                if (historicoAutenticado) {
                    const mes = parseInt(document.getElementById('filtroMes').value);
                    const ano = parseInt(document.getElementById('filtroAno').value);
                    const funcionarioId = document.getElementById('filtroFuncionario').value.trim() || null;
                    carregamentosRef.off('value', null, null);
                    atualizarHistorico(mes, ano, funcionarioId);
                }
            });

            document.getElementById('ranking-tab').addEventListener('click', function() {
                atualizarRankingDashboard();
            });

            // Event listeners para o dashboard completo
            document.getElementById('btnSalvarMetaToneladas').addEventListener('click', salvarMetaToneladas);
            document.getElementById('btnSalvarMetaCaminhoes').addEventListener('click', salvarMetaCaminhoes);
            document.getElementById('dashboard2-tab').addEventListener('click', atualizarDashboardCompleto);
        }

        document.getElementById('inputSenhaDashboard').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('btnAcessarDashboard').click();
            }
        });

        document.getElementById('inputSenhaHistorico').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('btnAcessarHistorico').click();
            }
        });

        // Função para carregar as metas do dia
function carregarMetasDoDia() {
    const hoje = new Date().toISOString().split('T')[0]; // Formato YYYY-MM-DD
    
    metasRef.child(unidadeAtual).child(hoje).once('value', (snapshot) => {
        const metas = snapshot.val() || {};
        
        // Preenche os campos de input
        if (metas.caminhoes) {
            document.getElementById('inputMetaCaminhoesDia').value = metas.caminhoes;
            document.getElementById('metaCaminhoesDia').textContent = metas.caminhoes;
        }
        
        if (metas.toneladas) {
            document.getElementById('inputMetaToneladasDia').value = metas.toneladas;
            document.getElementById('metaToneladasDia').textContent = metas.toneladas;
        }
    });
}


// Função para salvar as metas
function salvarMetas() {
    const metaCaminhoes = parseInt(document.getElementById('inputMetaCaminhoesDia').value);
    const metaToneladas = parseFloat(document.getElementById('inputMetaToneladasDia').value);
    
    if (isNaN(metaCaminhoes) || isNaN(metaToneladas)) {
        alert('Digite valores válidos para as metas!');
        return;
    }
    
    const hoje = new Date().toISOString().split('T')[0];
    
    metasRef.child(unidadeAtual).child(hoje).set({
        caminhoes: metaCaminhoes,
        toneladas: metaToneladas
    }).then(() => {
        alert('Metas salvas com sucesso!');
        // Atualiza os valores exibidos
        document.getElementById('metaCaminhoesDia').textContent = metaCaminhoes;
        document.getElementById('metaToneladasDia').textContent = metaToneladas;
    }).catch(error => {
        console.error('Erro ao salvar metas:', error);
        alert('Erro ao salvar metas.');
    });
}

function verifydash(){
    if (dashboardAutenticado) {
        document.getElementById('dashboard').style.display = 'block';
        return true;
    } else {
        document.getElementById('dashboard').style.display = 'none';
        return false;
    }
}




        // Função para salvar a meta de toneladas
        function salvarMetaToneladas() {
            const valor = parseInt(document.getElementById('inputMetaToneladas').value);
            if (isNaN(valor)) {
                alert('Digite um valor válido para a meta de toneladas!');
                return;
            }
            
            const hoje = new Date().toISOString().split('T')[0];
            metasRef.child(unidadeAtual).child(hoje).update({
                toneladas: valor
            }).then(() => {
                metaToneladas = valor;
                document.getElementById('metaToneladas').textContent = valor;
                atualizarTermometros();
                alert('Meta de toneladas salva com sucesso!');
            }).catch(error => {
                console.error('Erro ao salvar meta de toneladas:', error);
                alert('Erro ao salvar meta de toneladas.');
            });
        }
        

        // Função para salvar a meta de caminhões
        function salvarMetaCaminhoes() {
            const valor = parseInt(document.getElementById('inputMetaCaminhoes').value);
            if (isNaN(valor)) {
                alert('Digite um valor válido para a meta de caminhões!');
                return;
            }
            
            const hoje = new Date().toISOString().split('T')[0];
            metasRef.child(unidadeAtual).child(hoje).update({
                caminhoes: valor
            }).then(() => {
                metaCaminhoes = valor;
                document.getElementById('metaCaminhoes').textContent = valor;
                atualizarTermometros();
                alert('Meta de caminhões salva com sucesso!');
            }).catch(error => {
                console.error('Erro ao salvar meta de caminhões:', error);
                alert('Erro ao salvar meta de caminhões.');
            });
        }

        function atualizarGraficoTiposCaminhoes(carregamentos) {
    const tiposStats = {};
    
    Object.values(carregamentos).forEach(c => {
        if (c.finalizado && c.unidade === unidadeAtual && c.tipoVeiculo) {
            tiposStats[c.tipoVeiculo] = (tiposStats[c.tipoVeiculo] || 0) + 1;
        }
    });
    
    const tiposOrdenados = Object.entries(tiposStats)
        .sort((a, b) => b[1] - a[1]);
    
    const cores = [
        'rgba(255, 99, 132, 0.7)',
        'rgba(54, 162, 235, 0.7)',
        'rgba(255, 206, 86, 0.7)',
        'rgba(75, 192, 192, 0.7)',
        'rgba(153, 102, 255, 0.7)'
    ];
    
    if (window.tiposCaminhoesChart) {
        window.tiposCaminhoesChart.data.labels = tiposOrdenados.map(t => t[0]);
        window.tiposCaminhoesChart.data.datasets[0].data = tiposOrdenados.map(t => t[1]);
        window.tiposCaminhoesChart.data.datasets[0].backgroundColor = cores.slice(0, tiposOrdenados.length);
        window.tiposCaminhoesChart.update();
    }
}

function atualizarGraficoMixMaterial(carregamentos) {
    const mixStats = {};
    
    Object.values(carregamentos).forEach(c => {
        if (c.finalizado && c.unidade === unidadeAtual && c.mixMaterial) {
            const mix = parseInt(c.mixMaterial);
            const categoria = mix <= 5 ? `${mix} mix` : '5+ mix';
            mixStats[categoria] = (mixStats[categoria] || 0) + 1;
        }
    });
    
    const mixOrdenado = Object.entries(mixStats)
        .sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
    
    if (window.mixMaterialChart) {
        window.mixMaterialChart.data.labels = mixOrdenado.map(m => m[0]);
        window.mixMaterialChart.data.datasets[0].data = mixOrdenado.map(m => m[1]);
        window.mixMaterialChart.update();
    }
}

function atualizarGraficoPioresColaboradores(carregamentos) {
    const colaboradoresStats = {};
    
    Object.values(carregamentos).forEach(c => {
        if (c.finalizado && c.unidade === unidadeAtual && c.participantes) {
            const tempoTotal = (c.fim - c.inicio) / 60000; // minutos
            const tempoLimite = TEMPO_LIMITE_MINUTOS;
            
            Object.entries(c.participantes).forEach(([id, p]) => {
                if (!colaboradoresStats[id]) {
                    colaboradoresStats[id] = {
                        nome: p.nome || id,
                        tempoExcedido: 0,
                        count: 0
                    };
                }
                
                const tempoParticipacao = ((p.saida || c.fim) - p.entrada) / 60000;
                const proporcao = tempoParticipacao / tempoTotal;
                const tempoExcedido = Math.max(0, tempoTotal - tempoLimite) * proporcao;
                
                colaboradoresStats[id].tempoExcedido += tempoExcedido;
                colaboradoresStats[id].count++;
            });
        }
    });
    
    const pioresColaboradores = Object.entries(colaboradoresStats)
        .filter(([_, stats]) => stats.tempoExcedido > 0)
        .map(([id, stats]) => ({ 
            id, 
            nome: stats.nome, 
            tempoExcedido: stats.tempoExcedido / stats.count 
        }))
        .sort((a, b) => b.tempoExcedido - a.tempoExcedido)
        .slice(0, 5);
    
    if (window.pioresColaboradoresChart) {
        window.pioresColaboradoresChart.data.labels = pioresColaboradores.map(c => c.nome);
        window.pioresColaboradoresChart.data.datasets[0].data = pioresColaboradores.map(c => c.tempoExcedido.toFixed(1));
        window.pioresColaboradoresChart.update();
    }
}

        // Função para atualizar os termômetros
        function atualizarTermometros() {
            // Atualiza o termômetro de toneladas
            const porcentagemToneladas = metaToneladas > 0 ? Math.min(100, (toneladasHoje / metaToneladas) * 100) : 0;
            const mercuryToneladas = document.getElementById('toneladasMercury');
            mercuryToneladas.style.height = `${porcentagemToneladas}%`;
            mercuryToneladas.style.backgroundColor = porcentagemToneladas >= 100 ? '#4CAF50' : 
                                                     porcentagemToneladas >= 75 ? '#8BC34A' : 
                                                     porcentagemToneladas >= 50 ? '#FFEB3B' : 
                                                     porcentagemToneladas >= 25 ? '#FF9800' : '#F44336';
            document.getElementById('toneladasValue').textContent = `${toneladasHoje} ton`;
            
            // Atualiza o termômetro de caminhões
            const porcentagemCaminhoes = metaCaminhoes > 0 ? Math.min(100, (caminhoesHoje / metaCaminhoes) * 100) : 0;
            const mercuryCaminhoes = document.getElementById('caminhoesMercury');
            mercuryCaminhoes.style.height = `${porcentagemCaminhoes}%`;
            mercuryCaminhoes.style.backgroundColor = porcentagemCaminhoes >= 100 ? '#4CAF50' : 
                                                     porcentagemCaminhoes >= 75 ? '#8BC34A' : 
                                                     porcentagemCaminhoes >= 50 ? '#FFEB3B' : 
                                                     porcentagemCaminhoes >= 25 ? '#FF9800' : '#F44336';
            document.getElementById('caminhoesValue').textContent = `${caminhoesHoje} caminhões`;
        }

        // Função para atualizar o dashboard completo
        function atualizarDashboardCompleto() {
    const hoje = new Date();
    const inicioDia = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate()).getTime();
    const fimDia = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate(), 23, 59, 59).getTime();
    
    // Data atual formatada
    document.getElementById('dashboardDataAtual').textContent = hoje.toLocaleDateString('pt-BR', { 
        weekday: 'long', 
        day: 'numeric', 
        month: 'long', 
        year: 'numeric' 
    });
    
    // Nome da unidade
    document.getElementById('dashboardUnidade').textContent = unidadeAtual === 'cd_cariacica' ? 'CD Cariacica' : 'Fábrica Belém';
    
    // Carrega metas
    carregarMetasDoDia();
    
    // Carrega dados do dia
    carregamentosRef
        .orderByChild('fim')
        .startAt(inicioDia)
        .endAt(fimDia)
        .once('value', snapshotDia => {
            const dataDia = snapshotDia.val() || {};
            calcularResumoDia(dataDia);
            atualizarGraficoProdutividadeHora(dataDia);
        });
    
    // Carrega dados do mês
    const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1).getTime();
    const fimMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0, 23, 59, 59).getTime();
    
    carregamentosRef
        .orderByChild('fim')
        .startAt(inicioMes)
        .endAt(fimMes)
        .once('value', snapshotMes => {
            const dataMes = snapshotMes.val() || {};
            calcularResumoMes(dataMes);
            atualizarGraficoTopCarregadores(dataMes);
            atualizarGraficoArmagens(dataMes);
            atualizarGraficoTiposCaminhoes(dataMes);
            atualizarGraficoMixMaterial(dataMes);
            atualizarGraficoPioresColaboradores(dataMes);
        });
    
    // Atualiza status das docas
    atualizarStatusDocas();
    
    // Atualiza carregamentos em andamento
    atualizarCarregamentosAndamento();
}

function calcularResumoDia(carregamentos) {
    let totalCam = 0;
    let totalTon = 0;
    let somaTempo = 0;
    let somaMix = 0;
    
    Object.values(carregamentos).forEach(c => {
        if (c.finalizado && c.unidade === unidadeAtual) {
            totalCam++;
            totalTon += parseFloat(c.toneladas || 0);
            somaTempo += (c.fim - c.inicio) / 60000; // minutos
            somaMix += parseInt(c.mixMaterial || 0);
        }
    });
    
    // Atualiza resumo do dia
    document.getElementById('resumoCaminhoesDia').textContent = totalCam;
    document.getElementById('resumoToneladasDia').textContent = totalTon.toFixed(1);
    
    const mediaTempo = totalCam > 0 ? (somaTempo / totalCam).toFixed(0) : 0;
    document.getElementById('resumoTempoMedioDia').textContent = formatarMinutosParaHoraMinuto(mediaTempo);
    
    const mediaMix = totalCam > 0 ? (somaMix / totalCam).toFixed(1) : 0;
    document.getElementById('resumoMixMedio').textContent = mediaMix;
    
    // Atualiza termômetros ou barras de progresso
    atualizarBarrasProgresso(totalCam, totalTon);
}

function calcularResumoMes(carregamentos) {
    let totalCam = 0;
    let totalTon = 0;
    let somaTempo = 0;
    let somaMix = 0;
    let melhorTempo = Infinity;

    const agora = new Date();
    const mesAtual = agora.getMonth(); // 0 = janeiro, 11 = dezembro
    const anoAtual = agora.getFullYear();

    Object.values(carregamentos).forEach(c => {
        if (c.finalizado && c.unidade === unidadeAtual) {
            const dataInicio = new Date(c.inicio);

            if (dataInicio.getMonth() === mesAtual && dataInicio.getFullYear() === anoAtual) {
                totalCam++;
                totalTon += parseFloat(c.toneladas || 0);
                somaMix += parseInt(c.mixMaterial || 0);
                
                // Calcula tempo do carregamento
                const tempo = (c.fim - c.inicio) / 60000; // em minutos
                somaTempo += tempo;
                if (tempo < melhorTempo) melhorTempo = tempo;
            }
        }
    });

    const mediaMix = totalCam > 0 ? (somaMix / totalCam).toFixed(1) : 0;
    const mediaTempo = totalCam > 0 ? (somaTempo / totalCam).toFixed(0) : 0;
    
    // Atualiza todos os elementos do resumo
    document.getElementById('resumoMixMedioMes').textContent = mediaMix;
    document.getElementById('resumoCaminhoesMes').textContent = totalCam;
    document.getElementById('resumoToneladasMes').textContent = totalTon.toFixed(1);
    document.getElementById('resumoTempoMedioMes').textContent = formatarMinutosParaHoraMinuto(mediaTempo);
    document.getElementById('melhorTempoMes').textContent = melhorTempo !== Infinity ? 
        formatarMinutosParaHoraMinuto(melhorTempo) : 'N/A';
}

// Função auxiliar para formatar minutos no formato HH:MM
function formatarMinutosParaHoraMinuto(minutos) {
    const horas = Math.floor(minutos / 60);
    const min = minutos % 60;
    return `${horas}:${min.toString().padStart(2, '0')}h`;
}




function atualizarStatusDocas() {
    docasRef.once('value', snapshot => {
        const docas = snapshot.val() || {};
        let ocupadas = 0;
        let html = '';
        
        for (let i = 1; i <= 11; i++) {
            const doca = docas[i] || { ocupada: false };
            if (doca.ocupada) ocupadas++;
            
            const tempo = doca.inicio ? Math.floor((Date.now() - doca.inicio) / 60000) : 0;
            const restante = Math.max(0, 140 - tempo);
            
            html += `
                <div class="doca-status ${doca.ocupada ? 'ocupada' : 'livre'}">
                    <div class="doca-numero">Doca ${i}</div>
                    <div class="doca-info">
                        ${doca.ocupada ? 
                            `DT: ${doca.placa || 'N/A'}<br>
                             Tempo: ${tempo} min (${restante} min restantes)` : 
                            'Livre'}
                    </div>
                </div>
            `;
        }
        
        document.getElementById('resumoDocasOcupadas').textContent = `${ocupadas}/11`;
        document.getElementById('eficienciaDocas').textContent = `${Math.round((ocupadas / 11) * 100)}%`;
        document.getElementById('docasStatusGrid').innerHTML = html;
    });
}

function atualizarGraficoProdutividadeHora(carregamentos) {
    const horas = Array.from({length: 24}, (_, i) => i);
    const dadosPorHora = Array(24).fill(0);
    
    Object.values(carregamentos).forEach(c => {
        if (c.finalizado && c.unidade === unidadeAtual && c.fim) {
            const hora = new Date(c.fim).getHours();
            if (hora >= 0 && hora < 24) {
                dadosPorHora[hora]++;
            }
        }
    });
    
    const ctx = document.getElementById('produtividadeHoraChart').getContext('2d');
    
    if (window.produtividadeHoraChart) {
        window.produtividadeHoraChart.destroy();
    }
    
    window.produtividadeHoraChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: horas.map(h => `${h}h`),
            datasets: [{
                label: 'Caminhões Carregados',
                data: dadosPorHora,
                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Quantidade'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Hora do Dia'
                    }
                }
            }
        }
    });
}

function atualizarGraficoTopCarregadores(carregamentos) {
    const funcionariosStats = {};
    
    Object.values(carregamentos).forEach(c => {
        if (c.finalizado && c.unidade === unidadeAtual && c.participantes) {
            Object.entries(c.participantes).forEach(([id, p]) => {
                if (!funcionariosStats[id]) {
                    funcionariosStats[id] = {
                        count: 0,
                        nome: p.nome || id
                    };
                }
                funcionariosStats[id].count++;
            });
        }
    });
    
    const topCarregadores = Object.entries(funcionariosStats)
        .map(([id, stats]) => ({ id, nome: stats.nome, count: stats.count }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 5);
    
    const ctx = document.getElementById('topCarregadoresChart').getContext('2d');
    
    if (window.topCarregadoresChart) {
        window.topCarregadoresChart.destroy();
    }
    
    window.topCarregadoresChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: topCarregadores.map(f => f.nome),
            datasets: [{
                label: 'Carregamentos Participados',
                data: topCarregadores.map(f => f.count),
                backgroundColor: 'rgba(75, 192, 192, 0.7)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Quantidade'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Funcionário'
                    }
                }
            }
        }
    });
}

function atualizarGraficoArmagens(carregamentos) {
    const armagensStats = {};
    
    Object.values(carregamentos).forEach(c => {
        if (c.finalizado && c.unidade === unidadeAtual && c.armagens) {
            c.armagens.forEach(armagem => {
                armagensStats[armagem] = (armagensStats[armagem] || 0) + 1;
            });
        }
    });
    
    const armagensOrdenadas = Object.entries(armagensStats)
        .sort((a, b) => b[1] - a[1]);
    
    const ctx = document.getElementById('armagensChart').getContext('2d');
    
    if (window.armagensChart) {
        window.armagensChart.destroy();
    }
    
    window.armagensChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: armagensOrdenadas.map(a => a[0]),
            datasets: [{
                data: armagensOrdenadas.map(a => a[1]),
                backgroundColor: [
                    'rgba(255, 99, 132, 0.7)',
                    'rgba(54, 162, 235, 0.7)',
                    'rgba(255, 206, 86, 0.7)',
                    'rgba(75, 192, 192, 0.7)',
                    'rgba(153, 102, 255, 0.7)',
                    'rgba(255, 159, 64, 0.7)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                },
                title: {
                    display: true,
                    text: 'Uso de Armagens'
                }
            }
        }
    });
}

function atualizarCarregamentosAndamento() {
    carregamentosRef.orderByChild('finalizado').equalTo(false).once('value', (snapshot) => {
        const carregamentos = snapshot.val() || {};
        let operacaoHtml = '';
        
        Object.entries(carregamentos).forEach(([key, carregamento]) => {
            if (carregamento.unidade === unidadeAtual) {
                const { tempoDecorrido, tempoPausado, tempoEfetivo } = calcularTempos(carregamento);
                const tempoClass = getClassTempo(tempoEfetivo);
                const tempoRestanteTexto = getTextoRestante(tempoEfetivo);
                
                const participantesHtml = gerarHtmlParticipantes(carregamento, key);
                
                let pausaBadge = '';
                if (carregamento.pausado && carregamento.pausas && carregamento.pausas.length > 0) {
                    const ultimaPausa = [...carregamento.pausas]
                        .reverse()
                        .find(p => !p.fim);
                    
                    if (ultimaPausa) {
                        motivoPausa = ultimaPausa.motivo || 'Não especificado';
                        pausaBadge = `<span class="badge paused-badge">PAUSADO (Motivo: ${motivoPausa})</span>`;
                    }
                }
                
                // Determina o título com base no tipo de operação
                let titulo = '';
                if (carregamento.tipoOperacao === 'carregamento') {
                    titulo = `Carregamento: ${carregamento.placa || 'N/A'}`;
                } else if (carregamento.tipoOperacao === 'separacao') {
                    titulo = `Separação`;
                } else if (carregamento.tipoOperacao === 'descarregamento') {
                    titulo = `Descarregamento: ${carregamento.placa || 'N/A'}`;
                    if (carregamento.tipoDescarregamento === 'erro_operacional') {
                        titulo += ` (Erro: ${carregamento.motivoErro || 'N/A'})`;
                    } else {
                        titulo += ` (Transferência)`;
                    }
                }
                
                operacaoHtml += `
                    <div class="card card-carregamento em-andamento mb-2 carregamento-${key} ${carregamento.pausado ? 'paused' : ''}">
                        <div class="card-body">
                            <h6 class="card-title">${titulo} ${pausaBadge}</h6>
                            <p class="card-text">Doca: ${carregamento.doca || 'N/A'}</p>
                            ${participantesHtml}
                            <p class="card-text tempo-decorrido ${tempoClass}">
                               Tempo: ${Math.floor(tempoEfetivo)} minutos (${tempoDecorrido} min total)<br>
                               ${carregamento.tipoOperacao !== 'separacao' ? `Tempo Restante (2:20h): ${tempoRestanteTexto}` : ''}
                            </p>
                            <p class="card-text mb-0"><small>Início: ${new Date(carregamento.inicio).toLocaleTimeString()}</small></p>
                            ${carregamento.armagens && carregamento.armagens.length > 0 ? 
                              `<p class="card-text mb-0"><small>Armagens: ${carregamento.armagens.join(', ')}</small></p>` : ''}
                        </div>
                    </div>
                `;
            }
        });

        document.getElementById('carregamentosAndamento').innerHTML = operacaoHtml || 
            '<div class="alert alert-info">Nenhum carregamento ou separação em andamento no momento</div>';
        configurarBotoesRemoverFuncionario();
    });
}

function calcularTempos(carregamento) {
    try {
        const agora = new Date().getTime();
        const inicio = carregamento.inicio || agora;
        const tempoDecorrido = Math.floor((agora - inicio) / 60000);
        
        // Calcula tempo pausado (em minutos)
        let tempoPausado = 0;
        if (carregamento.pausas && Array.isArray(carregamento.pausas)) {
            tempoPausado = carregamento.pausas.reduce((total, pausa) => {
                const inicioPausa = pausa.inicio || agora;
                const fimPausa = pausa.fim || (carregamento.pausado ? agora : inicioPausa);
                return total + (fimPausa - inicioPausa);
            }, 0) / 60000;
        }
        
        // Tempo efetivo é o tempo decorrido menos as pausas
        const tempoEfetivo = Math.max(0, Math.floor(tempoDecorrido - tempoPausado));
        
        return { 
            tempoDecorrido, 
            tempoPausado: Math.floor(tempoPausado), 
            tempoEfetivo 
        };
    } catch (error) {
        console.error("Erro ao calcular tempos:", error);
        return {
            tempoDecorrido: 0,
            tempoPausado: 0,
            tempoEfetivo: 0
        };
    }
}

function formatarMinutosParaHoraMinuto(minutos) {
    const horas = Math.floor(minutos / 60);
    const min = minutos % 60;
    return `${horas}:${min.toString().padStart(2, '0')}h`;
}

function carregarMetasDoDia() {
    const hoje = new Date().toISOString().split('T')[0];
    
    metasRef.child(unidadeAtual).child(hoje).once('value', snapshot => {
        const metas = snapshot.val() || {};
        
        if (metas.toneladas) {
            document.getElementById('metaToneladasDia').textContent = metas.toneladas;
            document.getElementById('metaToneladasMes').textContent = (metas.toneladas * 30).toLocaleString();
        }
        
        if (metas.caminhoes) {
            document.getElementById('metaCaminhoesDia').textContent = metas.caminhoes;
            document.getElementById('metaCaminhoesMes').textContent = (metas.caminhoes * 30).toLocaleString();
        }
    });
}

function atualizarBarrasProgresso(totalCam, totalTon) {
    const metaCam = parseInt(document.getElementById('metaCaminhoesDia').textContent) || 1;
    const metaTon = parseInt(document.getElementById('metaToneladasDia').textContent) || 1;
    
    const pctCam = Math.min(100, (totalCam / metaCam) * 100);
    const pctTon = Math.min(100, (totalTon / metaTon) * 100);
    
    // Você pode adicionar barras de progresso visuais aqui se desejar
}

// Chame esta função quando a aba dashboard for mostrada
document.getElementById('dashboard-tab').addEventListener('shown.bs.tab', function() {
    atualizarDashboardCompleto();

     if (!window.tiposCaminhoesChart) {
        const ctxTipos = document.getElementById('tiposCaminhoesChart').getContext('2d');
        window.tiposCaminhoesChart = new Chart(ctxTipos, {
            type: 'pie',
            data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
            options: { responsive: true }
        });
    }
    
    if (!window.mixMaterialChart) {
        const ctxMix = document.getElementById('mixMaterialChart').getContext('2d');
        window.mixMaterialChart = new Chart(ctxMix, {
            type: 'bar',
            data: { labels: [], datasets: [{ data: [], backgroundColor: 'rgba(75, 192, 192, 0.7)' }] },
            options: { responsive: true }
        });
    }
    
    if (!window.pioresColaboradoresChart) {
        const ctxPiores = document.getElementById('pioresColaboradoresChart').getContext('2d');
        window.pioresColaboradoresChart = new Chart(ctxPiores, {
            type: 'bar',
            data: { labels: [], datasets: [{ data: [], backgroundColor: 'rgba(255, 99, 132, 0.7)' }] },
            options: { responsive: true }
        });
    }
});

// Inicialize os gráficos quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
    // Configuração inicial dos gráficos (serão atualizados com dados reais depois)
    window.produtividadeHoraChart = null;
    window.topCarregadoresChart = null;
    window.armagensChart = null;
});

// chamar ao abrir a aba
document.getElementById('dashboard2-tab')
  .addEventListener('shown.bs.tab', () => {
    document.getElementById('dashboardUnidade').textContent =
      unidadeAtual==='cd_cariacica'?'CD Cariacica':'Fábrica Belém';
    atualizarDashboardCompleto();
  });

        // Função para atualizar o gráfico de produtividade por hora
        function atualizarGraficoProdutividade(carregamentos) {
            const horas = Array.from({length: 24}, (_, i) => i);
            const dadosPorHora = Array(24).fill(0);
            
            Object.values(carregamentos).forEach(c => {
                if (c.finalizado && c.unidade === unidadeAtual && c.fim) {
                    const hora = new Date(c.fim).getHours();
                    if (hora >= 0 && hora < 24) {
                        dadosPorHora[hora]++;
                    }
                }
            });
            
            const ctx = document.getElementById('produtividadeChart').getContext('2d');
            
            if (produtividadeChart) {
                produtividadeChart.destroy();
            }
            
            produtividadeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: horas.map(h => `${h}h`),
                    datasets: [{
                        label: 'Caminhões Carregados por Hora',
                        data: dadosPorHora,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Hora do Dia'
                            }
                        }
                    }
                }
            });
        }

        // Função para atualizar o gráfico de top carregadores
        function atualizarGraficoTopCarregadores(carregamentos) {
            const funcionariosStats = {};
            
            Object.values(carregamentos).forEach(c => {
                if (c.finalizado && c.unidade === unidadeAtual && c.participantes) {
                    Object.entries(c.participantes).forEach(([id, p]) => {
                        if (!funcionariosStats[id]) {
                            funcionariosStats[id] = {
                                count: 0,
                                nome: p.nome || id
                            };
                        }
                        funcionariosStats[id].count++;
                    });
                }
            });
            
            const topCarregadores = Object.entries(funcionariosStats)
                .map(([id, stats]) => ({ id, nome: stats.nome, count: stats.count }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 5);
            
            const ctx = document.getElementById('topCarregadoresChart').getContext('2d');
            
            if (topCarregadoresChart) {
                topCarregadoresChart.destroy();
            }
            
            topCarregadoresChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topCarregadores.map(f => f.nome),
                    datasets: [{
                        label: 'Carregamentos Participados',
                        data: topCarregadores.map(f => f.count),
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Funcionário'
                            }
                        }
                    }
                }
            });
        }

        // Função para esconder todos os formulários de operação
        function hideAllForms() {
            document.getElementById('formContainer').style.display = 'none';
            document.getElementById('formAddFuncionarioContainer').style.display = 'none';
            document.getElementById('formPausarContainer').style.display = 'none';
        }

        // Gera um código único para o funcionário com prefixo da unidade
        function gerarCodigoFuncionario() {
            const prefixo = `${unidadeAtual}-EO-`;
            const randomPart = Math.floor(10000 + Math.random() * 90000);
            return prefixo + randomPart;
        }

        // Gera QR Code para o funcionário
        function gerarQRCode(codigo, canvasId = 'qrCodeCanvas') {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            QRCode.toCanvas(canvas, codigo, { width: 200 }, (error) => {
                if (error) console.error('Erro ao gerar QR code:', error);
            });
        }

        // Gera PDF com o código do funcionário
        function gerarPDFCodigo(codigo, nome, cargo) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(20);
            doc.setTextColor(40);
            doc.setFont("helvetica", "bold");
            doc.text('Código do Funcionário', 105, 20, { align: 'center' });

            doc.setFontSize(14);
            doc.setFont("helvetica", "normal");
            doc.text('Nome:', 20, 40);
            doc.text(nome, 50, 40);

            doc.text('Cargo:', 20, 50);
            doc.text(cargo, 50, 50);

            doc.text('Código:', 20, 70);
            doc.setFontSize(24);
            doc.setFont("helvetica", "bold");
            doc.text(codigo, 50, 70);

            const canvas = document.getElementById('qrCodeCanvas');
            if (canvas) {
                const imgData = canvas.toDataURL('image/png');
                doc.addImage(imgData, 'PNG', 140, 40, 50, 50);
            }

            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            const hoje = new Date();
            doc.text(`Emitido em: ${hoje.toLocaleDateString()}`, 20, 130);
            doc.text(`Unidade: ${unidadeAtual}`, 20, 140);

            doc.save(`codigo-funcionario-${codigo}.pdf`);
        }

        // Inicia o scanner de QR code
        function iniciarScanner(inputElement) {
            currentScannerInput = inputElement;
            const video = document.getElementById('video');
            const scanResult = document.getElementById('scanResult');

            document.getElementById('scannerContainer').style.display = 'block';
            scannerActive = true;
            scanResult.style.display = 'none';

            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(function(s) {
                    stream = s;
                    video.srcObject = stream;
                    video.play();
                    requestAnimationFrame(tick);
                })
                .catch(function(err) {
                    console.error("Erro ao acessar a câmera:", err);
                    alert("Não foi possível acessar a câmera. Verifique as permissões.");
                    pararScanner();
                });
        }

        // Para o scanner de QR code
        function pararScanner() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            scannerActive = false;
            document.getElementById('scannerContainer').style.display = 'none';
            currentScannerInput = null;
        }

        // Processa o vídeo para detectar QR codes
        function tick() {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            const scanResult = document.getElementById('scanResult');

            if (!scannerActive || !video || video.readyState !== video.HAVE_ENOUGH_DATA) {
                if(scannerActive) requestAnimationFrame(tick);
                return;
            }

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });

            if (code) {
                scanResult.textContent = `Código detectado: ${code.data}`;
                scanResult.style.display = 'block';

                if (currentScannerInput) {
                    currentScannerInput.value = code.data;
                }

                setTimeout(pararScanner, 1000);
                return;
            }

            if (scannerActive) {
                requestAnimationFrame(tick);
            }
        }

        function atualizarResumoDocas() {
    // calcula início/fim de hoje
    const hoje = new Date();
    const inicioDia = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate()).getTime();
    const fimDia    = hoje.setHours(23,59,59,999);
    
    // calcula início/fim do mês
    const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1).getTime();
    const fimMes    = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0, 23, 59, 59).getTime();

    let totalTon = 0;
    let totalCam = 0;
    let somaTempoDia = 0;
    let somaTempoMes = 0;
    let countCarMes = 0;

    carregamentosRef
        .orderByChild('fim')
        .startAt(inicioDia)
        .endAt(fimDia)
        .once('value', snapshotDia => {
            const dataDia = snapshotDia.val() || {};
            Object.values(dataDia).forEach(c => {
                if (c.finalizado && c.unidade === unidadeAtual) {
                    totalCam++;
                    totalTon += parseFloat(c.toneladas || 0);
                    somaTempoDia += (c.fim - c.inicio) / 60000; // minutos
                }
            });

            // Atualiza dados do dia
            document.getElementById('resumoToneladas').textContent = totalTon.toFixed(1);
            document.getElementById('resumoCaminhoes').textContent = totalCam;
            const mediaTempoDia = totalCam > 0 ? (somaTempoDia / totalCam).toFixed(0) : 0;
            document.getElementById('resumoTempoMedioDia').textContent = `${mediaTempoDia} min`;
            
            // Busca dados do mês
            carregamentosRef
                .orderByChild('fim')
                .startAt(inicioMes)
                .endAt(fimMes)
                .once('value', snapshotMes => {
                    const dataMes = snapshotMes.val() || {};
                    Object.values(dataMes).forEach(c => {
                        if (c.finalizado && c.unidade === unidadeAtual) {
                            countCarMes++;
                            somaTempoMes += (c.fim - c.inicio) / 60000; // minutos
                        }
                    });
                    
                    // Atualiza dados do mês
                    const mediaTempoMes = countCarMes > 0 ? (somaTempoMes / countCarMes).toFixed(0) : 0;
                    document.getElementById('resumoTempoMedioMes').textContent = `${mediaTempoMes} min`;
                });
        });
}

        // Verifica a senha do histórico
        function verificarSenhaHistorico() {
            if (typeof SENHA_HISTORICO === SENHA_HISTORICO) {
                alert("Erro: Senha do histórico não configurada. Crie o arquivo key.js.");
                return;
            }

            const senhaDigitada = document.getElementById('inputSenhaHistorico').value;
            if (senhaDigitada === SENHA_HISTORICO) {
                historicoAutenticado = true;
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalSenhaHistorico'));
                modal.hide();

                document.getElementById('historicoContent').style.display = 'block';
                document.getElementById('historicoRestrito').style.display = 'none';

                const historicoTab = document.getElementById('historico-tab');
                const historicoPane = document.getElementById('historico');

                document.querySelectorAll('.nav-link').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.remove('show', 'active');
                });

                historicoTab.classList.add('active');
                historicoPane.classList.add('show', 'active');

                const hoje = new Date();
                atualizarHistorico(hoje.getMonth() + 1, hoje.getFullYear());
            } else {
                document.getElementById('senhaIncorreta').classList.remove('d-none');
            }
        }

        function atualizarTemposContinuamente() {
            if (intervalos.atualizacaoTempos) {
                clearInterval(intervalos.atualizacaoTempos);
            }

            intervalos.atualizacaoTempos = setInterval(() => {
                Object.keys(carregamentosEmAndamento).forEach(key => {
                    const carregamento = carregamentosEmAndamento[key];
                    if (!carregamento.finalizado) {
                        const tempoDecorrido = Math.floor((new Date().getTime() - carregamento.inicio) / 60000);
                        const tempoPausado = carregamento.pausas ? carregamento.pausas.reduce((total, pausa) => {
                            return total + ((pausa.fim || new Date().getTime()) - pausa.inicio);
                        }, 0) / 60000 : 0;
                        const tempoEfetivo = tempoDecorrido - tempoPausado;

                        const elementoOperacao = document.querySelector(`.carregamento-${key} .tempo-decorrido`);
                        if (elementoOperacao) {
                            const tempoRestante = TEMPO_LIMITE_MINUTOS - tempoEfetivo;
                            const tempoRestanteTexto = tempoRestante >= 0 ?
                                `${tempoRestante} minutos restantes` :
                                `Estourou em ${Math.abs(tempoRestante)} minutos`;

                            let pausaTexto = '';
                            if (carregamento.pausado) {
                                pausaTexto = '<br><span class="badge paused-badge">PAUSADO</span>';
                            } else if (tempoPausado > 0) {
                                pausaTexto = `<br><small>Tempo pausado: ${Math.floor(tempoPausado)} min</small>`;
                            }

                            elementoOperacao.innerHTML = `Tempo: ${Math.floor(tempoEfetivo)} minutos (${tempoDecorrido} min total)<br>Tempo Restante (2:20h): ${tempoRestanteTexto}${pausaTexto}`;

                            elementoOperacao.className = 'tempo-decorrido ' +
                                (tempoEfetivo > 120 ? 'time-critical' :
                                 tempoEfetivo > 90 ? 'time-warning' :
                                 'time-normal');
                        }
                    }
                });

                const docas = document.querySelectorAll('.doca-container');
                docas.forEach(doca => {
                    const inicio = doca.dataset.inicio;
                    if (inicio) {
                        const tempo = Math.floor((new Date().getTime() - parseInt(inicio)) / 60000);
                        const elemento = doca.querySelector('.tempo-doca');
                        if (elemento) {
                            elemento.textContent = `${tempo}`;
                        }
                    }
                });
            }, 1000);
        }

        // Busca um funcionário pelo ID
        function buscarFuncionario(id, mostrarModal = false) {
            return new Promise((resolve, reject) => {
                funcionariosRef.child(id).once('value', (snapshot) => {
                    const funcionario = snapshot.val();

                    if (!funcionario) {
                        if (mostrarModal) {
                            alert('Funcionário não encontrado!');
                        }
                        reject('Funcionário não encontrado');
                        return;
                    }

                    if (mostrarModal) {
                        mostrarDetalhesFuncionario(id, funcionario);
                    }

                    resolve(funcionario);
                });
            });
        }

        // Mostra os detalhes do funcionário em um modal
        function mostrarDetalhesFuncionario(id, funcionario) {
            carregamentosRef.orderByChild('inicio').once('value', (snapshot) => {
                const carregamentos = snapshot.val() || {};
                const carregamentosFuncionario = Object.entries(carregamentos)
                    .filter(([key, c]) => c.participantes && c.participantes[id])
                    .map(([key, c]) => ({ key, ...c }));

                carregamentosFuncionario.sort((a, b) => (b.inicio || 0) - (a.inicio || 0));

                let html = `
                    <div class="row">
                        <div class="col-md-4">
                            <h4><span class="codigo-funcionario">${id}</span></h4>
                            <p><strong>Nome:</strong> ${funcionario.nome || 'Não informado'}</p>
                            <p><strong>Cargo:</strong> ${funcionario.cargo || 'Não informado'}</p>
                            <p><strong>Unidade:</strong> ${funcionario.unidade || 'Não informado'}</p>
                            <p><strong>Total de Carregamentos Participados:</strong> ${carregamentosFuncionario.length}</p>
                            <div class="mt-3">
                                <canvas id="qrCodeModal"></canvas>
                            </div>
                            <div class="mt-3">
                                <button id="btnDeletarFuncionario" class="btn btn-danger">
                                    <i class="bi bi-trash"></i> Apagar Funcionário
                                </button>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <h5>Últimos Carregamentos Participados</h5>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>DT</th>
                                            <th>Tempo Total Carreg.</th>
                                            <th>Tempo Participação</th>
                                            <th>Status</th>
                                            <th>Doca</th>
                                            <th>Valor Est. Ganho</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;

                const carregamentosExibir = carregamentosFuncionario.slice(0, 10);

                carregamentosExibir.forEach(carregamento => {
                    const inicioCarregamento = carregamento.inicio ? new Date(carregamento.inicio).toLocaleDateString() : 'N/A';
                    const fimCarregamento = carregamento.fim ? new Date(carregamento.fim) : null;
                    const tempoTotalCarregamento = fimCarregamento ? `${((fimCarregamento.getTime() - carregamento.inicio) / 60000).toFixed(2)} min` : 'Em andamento';

                    const participacao = carregamento.participantes[id];
                    const entrada = new Date(participacao.entrada);
                    const saida = participacao.saida ? new Date(participacao.saida) : (carregamento.finalizado ? fimCarregamento : new Date());
                    const tempoParticipacao = `${((saida.getTime() - entrada.getTime()) / 60000).toFixed(2)} min`;

                    const status = carregamento.finalizado ? 'Finalizado' : 'Em andamento';
                    const doca = carregamento.doca || 'N/A';
                    const valorGanho = calcularValorParcial(participacao.entrada, participacao.saida, carregamento.inicio, carregamento.fim, carregamento.tipoVeiculo);

                    html += `
                        <tr>
                            <td>${inicioCarregamento}</td>
                            <td>${carregamento.placa || 'N/A'}</td>
                            <td>${tempoTotalCarregamento}</td>
                            <td>${tempoParticipacao}</td>
                            <td>${status}</td>
                            <td>${doca}</td>
                            <td>R$ ${valorGanho.toFixed(2).replace('.', ',')}</td>
                        </tr>
                    `;
                });

                html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('modalFuncionarioTitle').textContent = `Detalhes: ${funcionario.nome || id}`;
                document.getElementById('modalFuncionarioBody').innerHTML = html;

                gerarQRCode(id, 'qrCodeModal');

                const modal = new bootstrap.Modal(document.getElementById('modalFuncionario'));
                modal.show();

                document.getElementById('btnDeletarFuncionario').addEventListener('click', function() {
                    if (confirm(`Tem certeza que deseja apagar o funcionário ${funcionario.nome} (${id})? Esta ação não pode ser desfeita!`)) {
                        funcionariosRef.child(id).remove()
                            .then(() => {
                                alert('Funcionário apagado com sucesso!');
                                modal.hide();
                            })
                            .catch(error => {
                                alert('Erro ao apagar funcionário: ' + error.message);
                            });
                    }
                });
            });
        }

        // Calcula o valor parcial ganho por um funcionário em um carregamento
        function calcularValorParcial(entradaFuncionario, saidaFuncionario, inicioCarregamento, fimCarregamento, tipoVeiculo) {
    const inicio = inicioCarregamento;
    const fim = fimCarregamento || new Date().getTime();

    const tempoTotalCarregamentoMs = fim - inicio;
    const tempoPermanenciaFuncionarioMs = (saidaFuncionario || fim) - entradaFuncionario;

    if (tempoTotalCarregamentoMs <= 0) {
        return 0;
    }

    // Define o percentual com base no tipo de veículo
    let percentual = 1.0; // 100% padrão
    switch(tipoVeiculo) {
        case 'carreta':
        case 'rodotrem':
            percentual = 1.0; // 100%
            break;
        case 'truck':
            percentual = 0.5; // 50%
            break;
        case '608':
        case 'kombi':
            percentual = 0.25; // 25%
            break;
        default:
            percentual = 1.0; // Padrão 100% se não especificado
    }

    const proporcaoTempo = tempoPermanenciaFuncionarioMs / tempoTotalCarregamentoMs;
    let valorGanho = proporcaoTempo * VALOR_POR_COLABORADOR_POR_CARREGAMENTO * percentual;
    valorGanho = Math.min(VALOR_POR_COLABORADOR_POR_CARREGAMENTO * percentual, valorGanho);
    return Math.max(0, valorGanho);
}

        // Função para remover um funcionário de um carregamento em andamento
        function removerFuncionarioDeCarregamento(funcionarioId, carregamentoKey, timestampSaida) {
    return new Promise((resolve, reject) => {
        carregamentosRef.child(carregamentoKey).once('value', (snapshot) => {
            const carregamento = snapshot.val();

            if (!carregamento || carregamento.finalizado || !carregamento.participantes || !carregamento.participantes[funcionarioId] || carregamento.participantes[funcionarioId].saida) {
                resolve();
                return;
            }

            // Permite remover o último funcionário se o carregamento estiver pausado
            const numParticipantesAtivos = Object.values(carregamento.participantes).filter(p => !p.saida).length;
            
            if (numParticipantesAtivos <= 1 && !carregamento.pausado) {
                reject(`Não é possível remover o último funcionário (${carregamento.participantes[funcionarioId].nome || funcionarioId}) de um carregamento em andamento.`);
                return;
            }

            const entrada = carregamento.participantes[funcionarioId].entrada;
            const valorParcial = calcularValorParcial(entrada, timestampSaida, carregamento.inicio, timestampSaida);

            const updates = {};
            updates[`participantes/${funcionarioId}/saida`] = timestampSaida;

            carregamentosRef.child(carregamentoKey).update(updates)
                .then(() => {
                    console.log(`Funcionário ${funcionarioId} removido de ${carregamentoKey}. Valor parcial calculado: R$ ${valorParcial.toFixed(2)}`);
                    resolve();
                })
                .catch(error => {
                    console.error("Erro ao remover funcionário e calcular parcial:", error);
                    reject("Erro ao remover funcionário e calcular parcial.");
                });
        });
    });
}

        // Busca todos os carregamentos em andamento de um ou mais funcionários
        function buscarCarregamentosEmAndamentoPorFuncionarios(funcionarioIds, incluirPausados = true) {
    return new Promise((resolve, reject) => {
        carregamentosRef.orderByChild('finalizado').equalTo(false).once('value', (snapshot) => {
            const carregamentos = snapshot.val() || {};
            const carregamentosEncontrados = [];

            Object.entries(carregamentos).forEach(([key, carregamento]) => {
                if (carregamento.unidade === unidadeAtual && carregamento.participantes && 
                    (incluirPausados || !carregamento.pausado)) {
                    
                    const temParticipanteAtivo = funcionarioIds.some(id => 
                        carregamento.participantes[id] && !carregamento.participantes[id].saida
                    );
                    
                    if (temParticipanteAtivo) {
                        carregamentosEncontrados.push({ key, ...carregamento });
                    }
                }
            });
            resolve(carregamentosEncontrados);
        }, reject);
    });
}

        // Remove funcionários de carregamentos anteriores antes de iniciar/adicionar
        function removerFuncionariosDeCarregamentosAnteriores(funcionarioIds) {
    const timestampSaida = new Date().getTime();
    const promises = [];

    return buscarCarregamentosEmAndamentoPorFuncionarios(funcionarioIds)
        .then(carregamentosAnteriores => {
            carregamentosAnteriores.forEach(carregamento => {
                funcionarioIds.forEach(id => {
                    if (carregamento.participantes && carregamento.participantes[id] && !carregamento.participantes[id].saida) {
                        // Permite remoção se o carregamento estiver pausado
                        if (carregamento.pausado) {
                            promises.push(removerFuncionarioDeCarregamento(id, carregamento.key, timestampSaida));
                        } else {
                            // Para carregamentos não pausados, mantém a verificação original
                            const numParticipantesAtivos = Object.values(carregamento.participantes)
                                .filter(p => !p.saida).length;
                            
                            if (numParticipantesAtivos > 1) {
                                promises.push(removerFuncionarioDeCarregamento(id, carregamento.key, timestampSaida));
                            }
                        }
                    }
                });
            });
            return Promise.all(promises);
        });
}

        // Inicia um novo carregamento
        async function iniciarCarregamento() {
    const tipoOperacao = document.getElementById('tipoOperacao').value;
    const funcionarioPrincipal = document.getElementById('funcionarioPrincipal').value.trim();
    
    const funcionarioAdicionais = Array.from(document.querySelectorAll('#carregadoresContainer .funcionario-input:not(#funcionarioPrincipal)'))
        .map(input => input.value.trim())
        .filter(id => id);
    
    const todosParticipantesIds = [funcionarioPrincipal, ...funcionarioAdicionais];
    const placa = document.getElementById('placaCaminhao').value.trim().toUpperCase();
    const doca = document.getElementById('docaNumero').value;
    const armagens = $('#armagens').val() || [];
    const tipoVeiculo = document.getElementById('tipoVeiculo').value;
    
    // Validações
    if (!funcionarioPrincipal) {
        alert('Preencha o funcionário principal!');
        return;
    }
    
    if (!doca) {
        alert('Informe a doca!');
        return;
    }

    // Verificação da doca (apenas para carregamento/descarregamento)
    if (tipoOperacao !== 'separacao') {
        const docaSnapshot = await docasRef.child(doca).once('value');
        const docaStatus = docaSnapshot.val();
        
        if (docaStatus && docaStatus.ocupada) {
            alert(`Doca ${doca} já está ocupada!`);
            return;
        }
    }

    const timestampEntrada = new Date().getTime();
    let funcionariosComNome = {};

    try {
        // Busca informações dos funcionários
        const buscaFuncionariosPromises = todosParticipantesIds.map(id =>
            buscarFuncionario(id)
                .then(func => {
                    funcionariosComNome[id] = func.nome || id;
                    return func;
                })
        );
        
        await Promise.all(buscaFuncionariosPromises);
        await removerFuncionariosDeCarregamentosAnteriores(todosParticipantesIds);

        const participantes = {};
        todosParticipantesIds.forEach(id => {
            participantes[id] = {
                nome: funcionariosComNome[id],
                entrada: timestampEntrada,
                saida: null
            };
        });

        const carregamento = {
            placa: tipoOperacao !== 'separacao' ? placa : null,
            doca,
            inicio: timestampEntrada,
            fim: null,
            finalizado: false,
            participantes: participantes,
            armagens: tipoOperacao === 'carregamento' ? armagens : [],
            unidade: unidadeAtual,
            pausado: false,
            pausas: [],
            tipoVeiculo: tipoOperacao === 'carregamento' ? tipoVeiculo : null,
            tipoOperacao: tipoOperacao,
            tipoDescarregamento: tipoOperacao === 'descarregamento' ? document.getElementById('tipoDescarregamento').value : null,
            motivoErro: tipoOperacao === 'descarregamento' && document.getElementById('tipoDescarregamento').value === 'erro_operacional' ? 
                document.getElementById('motivoErro').value : null
        };

        const newKey = carregamentosRef.push().key;
        
        // Atualiza doca apenas se não for separação
        if (tipoOperacao !== 'separacao') {
            await docasRef.child(doca).set({
                ocupada: true,
                placa: placa,
                inicio: carregamento.inicio,
                tipoOperacao: tipoOperacao
            });
        }
        
        await carregamentosRef.child(newKey).set(carregamento);

        // Limpa formulário
        document.getElementById('formContainer').style.display = 'none';
        document.querySelectorAll('.funcionario-input').forEach(input => input.value = '');
        $('#armagens').val(null).trigger('change');
        const carregadoresContainer = document.getElementById('carregadoresContainer');
        while (carregadoresContainer.children.length > 1) {
            carregadoresContainer.removeChild(carregadoresContainer.lastChild);
        }

        alert(`${tipoOperacao === 'carregamento' ? 'Carregamento' : 
               tipoOperacao === 'separacao' ? 'Separação' : 'Descarregamento'} iniciado com sucesso!`);
        
    } catch (error) {
        console.error(`Erro ao iniciar ${tipoOperacao}:`, error);
        alert(`Erro ao iniciar ${tipoOperacao}.`);
    }
}

        // Finaliza um carregamento
        function finalizarCarregamento() {
            const funcionarioPrincipal = document.getElementById('funcionarioPrincipal').value.trim();
            
            if (!funcionarioPrincipal) {
                alert('Informe o funcionário principal!');
                return;
            }

            const mixMaterial = document.getElementById('mixMaterial').value.trim();
            const toneladas = document.getElementById('toneladas').value.trim();
            const observacao = document.getElementById('Just').value.trim();

            // Validação das toneladas (agora obrigatório para todos os tipos)
            const toneladasValue = parseFloat(toneladas);
            if (isNaN(toneladasValue) || toneladasValue < 0 || toneladasValue > 9.9) {
                alert('Informe um valor válido para toneladas (entre 0 e 9.9)!');
                return;
            }

            carregamentosRef.orderByChild('finalizado').equalTo(false).once('value', (snapshot) => {
                const carregamentos = snapshot.val() || {};
                let carregamentoEmAndamento = null;
                let carregamentoKey = null;

                Object.entries(carregamentos).forEach(([key, c]) => {
                    if (c.unidade === unidadeAtual && c.participantes && c.participantes[funcionarioPrincipal] && !c.participantes[funcionarioPrincipal].saida) {
                        carregamentoEmAndamento = c;
                        carregamentoKey = key;
                        return false;
                    }
                });

                if (!carregamentoEmAndamento) {
                    alert('Nenhuma operação em andamento encontrada para este funcionário!');
                    return;
                }

                const isSeparacao = carregamentoEmAndamento.tipoOperacao === 'separacao';
                const isDescarregamento = carregamentoEmAndamento.tipoOperacao === 'descarregamento';
                const docaNumero = carregamentoEmAndamento.doca;
                const placa = carregamentoEmAndamento.placa || (isSeparacao ? 'SEPARAÇÃO' : 'DESCARREGAMENTO');

                // Confirmação antes de finalizar
                if (!confirm(`Tem certeza que deseja finalizar ${isSeparacao ? 'separação' : isDescarregamento ? 'descarregamento' : 'carregamento'} na Doca ${docaNumero} - DT ${placa}?`)) {
                    return;
                }

                const timestampFim = new Date().getTime();
                const updates = {
                    fim: timestampFim,
                    finalizado: true,
                    observacao: observacao || null,
                    // Agora sempre salva as toneladas, independente do tipo de operação
                    toneladas: toneladasValue.toFixed(1)
                };

                // Só adiciona mix se for carregamento (opcional para outros tipos)
                if (!isSeparacao && !isDescarregamento) {
                    if (!mixMaterial || isNaN(mixMaterial)) {
                        alert('Informe uma quantidade válida de mix de material!');
                        return;
                    }
                    updates.mixMaterial = parseInt(mixMaterial);
                }

                if (carregamentoEmAndamento.participantes) {
                    Object.entries(carregamentoEmAndamento.participantes).forEach(([id, p]) => {
                        if (!p.saida) updates[`participantes/${id}/saida`] = timestampFim;
                    });
                }

                // Atualiza no Firebase
                carregamentosRef.child(carregamentoKey).update(updates)
                    .then(() => {
                        // Libera a doca para qualquer tipo de operação
                        return docasRef.child(docaNumero).update({
                            ocupada: false,
                            placa: '',
                            inicio: null,
                            tipoOperacao: null
                        });
                    })
                    .then(() => {
                        hideAllForms();
                        document.querySelectorAll('#carregadoresContainer .funcionario-input').forEach(i => i.value = '');
                        document.getElementById('mixMaterial').value = '';
                        document.getElementById('toneladas').value = '';
                        document.getElementById('Just').value = '';
                        
                        const container = document.getElementById('carregadoresContainer');
                        while (container.children.length > 1) container.removeChild(container.lastChild);

                        // Força a atualização imediata da interface
                        atualizarDocaEspecifica(docaNumero);
                        atualizarCarregamentosAndamento();
                        
                        alert(`${isSeparacao ? 'Separação' : isDescarregamento ? 'Descarregamento' : 'Carregamento'} registrado com sucesso!`);
                    })
                    .catch(error => {
                        console.error('Erro ao finalizar:', error);
                        alert(`Erro ao finalizar ${isSeparacao ? 'separação' : isDescarregamento ? 'descarregamento' : 'carregamento'}`);
                    });
            });
        }

        // Função auxiliar para finalizar no Firebase (atualizada)
        function finalizarCarregamentoFirebase(key, carregamento, mixMaterial, toneladas) {
            const timestampFim = new Date().getTime();
            const Justificativa = document.getElementById('Just').value;
            const updates = {
                fim: timestampFim,
                finalizado: true,
                Justificativa: Justificativa,
                // Agora sempre salva toneladas
                toneladas: parseFloat(toneladas)
            };

            // Só atualiza mix se for carregamento
            if (carregamento.tipoOperacao === 'carregamento') {
                updates.mixMaterial = parseInt(mixMaterial);
            }

            if (carregamento.participantes) {
                Object.entries(carregamento.participantes).forEach(([id, participacao]) => {
                    if (!participacao.saida) {
                        updates[`participantes/${id}/saida`] = timestampFim;
                    }
                });
            }

            carregamentosRef.child(key).update(updates)
                .then(() => {
                    if (carregamento.doca) {
                        docasRef.child(carregamento.doca).update({
                            ocupada: false,
                            placa: '',
                            inicio: null,
                            tipoOperacao: null
                        });
                    }

                    document.getElementById('formContainer').style.display = 'none';
                    document.querySelectorAll('#carregadoresContainer .funcionario-input').forEach(input => input.value = '');
                    document.getElementById('mixMaterial').value = '';
                    document.getElementById('toneladas').value = '';
                    const carregadoresContainer = document.getElementById('carregadoresContainer');
                    while (carregadoresContainer.children.length > 1) {
                        carregadoresContainer.removeChild(carregadoresContainer.lastChild);
                    }

                    // Atualiza o dashboard completo após finalizar
                    atualizarDashboardCompleto();

                    alert(`${carregamento.tipoOperacao === 'carregamento' ? 'Carregamento' : 
                        carregamento.tipoOperacao === 'separacao' ? 'Separação' : 'Descarregamento'} finalizado com sucesso!`);
                })
                .catch(error => {
                    console.error(`Erro ao finalizar ${carregamento.tipoOperacao}:`, error);
                    alert(`Erro ao finalizar ${carregamento.tipoOperacao}.`);
                });
        }
        
        document.getElementById('dashboard-tab').addEventListener('hide.bs.tab', function() {
        // Destruir gráficos quando a aba é fechada para evitar vazamento de memória
        if (window.tiposCaminhoesChart) {
            window.tiposCaminhoesChart.destroy();
            window.tiposCaminhoesChart = null;
        }
        if (window.mixMaterialChart) {
            window.mixMaterialChart.destroy();
            window.mixMaterialChart = null;
        }
        if (window.pioresColaboradoresChart) {
            window.pioresColaboradoresChart.destroy();
            window.pioresColaboradoresChart = null;
        }
    });

        // Função auxiliar para finalizar no Firebase
        function finalizarCarregamentoFirebase(key, carregamento, mixMaterial, toneladas) {
    const timestampFim = new Date().getTime();
    const Justificativa = document.getElementById('Just').value;
    const updates = {
        fim: timestampFim,
        finalizado: true,
        Justificativa: Justificativa,
    };

    // Só atualiza mix e toneladas se for carregamento
    if (carregamento.tipoOperacao === 'carregamento') {
        updates.mixMaterial = parseInt(mixMaterial);
        updates.toneladas = parseFloat(toneladas);
    }

    if (carregamento.participantes) {
        Object.entries(carregamento.participantes).forEach(([id, participacao]) => {
            if (!participacao.saida) {
                updates[`participantes/${id}/saida`] = timestampFim;
            }
        });
    }

    carregamentosRef.child(key).update(updates)
        .then(() => {
            if (carregamento.doca) {
                docasRef.child(carregamento.doca).update({
                    ocupada: false,
                    placa: '',
                    inicio: null,
                    tipoOperacao: null
                });
            }

            document.getElementById('formContainer').style.display = 'none';
            document.querySelectorAll('#carregadoresContainer .funcionario-input').forEach(input => input.value = '');
            document.getElementById('mixMaterial').value = '';
            document.getElementById('toneladas').value = '';
            const carregadoresContainer = document.getElementById('carregadoresContainer');
            while (carregadoresContainer.children.length > 1) {
                carregadoresContainer.removeChild(carregadoresContainer.lastChild);
            }

            // Atualiza o dashboard completo após finalizar
            atualizarDashboardCompleto();

            alert(`${carregamento.tipoOperacao === 'carregamento' ? 'Carregamento' : 'Separação'}:  finalizada com sucesso!`);
        })
        .catch(error => {
            console.error(`Erro ao finalizar ${carregamento.tipoOperacao}:`, error);
            alert(`Erro ao finalizar ${carregamento.tipoOperacao}.`);
        });
}

        // Preenche o select de carregamentos em andamento
        function preencherSelectCarregamentos() {
            const select = document.getElementById('carregamentoDestino');
            select.innerHTML = '<option value="">Selecione um carregamento em andamento</option>';

            carregamentosRef.orderByChild('finalizado').equalTo(false).once('value', (snapshot) => {
                const carregamentos = snapshot.val() || {};
                Object.entries(carregamentos).forEach(([key, carregamento]) => {
                    if (carregamento.unidade === unidadeAtual) {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = `Doca ${carregamento.doca || 'N/A'} - DT ${carregamento.placa || 'N/A'}`;
                        select.appendChild(option);
                    }
                });
            });
        }

        // Preenche o select de carregamentos para pausar/retomar
        function preencherSelectCarregamentosPausar() {
            const select = document.getElementById('carregamentoPausar');
            select.innerHTML = '<option value="">Selecione um carregamento em andamento</option>';

            carregamentosRef.orderByChild('finalizado').equalTo(false).once('value', (snapshot) => {
                const carregamentos = snapshot.val() || {};
                Object.entries(carregamentos).forEach(([key, carregamento]) => {
                    if (carregamento.unidade === unidadeAtual) {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = `Doca ${carregamento.doca || 'N/A'} - DT ${carregamento.placa || 'N/A'} ${carregamento.pausado ? '(PAUSADO)' : ''}`;
                        select.appendChild(option);
                    }
                });
            });
        }

        // Pausa ou retoma um carregamento
       function pausarRetomarCarregamento() {
    const funcionarioId = document.getElementById('pausarFuncionarioId').value.trim();
    const carregamentoKey = document.getElementById('carregamentoPausar').value;
    const acao = document.getElementById('acaoPausar').value;

    if (!funcionarioId || !carregamentoKey) {
        alert('Informe o funcionário e selecione o carregamento!');
        return;
    }

    carregamentosRef.child(carregamentoKey).once('value', (snapshot) => {
        const carregamento = snapshot.val() || {};

        // Verificação mais robusta
        if (!carregamento || carregamento.finalizado) {
            alert('Carregamento selecionado inválido ou já finalizado.');
            return;
        }

        // Verifica participantes de forma segura
        if (!carregamento.participantes || !carregamento.participantes[funcionarioId] || 
            (carregamento.participantes[funcionarioId].saida !== undefined && 
             carregamento.participantes[funcionarioId].saida !== null)) {
            alert('Este funcionário não está participando ativamente deste carregamento.');
            return;
        }

        const updates = {};
        const agora = new Date().getTime();

        // Garante que o array de pausas exista
        updates.pausas = carregamento.pausas || [];

        // Mapeamento de ações para motivos
        const motivoMap = {
            'pausar_refeicao': 'Refeição',
            'retomar_refeicao': 'Refeição',
            'pausar_faturar': 'Aguardando Faturar',
            'retomar_faturar': 'Aguardando Faturar',
            'pausar_treinamento': 'Treinamento',
            'retomar_treinamento': 'Treinamento',
            'pausar_sna': 'SNA',
            'retomar_sna': 'SNA',
            'pausar_prioridade': 'Prioridade Operacional',
            'retomar_prioridade': 'Prioridade Operacional',
            'pausar_limpeza': 'Limpeza/Organização',
            'retomar_limpeza': 'Limpeza/Organização',
            'pausar_ocorrencia': 'Ocorrência',
            'retomar_ocorrencia': 'Ocorrência',
            'pausar_tombamento': 'Tombamento',
            'retomar_tombamento': 'Tombamento',
            'pausar_chuva': 'Chuva',
            'retomar_chuva': 'Chuva'
        };

        if (acao.startsWith('pausar_')) {
            if (carregamento.pausado) {
                alert('Este carregamento já está pausado!');
                return;
            }
            
            updates.pausado = true;
            updates.pausas.push({
                inicio: agora,
                fim: null,
                motivo: motivoMap[acao] || 'Outro motivo'
            });
        } 
        else if (acao.startsWith('retomar_')) {
            if (!carregamento.pausado) {
                alert('Este carregamento não está pausado!');
                return;
            }
            
            // Encontra a última pausa não finalizada
            const ultimaPausa = [...updates.pausas]
                .reverse()
                .find(p => !p.fim);

            if (ultimaPausa) {
                ultimaPausa.fim = agora;
            }

            updates.pausado = false;
        }

        // Atualiza no Firebase
        carregamentosRef.child(carregamentoKey).update(updates)
            .then(() => {
                const motivo = motivoMap[acao] || '';
                const tipoAcao = acao.startsWith('pausar_') ? 'pausado' : 'retomado';
                alert(`Carregamento ${tipoAcao} (Motivo: ${motivo}) com sucesso!`);
                
                hideAllForms();
                document.getElementById('pausarFuncionarioId').value = '';
                document.getElementById('carregamentoPausar').value = '';
                
                // Força atualização imediata da interface
                atualizarDocaEspecifica(carregamento.doca);
                atualizarCarregamentosAndamento();
            })
            .catch(error => {
                console.error("Erro ao pausar/retomar carregamento:", error);
                alert(`Erro ao ${acao.startsWith('pausar_') ? 'pausar' : 'retomar'} carregamento: ${error.message}`);
            });
    });
}

        // Adiciona um funcionário a um carregamento existente
        function addFuncionarioToCarregamento() {
    const funcionarioId = document.getElementById('addFuncionarioId').value.trim();
    const carregamentoKey = document.getElementById('carregamentoDestino').value;

    if (!funcionarioId || !carregamentoKey) {
        alert('Informe o funcionário e selecione o carregamento!');
        return;
    }

    const timestampEntrada = new Date().getTime();
    let funcionarioNome = funcionarioId;

    buscarFuncionario(funcionarioId)
        .then(func => {
            funcionarioNome = func.nome || funcionarioId;
            return carregamentosRef.child(carregamentoKey).once('value');
        })
        .then(snapshot => {
            const carregamentoDestino = snapshot.val();

            if (!carregamentoDestino || carregamentoDestino.finalizado) {
                alert('Carregamento selecionado inválido ou já finalizado.');
                throw new Error('Carregamento inválido');
            }

            // Verifica se o funcionário já está no carregamento de destino
            if (carregamentoDestino.participantes && carregamentoDestino.participantes[funcionarioId] && !carregamentoDestino.participantes[funcionarioId].saida) {
                alert('Este funcionário já está participando deste carregamento.');
                throw new Error('Funcionário já participando');
            }

            return removerFuncionariosDeCarregamentosAnteriores([funcionarioId]);
        })
        .then(() => {
            return carregamentosRef.child(carregamentoKey).once('value');
        })
        .then(snapshot => {
            const carregamento = snapshot.val();

            const updates = {};
            updates[`participantes/${funcionarioId}`] = {
                nome: funcionarioNome,
                entrada: timestampEntrada,
                saida: null
            };

            return carregamentosRef.child(carregamentoKey).update(updates);
        })
        .then(() => {
            alert('Funcionário adicionado ao carregamento com sucesso!');
            hideAllForms();
            document.getElementById('addFuncionarioId').value = '';
            document.getElementById('carregamentoDestino').value = '';
        })
        .catch(error => {
            console.error("Erro ao adicionar funcionário ao carregamento:", error);
            if (error.message === 'Carregamento inválido' || error.message === 'Funcionário já participando') {
                // Já tratado
            } else {
                alert('Erro ao adicionar funcionário ao carregamento: ' + (error.message || 'Consulte o console para detalhes'));
            }
        });
}

        // Remove um funcionário de um carregamento em andamento
        function handleRemoveFuncionario(event) {
            const button = event.target.closest('.btn-remove-funcionario');
            const carregamentoKey = button.dataset.carregamentoKey;
            const funcionarioId = button.dataset.funcionarioId;
            const funcionarioNome = button.dataset.funcionarioNome;

            const timestampSaida = new Date().getTime();

            removerFuncionarioDeCarregamento(funcionarioId, carregamentoKey, timestampSaida)
                .then(() => {
                    alert(`${funcionarioNome} removido do carregamento.`);
                })
                .catch(error => {
                    console.error("Erro ao remover funcionário:", error);
                    if (typeof error === 'string') {
                        alert(error);
                    } else {
                        alert('Erro ao remover funcionário.');
                    }
                });
        }

        // Atualiza o dashboard em tempo real
        function atualizarDashboard() {
    carregamentosRef.orderByChild('finalizado').equalTo(false).on('value', (snapshot) => {
        const carregamentos = snapshot.val() || {};
        carregamentosEmAndamento = carregamentos;

        // Atualiza cards de carregamento
        atualizarCardsCarregamento(carregamentos);
        
        // Atualiza dashboard resumido
        atualizarDashboardResumido(carregamentos);
        
        // Atualiza lista de funcionários
        atualizarFuncionariosEmAcao(carregamentos);
    });

    // Monitora mudanças nas docas
    docasRef.on('value', snapshot => {
        const docas = snapshot.val() || {};
        atualizarInterfaceDocas(docas);
    });
}
function iniciarAtualizacaoAutomatica() {
    // Atualiza todas as docas imediatamente e depois a cada minuto
    for (let i = 1; i <= 11; i++) {
        atualizarDocaEspecifica(i);
    }
    
    intervaloAtualizacaoDoca = setInterval(() => {
        for (let i = 1; i <= 11; i++) {
            atualizarDocaEspecifica(i);
        }
    }, 60000); // 60 segundos
}
function atualizarDocaEspecifica(numeroDoca) {
    // Busca os dados atualizados da doca
    docasRef.child(numeroDoca).once('value', (snapshot) => {
        const doca = snapshot.val();
        const docaElement = document.querySelector(`.doca-${numeroDoca}`);
        
        if (!docaElement) return;

        if (doca && doca.ocupada) {
            // Busca o carregamento associado
            carregamentosRef
                .orderByChild('doca')
                .equalTo(numeroDoca.toString())
                .once('value', (snapCar) => {
                    const dados = snapCar.val() || {};
                    const key = Object.keys(dados).find(k => !dados[k].finalizado);
                    
                    if (key) {
                        const carregamento = dados[key];
                        atualizarInterfaceDoca(numeroDoca, carregamento, doca);
                    } else {
                        // Se não encontrar carregamento ativo, mantém a doca como ocupada
                        docaElement.innerHTML = `
                            <div class="doca-header">Doca ${numeroDoca}</div>
                            <p class="mb-1"><strong>Status:</strong> <span class="text-danger">Ocupada 🚚💨</span></p>
                            <p>Carregando informações...</p>
                        `;
                    }
                });
        } else {
            // Doca livre
            docaElement.innerHTML = `
                <div class="doca-header">Doca ${numeroDoca}</div>
                <p class="mb-1"><strong>Status:</strong> <span class="text-success">Livre 🚛</span></p>
            `;
            docaElement.classList.remove('paused');
        }
    });
}


// Funções auxiliares
function atualizarCardsCarregamento(carregamentos) {
    let operacaoHtml = '';
    
    Object.entries(carregamentos).forEach(([key, carregamento]) => {
        if (carregamento.unidade === unidadeAtual) {
            const { tempoDecorrido, tempoPausado, tempoEfetivo } = calcularTempos(carregamento);
            const tempoClass = getClassTempo(tempoEfetivo);
            const tempoRestanteTexto = getTextoRestante(tempoEfetivo);
            
            const participantesHtml = gerarHtmlParticipantes(carregamento, key);
            
            let pausaBadge = '';
            if (carregamento.pausado && carregamento.pausas && carregamento.pausas.length > 0) {
                const ultimaPausa = [...carregamento.pausas].reverse().find(p => !p.fim);
                if (ultimaPausa) {
                    motivoPausa = ultimaPausa.motivo || 'Não especificado';
                    pausaBadge = `<span class="badge paused-badge">PAUSADO (Motivo: ${motivoPausa})</span>`;
                }
            }

            // Card para separação (formato simplificado)
            if (carregamento.tipoOperacao === 'separacao') {
                operacaoHtml += `
                    <div class="card card-separacao em-andamento mb-2 carregamento-${key}">
                        <div class="card-body">
                            <h6 class="card-title">Separação</h6>
                            <p class="card-text">Doca: ${carregamento.doca || 'N/A'}</p>
                            ${participantesHtml}
                            <p class="card-text tempo-decorrido ${tempoClass}">
                               Tempo: ${Math.floor(tempoEfetivo)} minutos (${tempoDecorrido} min total)<br>
                               ${tempoRestanteTexto}
                            </p>
                            <p class="card-text mb-0"><small>Início: ${new Date(carregamento.inicio).toLocaleTimeString()}</small></p>
                        </div>
                    </div>
                `;
            } 
            // Card para carregamento/descarregamento (formato completo)
            else {
                let titulo = '';
                if (carregamento.tipoOperacao === 'carregamento') {
                    titulo = `Carregamento: ${carregamento.placa || 'N/A'}`;
                } else if (carregamento.tipoOperacao === 'descarregamento') {
                    titulo = `Descarregamento: ${carregamento.placa || 'N/A'}`;
                    if (carregamento.tipoDescarregamento === 'erro_operacional') {
                        titulo += ` (Erro: ${carregamento.motivoErro || 'N/A'})`;
                    }
                }

                operacaoHtml += `
                    <div class="card card-carregamento em-andamento mb-2 carregamento-${key} ${carregamento.pausado ? 'paused' : ''}">
                        <div class="card-body">
                            <h6 class="card-title">${titulo} ${pausaBadge}</h6>
                            <p class="card-text">Doca: ${carregamento.doca || 'N/A'}</p>
                            ${participantesHtml}
                            <p class="card-text tempo-decorrido ${tempoClass}">
                               Tempo: ${Math.floor(tempoEfetivo)} minutos (${tempoDecorrido} min total)<br>
                               ${carregamento.tipoOperacao !== 'separacao' ? `Tempo Restante (2:20h): ${tempoRestanteTexto}` : ''}
                            </p>
                            <p class="card-text mb-0"><small>Início: ${new Date(carregamento.inicio).toLocaleTimeString()}</small></p>
                            ${carregamento.armagens && carregamento.armagens.length > 0 ? 
                              `<p class="card-text mb-0"><small>Armagens: ${carregamento.armagens.join(', ')}</small></p>` : ''}
                        </div>
                    </div>
                `;
            }
        }
    });

    document.getElementById('carregamentosAndamento').innerHTML = operacaoHtml || 
        '<div class="alert alert-info">Nenhuma operação em andamento no momento</div>';
    configurarBotoesRemoverFuncionario();
}


function atualizarDashboardResumido(carregamentos) {
    let dashboardHtml = '';
    const funcionariosEmAcao = {};

    Object.keys(carregamentos).forEach(key => {
        const carregamento = carregamentos[key];
        if (carregamento.unidade === unidadeAtual) {
            const { tempoEfetivo } = calcularTempos(carregamento);
            const porcentagem = Math.min(100, Math.max(0, (tempoEfetivo / TEMPO_LIMITE_MINUTOS) * 100));
            const progressClass = getClassProgresso(porcentagem);
            const tempoRestanteTexto = getTextoRestante(tempoEfetivo);
            const pausaBadge = carregamento.pausado ? '<span class="badge paused-badge">PAUSADO</span>' : '';

            // Determina o título com base no tipo de operação
            let titulo = '';
            if (carregamento.tipoOperacao === 'carregamento') {
                titulo = `Carregamento: ${carregamento.placa || 'N/A'}`;
            } else if (carregamento.tipoOperacao === 'separacao') {
                titulo = `Separação`;
            } else if (carregamento.tipoOperacao === 'descarregamento') {
                titulo = `Descarregamento: ${carregamento.placa || 'N/A'}`;
                if (carregamento.tipoDescarregamento === 'erro_operacional') {
                    titulo += ` (Erro: ${carregamento.motivoErro || 'N/A'})`;
                } else {
                    titulo += ` (Transferência)`;
                }
            }

            dashboardHtml += `
                <div class="card mb-3 ${carregamento.pausado ? 'paused' : ''}">
                    <div class="card-body">
                        <h6>${titulo} ${pausaBadge}</h6>
                        <p>Doca: ${carregamento.doca || 'N/A'}</p>
                        <div class="progress progress-bar-tempo">
                            <div class="progress-bar ${progressClass}"
                                 role="progressbar"
                                 style="width: ${porcentagem}%"
                                 aria-valuenow="${porcentagem}"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <small>Tempo: ${Math.floor(tempoEfetivo)} minutos (${tempoRestanteTexto})</small>
                        ${carregamento.armagens ? `<p class="mb-0"><small>Armagens: ${carregamento.armagens.join(', ')}</small></p>` : ''}
                    </div>
                </div>
            `;

            // Contabiliza funcionários ativos
            if (carregamento.participantes) {
                Object.entries(carregamento.participantes)
                    .filter(([id, p]) => !p.saida)
                    .forEach(([id, p]) => {
                        funcionariosEmAcao[id] = (funcionariosEmAcao[id] || 0) + 1;
                    });
            }
        }
    });

    document.getElementById('dashboardCarregamentos').innerHTML = dashboardHtml || '<p>Nenhum carregamento em andamento</p>';
    document.getElementById('totalCarregamentosHoje').textContent = Object.values(carregamentos).filter(c => c.unidade === unidadeAtual).length;
    
    return funcionariosEmAcao;
}

function atualizarFuncionariosEmAcao(carregamentos) {
    const funcionariosEmAcao = atualizarDashboardResumido(carregamentos);
    const funcionariosEmAcaoIds = Object.keys(funcionariosEmAcao);

    if (funcionariosEmAcaoIds.length > 0) {
        const promises = funcionariosEmAcaoIds.map(id => 
            buscarFuncionario(id)
                .then(f => ({ id, nome: f.nome || id }))
                .catch(() => ({ id, nome: id }))
        );
        
        Promise.all(promises).then(funcionariosComNome => {
            let funcionariosHtml = '';
            funcionariosComNome.forEach(func => {
                funcionariosHtml += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <strong>${func.nome}</strong>
                            <small class="text-muted d-block">${func.id}</small>
                        </div>
                        <span class="badge bg-primary rounded-pill">${funcionariosEmAcao[func.id]} carreg.</span>
                    </div>
                `;
            });
            document.getElementById('dashboardFuncionarios').innerHTML = funcionariosHtml;
        });
    } else {
        document.getElementById('dashboardFuncionarios').innerHTML = '<p>Nenhum funcionário em ação no momento</p>';
    }
}

function atualizarInterfaceDocas(docas = {}) {
    const container = document.getElementById('docasContainer');
    if (!container) return;

    container.innerHTML = '';

    // Filtra docas ocupadas (tanto carregamentos quanto descarregamentos)
    const docasOcupadas = Object.entries(docas)
        .filter(([_, doca]) => doca && doca.ocupada)
        .map(([num, doca]) => ({ num, doca }));

    // Ordena docas ocupadas primeiro
    const docasOrdenadas = [
        ...docasOcupadas,
        ...Array.from({length: 11}, (_, i) => i + 1)
            .filter(num => !docas[num] || !docas[num].ocupada)
            .map(num => ({ num, doca: { ocupada: false } }))
    ];

    docasOrdenadas.forEach(({ num: i, doca }) => {
        const ocupadaClass = doca.ocupada ? 'doca-ocupada' : '';
        const statusText = doca.ocupada ? 'Ocupada 🚚💨' : 'Livre 🚛';
        const statusClass = doca.ocupada ? 'text-danger' : 'text-success';
        const placa = doca.placa || '';
        const inicioMs = doca.inicio || 0;
        const inicioStr = inicioMs ? new Date(inicioMs).toLocaleTimeString() : '';
        const tipoOperacao = doca.tipoOperacao || '';

        container.innerHTML += `
            <div class="col-md-4">
                <div class="doca-container ${ocupadaClass} doca-${i}" data-inicio="${inicioMs}">
                    <div class="doca-header">Doca ${i}</div>
                    <p class="mb-1">
                        <strong>Status:</strong>
                        <span class="${statusClass}">${statusText}</span>
                    </p>
                    ${doca.ocupada ? `
                        <p class="mb-1"><strong>Tipo:</strong> ${formatarTipoOperacao(tipoOperacao)}</p>
                        <p class="mb-1"><strong>Colaboradores:</strong></p>
                        <div class="carregadores-nomes">Carregando nomes...</div>
                        <p class="mb-1"><strong>DT:</strong> ${placa}</p>
                        <p class="mb-1"><strong>Início:</strong> ${inicioStr}</p>
                        <div class="tempo-info-doca-${i}">Calculando tempo...</div>
                    ` : ''}
                </div>
            </div>
        `;

        if (doca.ocupada) {
            buscarCarregamentoDoca(i)
                .then(carregamento => {
                    if (carregamento) {
                        atualizarInterfaceDoca(i, carregamento, doca);
                        atualizarParticipantesDoca(i, carregamento);
                    }
                })
                .catch(error => {
                    console.error(`Erro ao buscar carregamento da doca ${i}:`, error);
                });
        }
    });
}

// Função auxiliar para formatar o tipo de operação
function formatarTipoOperacao(tipo) {
    switch(tipo) {
        case 'carregamento': return 'Carregamento';
        case 'separacao': return 'Separação';
        case 'descarregamento': return 'Descarregamento';
        default: return tipo;
    }
}

function buscarCarregamentoDoca(docaNum) {
    return carregamentosRef
        .orderByChild('doca')
        .equalTo(docaNum.toString())
        .once('value')
        .then(snapCar => {
            const dados = snapCar.val() || {};
            const key = Object.keys(dados).find(k => !dados[k].finalizado);
            return key ? dados[key] : null;
        });
}

function atualizarParticipantesDoca(docaNum, carregamento) {
    const participantes = carregamento.participantes || {};
    const nomes = Object.entries(participantes)
        .filter(([_, p]) => !p.saida)
        .map(([_, p]) => p.nome);
    
    const divNomes = document.querySelector(`.doca-${docaNum} .carregadores-nomes`);
    if (divNomes) divNomes.innerHTML = nomes.join('<br>');
}

function atualizarInterfaceDoca(docaNum, carregamento = {}, infoDoca = {}) {
    try {
        const docaElement = document.querySelector(`.doca-${docaNum}`);
        if (!docaElement) return;

        // Calcula tempos com tratamento seguro
        const { tempoDecorrido = 0, tempoPausado = 0, tempoEfetivo = 0 } = calcularTempos(carregamento) || {};
        const { restanteStr = '', pct = 0, barraClass = '' } = calcularProgresso(tempoEfetivo) || {};

        // Adiciona o motivo da pausa se estiver pausado (com tratamento seguro)
        let pausaBadge = '';
        let motivoPausa = '';
        if (carregamento.pausado && Array.isArray(carregamento.pausas)) {
            const ultimaPausa = [...carregamento.pausas]
                .reverse()
                .find(p => p && !p.fim);
            
            if (ultimaPausa) {
                motivoPausa = ultimaPausa.motivo || 'Não especificado';
                pausaBadge = `<span class="badge paused-badge">PAUSADO (Motivo: ${motivoPausa})</span>`;
            }
        }

        // Determina o tipo de operação com informações adicionais
        let tipoTexto = formatarTipoOperacao(carregamento.tipoOperacao);
        if (carregamento.tipoOperacao === 'descarregamento') {
            if (carregamento.tipoDescarregamento === 'erro_operacional') {
                tipoTexto += ` (Erro: ${carregamento.motivoErro || 'N/A'})`;
            } else {
                tipoTexto += ' (Transferência)';
            }
        }

        const tempoHtml = `
            <p class="mb-1"><strong>Tempo Efetivo:</strong> 
                <span class="tempo-decorrido-numero">${tempoEfetivo}</span> min
                (Total: ${tempoDecorrido} min)
                ${pausaBadge}
            </p>
            ${motivoPausa ? `<p class="mb-1"><small>Motivo: ${motivoPausa}</small></p>` : ''}
            <p class="mb-1">
                <strong>Tempo Restante (2:20h):</strong> 
                <span class="tempo-barra-${docaNum}">${formatarTempoRestante(TEMPO_LIMITE_MINUTOS - tempoEfetivo)}</span>
            </p>
            <div class="progress mb-2" style="height:20px">
                <div class="progress-bar ${barraClass}" 
                     style="width:${pct}%" 
                     aria-valuenow="${tempoEfetivo}">
                </div>
            </div>
        `;

        const divTempo = docaElement.querySelector(`.tempo-info-doca-${docaNum}`);
        if (divTempo) divTempo.innerHTML = tempoHtml;

        // Atualiza o tipo de operação
        const tipoElement = docaElement.querySelector('strong:contains("Tipo:")');
        if (tipoElement && tipoElement.nextSibling) {
            tipoElement.nextSibling.textContent = ` ${tipoTexto}`;
        }

        // Atualiza status para mostrar que está pausado
        const statusSpan = docaElement.querySelector(`span.text-danger`);
        if (statusSpan) {
            statusSpan.innerHTML = carregamento.pausado ? 'Pausado ⏸️' : 'Ocupada 🚚💨';
        }

        // Adiciona classe de pausa ao container da doca
        if (carregamento.pausado) {
            docaElement.classList.add('paused');
        } else {
            docaElement.classList.remove('paused');
        }

        // Atualiza participantes com tratamento seguro
        if (carregamento.participantes && typeof carregamento.participantes === 'object') {
            const participantesHtml = Object.entries(carregamento.participantes)
                .filter(([_, p]) => p && !p.saida)
                .map(([_, p]) => p.nome || '')
                .filter(nome => nome)
                .join('<br>') || 'Nenhum colaborador ativo';
            
            const divParticipantes = docaElement.querySelector('.carregadores-nomes');
            if (divParticipantes) divParticipantes.innerHTML = participantesHtml;
        }
    } catch (error) {
        console.error(`Erro em atualizarInterfaceDoca para doca ${docaNum}:`, error);
    }
}

function formatarTempoRestante(minutos) {
    if (minutos <= 0) {
        const minutosAtraso = Math.abs(minutos);
        return `Estourou em ${minutosAtraso} min`;
    }
    
    const horas = Math.floor(minutos / 60);
    const mins = minutos % 60;
    return `${horas}h${mins.toString().padStart(2, '0')}min restantes`;
}

// Funções utilitárias
function calcularTempos(carregamento) {
    const agora = new Date().getTime();
    const tempoDecorrido = Math.floor((agora - carregamento.inicio) / 60000);
    
    // Calcula tempo pausado (em minutos)
    const tempoPausado = carregamento.pausas ? carregamento.pausas.reduce((total, pausa) => {
        const fimPausa = pausa.fim || (carregamento.pausado ? agora : pausa.inicio);
        return total + (fimPausa - pausa.inicio);
    }, 0) / 60000 : 0;
    
    // Tempo efetivo é o tempo decorrido menos as pausas
    const tempoEfetivo = Math.max(0, Math.floor(tempoDecorrido - tempoPausado));
    
    return { 
        tempoDecorrido, 
        tempoPausado: Math.floor(tempoPausado), 
        tempoEfetivo 
    };
}

function calcularProgresso(tempoEfetivo) {
    const restanteMin = TEMPO_LIMITE_MINUTOS - tempoEfetivo;
    const sinal = restanteMin < 0 ? '-' : '';
    const absRest = Math.abs(restanteMin);
    const h = Math.floor(absRest / 60);
    const m = absRest % 60;
    const restanteStr = `${sinal}${h}h${m.toString().padStart(2,'0')}min`;
    
    const pct = Math.min(100, (tempoEfetivo / TEMPO_LIMITE_MINUTOS) * 100);
    
    let barraClass = 'bg-success';
    if (restanteMin <= VERMELHO) barraClass = 'bg-danger';
    else if (restanteMin <= AMARELO) barraClass = 'bg-warning';
    
    return { restanteStr, pct, barraClass };
}

function getClassTempo(tempoEfetivo) {
    const tempoRestante = TEMPO_LIMITE_MINUTOS - tempoEfetivo;
    if (tempoRestante <= 20) return 'time-critical';  
    if (tempoRestante <= 40) return 'time-warning';   
    return 'time-normal';                             
}

function getClassProgresso(porcentagem) {
    if (porcentagem >= 100) return 'bg-danger';
    if (porcentagem > 75) return 'bg-warning';
    return 'bg-success';
}

function getTextoRestante(tempoEfetivo) {
    const tempoRestante = TEMPO_LIMITE_MINUTOS - tempoEfetivo;
    return tempoRestante >= 0 
        ? `${tempoRestante} ${tempoRestante === 1 ? 'minuto' : 'minutos'} restantes` 
        : `Estourou em ${Math.abs(tempoRestante)} ${Math.abs(tempoRestante) === 1 ? 'minuto' : 'minutos'}`;
}

function gerarHtmlParticipantes(carregamento, key) {
    const participantesAtivos = Object.entries(carregamento.participantes || {})
        .filter(([id, p]) => !p.saida);
    
    if (participantesAtivos.length === 0) return '';
    
    let html = '<div class="mt-2"><strong>Colaboradores:</strong><ul class="list-unstyled mb-0 carregadores-lista-operacao">';
    
    participantesAtivos.forEach(([id, p]) => {
        html += `
            <li>
                ${p.nome || id}
                <button class="btn btn-outline-danger btn-sm btn-remove-funcionario"
                        data-carregamento-key="${key}"
                        data-funcionario-id="${id}"
                        data-funcionario-nome="${p.nome || id}">
                    <i class="bi bi-x"></i>
                </button>
            </li>
        `;
    });
    
    html += '</ul></div>';
    return html;
}

function configurarBotoesRemoverFuncionario() {
    document.querySelectorAll('.btn-remove-funcionario').forEach(btn => {
        btn.removeEventListener('click', handleRemoveFuncionario);
        btn.addEventListener('click', handleRemoveFuncionario);
    });
}

        function atualizarBarrasTempo() {
  const TEMPO_TOTAL_MINUTOS = 140; // 2h20min
  const ALERTA_AMARELO = 40; // 40min restantes
  const ALERTA_VERMELHO = 20; // 20min restantes

  for (let i = 1; i <= 11; i++) {
    const doca = document.querySelector(`.doca-container.doca-ocupada.doca-${i}`);
    if (!doca) continue;

    const inicio = parseInt(doca.dataset.inicio);
    if (!inicio) continue;

    const tempoDecorrido = Math.floor((Date.now() - inicio) / 60000); // minutos
    const tempoRestante = TEMPO_TOTAL_MINUTOS - tempoDecorrido;

    // Atualiza o tempo decorrido
    const tempoDecorridoElement = doca.querySelector('.tempo-decorrido-numero');
    if (tempoDecorridoElement) {
      tempoDecorridoElement.textContent = tempoDecorrido;
    }

    // Remove todas as classes de cor/estado
    doca.classList.remove(
      'tempo-normal',
      'tempo-alerta',
      'tempo-critico',
      'tempo-verde',
      'tempo-amarelo',
      'tempo-vermelho'
    );

    // Aplica as classes conforme o tempo restante
    if (tempoRestante <= ALERTA_VERMELHO) {
      doca.classList.add('tempo-critico', 'tempo-vermelho');
    } else if (tempoRestante <= ALERTA_AMARELO) {
      doca.classList.add('tempo-alerta', 'tempo-amarelo');
    } else {
      doca.classList.add('tempo-normal', 'tempo-verde');
    }
  }
}

// Atualiza a cada minuto
setInterval(atualizarBarrasTempo, 60000);
atualizarBarrasTempo(); // Executa imediatamente

        function formatarTempo(minutos) {
            const horas = Math.floor(minutos / 60);
            const min = minutos % 60;
            return `${horas}h${min.toString().padStart(2, '0')}`;
        }

        setInterval(atualizarBarrasTempo, 1000);

        // Atualiza o ranking na aba Ranking (Pódio)
        function atualizarRankingDashboard() {
            const hoje = new Date();
            const mesAtual = hoje.getMonth() + 1;
            const anoAtual = hoje.getFullYear();

            document.getElementById('rankingMesAno').textContent = `Ranking de ${hoje.toLocaleString('pt-BR', { month: 'long', year: 'numeric' })}`;
            document.getElementById('podiumContainer').innerHTML = '';
            document.getElementById('rankingEmpty').style.display = 'none';
            document.getElementById('rankingLoading').style.display = 'block';

            carregamentosRef.orderByChild('fim').once('value', (snapshot) => {
                const todosCarregamentos = snapshot.val() || {};
                const carregamentosMes = Object.values(todosCarregamentos)
                    .filter(c => {
                        if (!c.fim) return false;
                        const dataFim = new Date(c.fim);
                        return dataFim.getMonth() + 1 === mesAtual && dataFim.getFullYear() === anoAtual && c.unidade === unidadeAtual;
                    });

                const funcionariosStats = {};

                carregamentosMes.forEach(carregamento => {
                    if (carregamento.participantes) {
                        Object.entries(carregamento.participantes).forEach(([id, participacao]) => {
                            if (participacao.entrada && participacao.saida) {
                                if (!funcionariosStats[id]) {
                                    funcionariosStats[id] = { count: 0, nome: participacao.nome || id };
                                }
                                funcionariosStats[id].count++;
                            }
                        });
                    }
                });

                const ranking = Object.entries(funcionariosStats)
                    .map(([id, stats]) => ({ id, nome: stats.nome, count: stats.count }))
                    .sort((a, b) => b.count - a.count);

                const podiumContainer = document.getElementById('podiumContainer');
                podiumContainer.innerHTML = '';

                if (ranking.length >= 3) {
                    const top3 = ranking.slice(0, 3);

                    podiumContainer.innerHTML += `
                        <div class="podium-step silver">
                            <div class="content">
                                <div class="name">${top3[1].nome}</div>
                                <div class="medal-icon"><i class="bi bi-award-fill medal-silver"></i></div>
                            </div>
                            <div class="base"></div>
                        </div>
                    `;

                    podiumContainer.innerHTML += `
                        <div class="podium-step gold">
                            <div class="content">
                                <div class="name">${top3[0].nome}</div>
                                <div class="medal-icon"><i class="bi bi-award-fill medal-gold"></i></div>
                            </div>
                            <div class="base"></div>
                        </div>
                    `;

                    podiumContainer.innerHTML += `
                        <div class="podium-step bronze">
                            <div class="content">
                                <div class="name">${top3[2].nome}</div>
                                <div class="medal-icon"><i class="bi bi-award-fill medal-bronze"></i></div>
                            </div>
                            <div class="base"></div>
                        </div>
                    `;
                } else {
                    document.getElementById('rankingEmpty').style.display = 'block';
                }

                document.getElementById('rankingLoading').style.display = 'none';
            });
        }

        // Atualiza o histórico (chamada após autenticação ou filtro)
        function atualizarHistorico(mes, ano, funcionarioId = null) {
            document.getElementById('tabelaHistorico').innerHTML = `
                <tr>
                    <td colspan="11" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </td>
                </tr>
            `;
            document.getElementById('topFuncionariosHistorico').innerHTML = `
                <tr>
                    <td colspan="5" class="text-center">
                        <div class="spinner-border text-primary spinner-border-sm" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </td>
                </tr>
            `;

            const startDate = new Date(ano, mes - 1, 1).getTime();
            const endDate = new Date(ano, mes, 0, 23, 59, 59).getTime();

            let query = carregamentosRef.orderByChild('inicio');
            query = query.startAt(startDate).endAt(endDate);

            query.once('value', (snapshot) => {
                const todosCarregamentosNoPeriodo = snapshot.val() || {};
                const carregamentosFinalizadosNoPeriodo = Object.values(todosCarregamentosNoPeriodo)
                    .filter(c => c.finalizado && c.fim && c.unidade === unidadeAtual);

                const carregamentosFiltrados = funcionarioId ?
                    carregamentosFinalizadosNoPeriodo.filter(c => c.participantes && c.participantes[funcionarioId]) :
                    carregamentosFinalizadosNoPeriodo;

                carregamentosFiltrados.sort((a, b) => b.inicio - a.inicio);

                atualizarEstatisticasHistorico(carregamentosFiltrados);
                preencherTabelaHistorico(carregamentosFiltrados);
                atualizarRankingHistorico(carregamentosFiltrados);
            });
        }

        function atualizarEstatisticasHistorico(carregamentosArray) {
            const totalCaminhoes = carregamentosArray.length;
            const tempoTotal = carregamentosArray.reduce((sum, c) => sum + (c.fim - c.inicio), 0);
            const mediaTempo = totalCaminhoes > 0 ? (tempoTotal / totalCaminhoes / 60000).toFixed(2) : 0;

            let valorTotalEstimado = 0;
            carregamentosArray.forEach(carregamento => {
                if (carregamento.participantes) {
                    Object.values(carregamento.participantes).forEach(participacao => {
                        if (participacao.entrada && participacao.saida) {
                            valorTotalEstimado += calcularValorParcial(participacao.entrada, participacao.saida, carregamento.inicio, carregamento.fim, carregamento.tipoVeiculo);
                        }
                    });
                }
            });

            document.getElementById('totalCaminhoes').textContent = totalCaminhoes;
            document.getElementById('mediaTempo').textContent = `${mediaTempo} min`;
            document.getElementById('valorTotal').textContent = `R$ ${valorTotalEstimado.toFixed(2).replace('.', ',')}`;
        }

        // Atualiza o ranking completo na aba Histórico
        function atualizarRankingHistorico(carregamentos) {
            const funcionariosStats = {};

            carregamentos.forEach(carregamento => {
                if (carregamento.participantes) {
                    Object.entries(carregamento.participantes).forEach(([id, participacao]) => {
                        if (participacao.entrada && participacao.saida) {
                            if (!funcionariosStats[id]) {
                                funcionariosStats[id] = {
                                    count: 0,
                                    tempoTotal: 0,
                                    nome: participacao.nome || id,
                                    valorTotalGanho: 0
                                };
                            }
                            funcionariosStats[id].count++;
                            funcionariosStats[id].tempoTotal += (participacao.saida - participacao.entrada);
                            funcionariosStats[id].valorTotalGanho += calcularValorParcial(participacao.entrada, participacao.saida, carregamento.inicio, carregamento.fim, carregamento.tipoVeiculo);
                        }
                    });
                }
            });

            const ranking = Object.entries(funcionariosStats)
                .map(([id, stats]) => ({
                    id,
                    nome: stats.nome,
                    count: stats.count,
                    tempoMedio: stats.count > 0 ? (stats.tempoTotal / stats.count / 60000).toFixed(2) : 0,
                    valor: stats.valorTotalGanho.toFixed(2)
                }))
                .sort((a, b) => b.count - a.count);

            let topFuncionariosHtml = '';
            ranking.slice(0, 20).forEach((func, index) => {
                topFuncionariosHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${func.nome} <small class="text-muted">${func.id}</small></td>
                        <td>${func.count}</td>
                        <td>${func.tempoMedio} min</td>
                        <td>R$ ${func.valor.replace('.', ',')}</td>
                    </tr>
                `;
            });

            document.getElementById('topFuncionariosHistorico').innerHTML = topFuncionariosHtml || '<tr><td colspan="5" class="text-center">Sem dados para ranking no período</td></tr>';
        }

        // Função auxiliar para preencher a tabela de histórico
        function preencherTabelaHistorico(carregamentosArray) {
    let historicoHtml = '';

    if (carregamentosArray.length === 0) {
        document.getElementById('tabelaHistorico').innerHTML = '<tr><td colspan="11" class="text-center">Nenhum registro encontrado para o período/filtro</td></tr>';
        return;
    }

    carregamentosArray.forEach((carregamento) => {
        const inicio = new Date(carregamento.inicio);
        const fim = carregamento.fim ? new Date(carregamento.fim) : null;
        const tempoTotalCarregamento = fim ? `${((fim - inicio) / 60000).toFixed(2)} min` : 'N/A';

        // Calcula tempo total de pausas
        const tempoPausado = carregamento.pausas ? carregamento.pausas.reduce((total, pausa) => {
            return total + ((pausa.fim || carregamento.fim) - pausa.inicio);
        }, 0) / 60000 : 0;

        // Encontra o funcionário principal (primeiro a entrar)
        let funcionarioPrincipal = 'N/A';
        if (carregamento.participantes) {
            const participantes = Object.entries(carregamento.participantes)
                .map(([id, p]) => ({ id, nome: p.nome || id, entrada: p.entrada }));
            
            participantes.sort((a, b) => a.entrada - b.entrada);
            if (participantes.length > 0) {
                funcionarioPrincipal = participantes[0].nome;
            }
        }

        // Adiciona informações específicas para descarregamento
        let infoAdicional = '';
        if (carregamento.tipoOperacao === 'descarregamento') {
            infoAdicional = carregamento.tipoDescarregamento === 'erro_operacional' ?
                `Erro: ${carregamento.motivoErro || 'N/A'}` :
                'Transferência';
        }

        historicoHtml += `
            <tr>
                <td>${inicio.toLocaleDateString()}</td>
                <td>${carregamento.placa || 'N/A'}</td>
                <td>${funcionarioPrincipal}</td>
                <td>${inicio.toLocaleTimeString()}</td>
                <td>${fim ? fim.toLocaleTimeString() : 'N/A'}</td>
                <td>${tempoTotalCarregamento}</td>
                <td>${carregamento.doca || 'N/A'}</td>
                <td>${carregamento.armagens ? carregamento.armagens.join(', ') : 'N/A'}</td>
                <td>${carregamento.mixMaterial || 'N/A'}</td>
                <td>${carregamento.toneladas || 'N/A'}</td>
                <td>${tempoPausado.toFixed(2)} min</td>
                <td>${infoAdicional}</td>
            </tr>
        `;
    });

    document.getElementById('tabelaHistorico').innerHTML = historicoHtml;
}

        // Login/Seleção de Unidade
        document.getElementById('btnLogin').addEventListener('click', function() {
            const unidade = document.getElementById('unidade').value;
            const senha = document.getElementById('senha').value;

            if (!unidade || !senha) {
                document.getElementById('loginError').textContent = 'Preencha a unidade e a senha!';
                document.getElementById('loginError').classList.remove('d-none');
                return;
            }

            // Verifica a senha (simplificado para exemplo)
            if (senha === '123456') { // Substitua por sua lógica de autenticação
                unidadeAtual = unidade;
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                document.getElementById('loginError').classList.add('d-none');
            } else {
                document.getElementById('loginError').textContent = 'Senha incorreta!';
                document.getElementById('loginError').classList.remove('d-none');
            }
        });

        // Botão de logout
        document.getElementById('btnLogout').addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.href = "index.html";
            });
        });

        // Verifica autenticação
        auth.onAuthStateChanged((user) => {
            if (!user) {
                // Mostra a tela de login/unidade
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('mainContainer').style.display = 'none';
            } else {
                // Se já autenticado, mostra a tela de seleção de unidade
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('mainContainer').style.display = 'none';
            }
        });
    </script>
</body>
</html>
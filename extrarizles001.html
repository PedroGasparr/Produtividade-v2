<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Arquivos HTML com Firebase</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 900px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #4fc3f7;
        }
        
        .subtitle {
            color: #b3e5fc;
            margin-bottom: 20px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        h2 {
            color: #4fc3f7;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        h2 i {
            margin-right: 10px;
        }
        
        .status {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-active {
            background-color: #4caf50;
            box-shadow: 0 0 10px #4caf50;
        }
        
        .status-inactive {
            background-color: #f44336;
        }
        
        .timer {
            font-size: 1.2rem;
            margin: 10px 0;
            text-align: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        
        .time {
            font-weight: bold;
            color: #4fc3f7;
        }
        
        .btn {
            background: #0288d1;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin: 10px 5px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .btn:hover {
            background: #039be5;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .btn-upload {
            background: #0277bd;
        }
        
        .btn-stop {
            background: #d32f2f;
        }
        
        .btn-stop:hover {
            background: #f44336;
        }
        
        .btn-login {
            background: #388e3c;
        }
        
        .btn-logout {
            background: #7b1fa2;
        }
        
        .instructions {
            margin-top: 20px;
        }
        
        .instructions ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        .instructions li {
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .file-input {
            margin: 15px 0;
            display: flex;
            flex-direction: column;
        }
        
        .file-input label {
            margin-bottom: 10px;
            color: #b3e5fc;
        }
        
        .log {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .log-time {
            color: #4fc3f7;
            margin-right: 10px;
        }
        
        .log-success {
            color: #a5d6a7;
        }
        
        .log-error {
            color: #ef9a9a;
        }
        
        .log-info {
            color: #90caf9;
        }
        
        .firebase-config {
            margin-top: 20px;
        }
        
        textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            color: white;
            margin-top: 10px;
            resize: vertical;
            min-height: 100px;
        }
        
        .btn-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            background: #4fc3f7;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .selected-files {
            margin-top: 15px;
        }
        
        .file-list {
            list-style: none;
            margin-top: 10px;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            margin-bottom: 5px;
        }
        
        .file-name {
            flex-grow: 1;
        }
        
        .file-unit {
            background: rgba(79, 195, 247, 0.2);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        
        .login-container {
            text-align: center;
            padding: 20px;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #b3e5fc;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
            color: white;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
            }
            
            .btn-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="app-container">
        <header>
            <h1>Monitor de Arquivos HTML com Firebase</h1>
            <p class="subtitle">Monitoramento autom√°tico a cada 5 minutos</p>
        </header>
        
        <div class="card" id="login-card">
            <h2><i>üîê</i> Login</h2>
            <div class="login-container">
                <div class="login-form">
                    <div class="form-group">
                        <label for="email">E-mail:</label>
                        <input type="email" id="email" placeholder="Seu e-mail">
                    </div>
                    <div class="form-group">
                        <label for="password">Senha:</label>
                        <input type="password" id="password" placeholder="Sua senha">
                    </div>
                    <button class="btn btn-login" id="login-btn">
                        <i>üîë</i> Fazer Login
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card" id="main-content" style="display: none;">
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">U</div>
                <div>
                    <div id="user-name">Usu√°rio</div>
                    <div id="user-email" style="font-size: 0.8rem; color: #b3e5fc;">user@example.com</div>
                </div>
                <button class="btn btn-logout" id="logout-btn" style="margin-left: auto;">
                    <i>üö™</i> Sair
                </button>
            </div>
            
            <h2><i>üìä</i> Status do Sistema</h2>
            <div class="status">
                <div class="status-indicator status-inactive" id="status-indicator"></div>
                <span id="status-text">Monitoramento inativo</span>
            </div>
            <div class="timer">
                Pr√≥xima atualiza√ß√£o em: <span class="time" id="next-update">5:00</span> minutos
            </div>
        </div>
        
        <div class="card" id="file-card" style="display: none;">
            <h2><i>üìÅ</i> Selecione os Arquivos</h2>
            <div class="file-input">
                <label for="file-selector">Selecione os arquivos HTML para monitorar (m√∫ltiplos):</label>
                <input type="file" id="file-selector" accept=".html" multiple>
            </div>
            
            <div class="selected-files" id="selected-files" style="display: none;">
                <h3>Arquivos Selecionados:</h3>
                <ul class="file-list" id="file-list"></ul>
            </div>
        </div>
        
        <div class="card" id="controls-card" style="display: none;">
            <h2><i>‚öôÔ∏è</i> Controles</h2>
            <div class="btn-container">
                <button class="btn btn-upload" id="upload-now">
                    <i>üì§</i> Upload Agora
                </button>
                <button class="btn" id="start-monitoring">
                    <i>‚ñ∂Ô∏è</i> Iniciar Monitoramento
                </button>
                <button class="btn btn-stop" id="stop-monitoring">
                    <i>‚èπÔ∏è</i> Parar Monitoramento
                </button>
            </div>
        </div>
        
        <div class="card" id="log-card" style="display: none;">
            <h2><i>üìù</i> Log de Atividades</h2>
            <div class="log" id="activity-log">
                <div class="log-entry">
                    <span class="log-time">[00:00:00]</span>
                    <span class="log-info">Sistema inicializado. Fa√ßa login para come√ßar.</span>
                </div>
            </div>
        </div>
        
        <div class="card instructions" id="instructions-card" style="display: none;">
            <h2><i>‚ùì</i> Como usar</h2>
            <ol>
                <li>Fa√ßa login com sua conta</li>
                <li>Selecione os arquivos HTML que deseja monitorar (m√∫ltiplos)</li>
                <li>Clique em "Iniciar Monitoramento" para come√ßar</li>
                <li>O sistema far√° uploads autom√°ticos a cada 5 minutos</li>
                <li>Voc√™ tamb√©m pode fazer upload manualmente a qualquer momento</li>
            </ol>
            <p><strong>Nota:</strong> Esta p√°gina precisa permanecer aberta para o monitoramento funcionar.</p>
        </div>
    </div>

    <!-- Firebase App (o SDK core do Firebase) √© sempre necess√°rio -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <!-- Firebase Authentication -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <!-- Cloud Firestore -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCMu17OV-5ST1rlg00zbpt6Hv37GKqkX4A",
            authDomain: "projetos-d868d.firebaseapp.com",
            databaseURL: "https://projetos-d868d-default-rtdb.firebaseio.com",
            projectId: "projetos-d868d",
            storageBucket: "projetos-d868d.firebasestorage.app",
            messagingSenderId: "420029352781",
            appId: "1:420029352781:web:05176699348e0ccdd78504",
            measurementId: "G-FXWXRX04WF"
        };
        
        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Vari√°veis globais
        let selectedFiles = [];
        let monitoringInterval = null;
        let timeLeft = 300; // 5 minutos em segundos
        
        // Elementos da UI
        const loginCard = document.getElementById('login-card');
        const mainContent = document.getElementById('main-content');
        const fileCard = document.getElementById('file-card');
        const controlsCard = document.getElementById('controls-card');
        const logCard = document.getElementById('log-card');
        const instructionsCard = document.getElementById('instructions-card');
        
        const fileSelector = document.getElementById('file-selector');
        const uploadNowBtn = document.getElementById('upload-now');
        const startMonitoringBtn = document.getElementById('start-monitoring');
        const stopMonitoringBtn = document.getElementById('stop-monitoring');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        
        const nextUpdateEl = document.getElementById('next-update');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const activityLog = document.getElementById('activity-log');
        const selectedFilesContainer = document.getElementById('selected-files');
        const fileList = document.getElementById('file-list');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const userEmail = document.getElementById('user-email');
        
        // Inicializa√ß√£o
        updateTimerDisplay();
        
        // Event Listeners
        fileSelector.addEventListener('change', handleFileSelect);
        uploadNowBtn.addEventListener('click', uploadFiles);
        startMonitoringBtn.addEventListener('click', startMonitoring);
        stopMonitoringBtn.addEventListener('click', stopMonitoring);
        loginBtn.addEventListener('click', loginUser);
        logoutBtn.addEventListener('click', logoutUser);
        
        // Verificar se usu√°rio j√° est√° logado
        auth.onAuthStateChanged(user => {
            if (user) {
                showAppContent(user);
                addLogEntry(`Usu√°rio autenticado: ${user.email}`, 'success');
            } else {
                showLoginForm();
                addLogEntry('Usu√°rio n√£o autenticado. Fa√ßa login para continuar.', 'info');
            }
        });
        
        // Fun√ß√£o para lidar com a sele√ß√£o de arquivos
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            selectedFiles = [];
            fileList.innerHTML = '';
            
            files.forEach(file => {
                if (file.name.endsWith('.html')) {
                    selectedFiles.push(file);
                    
                    // Extrair nome da unidade do nome do arquivo
                    const unitName = extractUnitName(file.name);
                    
                    // Adicionar √† lista de arquivos selecionados
                    const listItem = document.createElement('li');
                    listItem.className = 'file-item';
                    listItem.innerHTML = `
                        <span class="file-name">${file.name}</span>
                        <span class="file-unit">${unitName}</span>
                    `;
                    fileList.appendChild(listItem);
                }
            });
            
            if (selectedFiles.length > 0) {
                selectedFilesContainer.style.display = 'block';
                addLogEntry(`${selectedFiles.length} arquivo(s) HTML selecionado(s).`, 'success');
            } else {
                selectedFilesContainer.style.display = 'none';
                addLogEntry('Nenhum arquivo HTML v√°lido selecionado.', 'error');
            }
        }
        
        // Fun√ß√£o para extrair nome da unidade do nome do arquivo
        function extractUnitName(fileName) {
            // Remove a extens√£o .html
            const nameWithoutExt = fileName.replace('.html', '');
            
            // Tenta encontrar padr√µes comuns de nomenclatura de unidades
            const patterns = [
                /unidade\s*([^-_]+)/i,
                /uni\s*([^-_]+)/i,
                /u\.?\s*([^-_]+)/i,
                /([^-_]+)\s*unidade/i,
                /([^-_]+)\s*uni/i
            ];
            
            for (const pattern of patterns) {
                const match = nameWithoutExt.match(pattern);
                if (match && match[1]) {
                    return `Unidade ${match[1].trim()}`;
                }
            }
            
            // Se n√£o encontrar padr√£o, usa o nome do arquivo sem extens√£o
            return nameWithoutExt;
        }
        
        // Fun√ß√£o para fazer upload dos arquivos
        async function uploadFiles() {
            if (selectedFiles.length === 0) {
                addLogEntry('Nenhum arquivo selecionado.', 'error');
                return;
            }
            
            const user = auth.currentUser;
            if (!user) {
                addLogEntry('Usu√°rio n√£o autenticado.', 'error');
                return;
            }
            
            try {
                addLogEntry(`Iniciando upload de ${selectedFiles.length} arquivo(s)...`, 'info');
                
                for (const file of selectedFiles) {
                    const unitName = extractUnitName(file.name);
                    
                    // Ler conte√∫do do arquivo
                    const fileContent = await readFileContent(file);
                    
                    // Salvar no Firestore
                    await db.collection('zles001').doc(file.name).set({
                        fileName: file.name,
                        unit: unitName,
                        content: fileContent,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: user.uid
                    });
                    
                    addLogEntry(`Arquivo "${file.name}" enviado com sucesso para a ${unitName}.`, 'success');
                }
                
                addLogEntry('Todos os arquivos foram enviados com sucesso!', 'success');
            } catch (error) {
                addLogEntry(`Erro no upload: ${error.message}`, 'error');
                console.error('Erro no upload:', error);
            }
        }
        
        // Fun√ß√£o para ler conte√∫do do arquivo
        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = event => {
                    resolve(event.target.result);
                };
                
                reader.onerror = error => {
                    reject(error);
                };
                
                reader.readAsText(file);
            });
        }
        
        // Fun√ß√£o para iniciar o monitoramento
        function startMonitoring() {
            if (selectedFiles.length === 0) {
                addLogEntry('Selecione os arquivos antes de iniciar o monitoramento.', 'error');
                return;
            }
            
            if (monitoringInterval) {
                addLogEntry('O monitoramento j√° est√° em execu√ß√£o.', 'info');
                return;
            }
            
            // Fazer upload imediato
            uploadFiles();
            
            // Iniciar intervalo de monitoramento
            monitoringInterval = setInterval(() => {
                uploadFiles();
                timeLeft = 300; // Reset do timer
            }, 300000); // 5 minutos
            
            // Atualizar contador regressivo
            const countdownInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    timeLeft = 300;
                }
                
                // Se o monitoramento foi parado, limpar o intervalo
                if (!monitoringInterval) {
                    clearInterval(countdownInterval);
                }
            }, 1000);
            
            // Atualizar UI
            statusIndicator.className = 'status-indicator status-active';
            statusText.textContent = 'Monitoramento ativo';
            addLogEntry('Monitoramento iniciado. Uploads autom√°ticos a cada 5 minutos.', 'success');
        }
        
        // Fun√ß√£o para parar o monitoramento
        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                
                // Atualizar UI
                statusIndicator.className = 'status-indicator status-inactive';
                statusText.textContent = 'Monitoramento inativo';
                addLogEntry('Monitoramento parado.', 'info');
            } else {
                addLogEntry('O monitoramento n√£o est√° em execu√ß√£o.', 'info');
            }
        }
        
        // Fun√ß√£o para fazer login
        function loginUser() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                addLogEntry('Por favor, preencha e-mail e senha.', 'error');
                return;
            }
            
            auth.signInWithEmailAndPassword(email, password)
                .then(userCredential => {
                    addLogEntry('Login realizado com sucesso!', 'success');
                })
                .catch(error => {
                    addLogEntry(`Erro no login: ${error.message}`, 'error');
                });
        }
        
        // Fun√ß√£o para fazer logout
        function logoutUser() {
            auth.signOut()
                .then(() => {
                    addLogEntry('Logout realizado com sucesso.', 'info');
                    showLoginForm();
                })
                .catch(error => {
                    addLogEntry(`Erro no logout: ${error.message}`, 'error');
                });
        }
        
        // Mostrar conte√∫do do app quando logado
        function showAppContent(user) {
            loginCard.style.display = 'none';
            mainContent.style.display = 'block';
            fileCard.style.display = 'block';
            controlsCard.style.display = 'block';
            logCard.style.display = 'block';
            instructionsCard.style.display = 'block';
            
            // Atualizar informa√ß√µes do usu√°rio
            userName.textContent = user.displayName || user.email;
            userEmail.textContent = user.email;
            userAvatar.textContent = user.email.charAt(0).toUpperCase();
        }
        
        // Mostrar formul√°rio de login
        function showLoginForm() {
            loginCard.style.display = 'block';
            mainContent.style.display = 'none';
            fileCard.style.display = 'none';
            controlsCard.style.display = 'none';
            logCard.style.display = 'none';
            instructionsCard.style.display = 'none';
            
            // Limpar sele√ß√£o de arquivos
            selectedFiles = [];
            fileList.innerHTML = '';
            selectedFilesContainer.style.display = 'none';
            fileSelector.value = '';
            
            // Parar monitoramento se estiver ativo
            if (monitoringInterval) {
                stopMonitoring();
            }
        }
        
        // Fun√ß√£o para atualizar o display do timer
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            nextUpdateEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Fun√ß√£o para adicionar entrada no log
        function addLogEntry(message, type) {
            const now = new Date();
            const timeString = `[${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}]`;
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const timeSpan = document.createElement('span');
            timeSpan.className = 'log-time';
            timeSpan.textContent = timeString;
            
            const messageSpan = document.createElement('span');
            if (type === 'success') {
                messageSpan.className = 'log-success';
            } else if (type === 'error') {
                messageSpan.className = 'log-error';
            } else {
                messageSpan.className = 'log-info';
            }
            messageSpan.textContent = message;
            
            logEntry.appendChild(timeSpan);
            logEntry.appendChild(messageSpan);
            
            activityLog.appendChild(logEntry);
            activityLog.scrollTop = activityLog.scrollHeight;
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exportar CSV de Todas as Unidades</title>
    <!-- Importar Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(to right, #4a6da7, #3a5a8f);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
            text-align: center;
        }

        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
        }

        .loading-spinner-large {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4a6da7;
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
            margin-bottom: 20px;
        }

        .status-text {
            font-size: 18px;
            color: #2c3e50;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .sub-status {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }

        .progress-bar {
            width: 100%;
            max-width: 400px;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            margin: 20px auto;
            overflow: hidden;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #4a6da7, #3a5a8f);
            width: 0%;
            transition: width 0.3s ease;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 5px solid #28a745;
            display: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 5px solid #dc3545;
            display: none;
        }

        .download-info {
            background: #e8f4fc;
            padding: 25px;
            border-radius: 10px;
            margin: 30px 0;
            border-left: 5px solid #007bff;
        }

        .download-info h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .download-info p {
            color: #666;
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .countdown {
            font-size: 24px;
            font-weight: bold;
            color: #4a6da7;
            margin: 20px 0;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #4a6da7;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            background: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                margin: 20px;
            }
            
            .content {
                padding: 25px;
            }
            
            .back-btn {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 20px;
                width: 100%;
                justify-content: center;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <a href="historico.html" class="back-btn">
        <i class="fas fa-arrow-left"></i> Voltar ao Histórico
    </a>

    <div class="container">
        <div class="header">
            <h1>Exportar CSV de Todas as Unidades</h1>
            <p>Exportando dados consolidados de todas as unidades</p>
        </div>

        <div class="content">
            <div class="loading-container" id="loadingContainer">
                <div class="loading-spinner-large"></div>
                <div class="status-text" id="statusText">Verificando autenticação...</div>
                <div class="sub-status" id="subStatus">Por favor, aguarde</div>
                
                <div class="download-info">
                    <h3><i class="fas fa-info-circle"></i> Informações do Download</h3>
                    <p><i class="fas fa-check-circle" style="color: #28a745;"></i> <strong>Todas as unidades:</strong> Dados de todas as unidades serão incluídos</p>
                    <p><i class="fas fa-check-circle" style="color: #28a745;"></i> <strong>Cálculos de tempo:</strong> Tempo total, atrasos e pausas calculados</p>
                    <p><i class="fas fa-check-circle" style="color: #28a745;"></i> <strong>Arquivo único:</strong> Nome fixo: <code>dados_consolidados_completos.csv</code></p>
                    <p><i class="fas fa-check-circle" style="color: #28a745;"></i> <strong>Automático:</strong> O download começará automaticamente</p>
                </div>
                
                <div class="countdown" id="countdown" style="display: none;">
                    Download iniciando em: <span id="countdownNumber">5</span> segundos
                </div>
                
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
            
            <div class="success-message" id="successMessage">
                <i class="fas fa-check-circle"></i> CSV exportado com sucesso! O arquivo foi baixado automaticamente.
            </div>
            
            <div class="error-message" id="errorMessage">
                <i class="fas fa-exclamation-triangle"></i> <span id="errorText">Ocorreu um erro durante a exportação.</span>
            </div>
        </div>
    </div>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCMu17OV-5ST1rlg00zbpt6Hv37GKqkX4A",
            authDomain: "projetos-d868d.firebaseapp.com",
            databaseURL: "https://projetos-d868d-default-rtdb.firebaseio.com",
            projectId: "projetos-d868d",
            storageBucket: "projetos-d868d.firebasestorage.app",
            messagingSenderId: "420029352781",
            appId: "1:420029352781:web:05176699348e0ccdd78504",
            measurementId: "G-FXWXRX04WF"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Elementos da interface
        const statusText = document.getElementById('statusText');
        const subStatus = document.getElementById('subStatus');
        const countdown = document.getElementById('countdown');
        const countdownNumber = document.getElementById('countdownNumber');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        
        // Estado da aplicação
        let currentUser = null;
        let allUnits = [
            "Unidade Maracanau",
            "Unidade Belem",
            "Unidade Mogi Das Cruzes",
            "Unidade Imperatriz",
            "Unidade Cariacica",
            "Unidade Aracruz"
        ];
        let employeesCache = new Map();
        let isExportInProgress = false;

        // Verificar autenticação e iniciar processo
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                statusText.textContent = "Usuário autenticado com sucesso!";
                subStatus.textContent = "Iniciando processo de exportação...";
                
                // Mostrar contagem regressiva
                setTimeout(() => {
                    startAutoDownloadCountdown();
                }, 1000);
            } else {
                // Redirecionar para login
                window.location.href = 'login.html';
            }
        });

        // Iniciar contagem regressiva para download
        function startAutoDownloadCountdown() {
            statusText.textContent = "Preparando download automático...";
            countdown.style.display = 'block';
            
            let seconds = 5;
            const countdownInterval = setInterval(() => {
                countdownNumber.textContent = seconds;
                seconds--;
                
                if (seconds < 0) {
                    clearInterval(countdownInterval);
                    countdown.style.display = 'none';
                    startExportProcess();
                }
            }, 1000);
        }

        // Iniciar processo de exportação
        function startExportProcess() {
            if (isExportInProgress) return;
            
            isExportInProgress = true;
            progressBar.style.display = 'block';
            statusText.textContent = "Iniciando exportação de dados...";
            subStatus.textContent = "Por favor, aguarde. Este processo pode levar alguns minutos.";
            
            exportConsolidatedCSV();
        }

        // Buscar dados de um colaborador específico pelo código
        async function getEmployeeByCode(employeeCode) {
            if (!employeeCode) return { nome: "N/A", codigo: "N/A" };
            
            // Verificar primeiro no cache
            if (employeesCache.has(employeeCode)) {
                return employeesCache.get(employeeCode);
            }
            
            // Se não estiver no cache, buscar no Firestore
            try {
                const querySnapshot = await db.collection('colaboradores')
                    .where('codigo', '==', employeeCode)
                    .limit(1)
                    .get();
                
                if (!querySnapshot.empty) {
                    const doc = querySnapshot.docs[0];
                    const data = doc.data();
                    const employeeData = {
                        nome: data.nome || "N/A",
                        codigo: data.codigo || employeeCode
                    };
                    
                    // Armazenar no cache
                    employeesCache.set(employeeCode, employeeData);
                    return employeeData;
                }
                
                // Se não encontrar, retornar com o código
                return { nome: employeeCode, codigo: employeeCode };
            } catch (error) {
                console.error(`Erro ao buscar colaborador ${employeeCode}:`, error);
                return { nome: employeeCode, codigo: employeeCode };
            }
        }

        // Buscar dados completos de todos os colaboradores adicionais
        async function getAdditionalLoadersData(additionalLoadersArray) {
            if (!additionalLoadersArray || !Array.isArray(additionalLoadersArray) || additionalLoadersArray.length === 0) {
                return [];
            }
            
            const loadersData = [];
            
            for (const loaderCode of additionalLoadersArray) {
                if (loaderCode && typeof loaderCode === 'string') {
                    const employeeData = await getEmployeeByCode(loaderCode);
                    loadersData.push(employeeData);
                }
            }
            
            return loadersData;
        }

        // Função para calcular tempo limite baseado no tipo de operação
        function getTimeLimitByType(operationType) {
            // Tempos em minutos
            const timeLimits = {
                'carregamento': 140,           // 2h 20min
                'carregamento_Paletizado': 60,  // 1h
                'descarga': 140,               // 2h 20min
                'separacao': 90                // 1h 30min
            };
            return timeLimits[operationType] || 120; // Padrão 2h
        }

        // Função para calcular tempo total de pausas
        function calculatePauseTime(operation) {
            let totalPauseTime = 0;
            
            // Se já temos o tempo total de pausa calculado
            if (operation.totalPausedTime) {
                totalPauseTime = operation.totalPausedTime; // Já está em milissegundos
            }
            
            // Se a operação está atualmente pausada, adicionar tempo desde o início da pausa
            if (operation.status === 'paused' && operation.pausedTime) {
                const pausedTime = operation.pausedTime.toDate();
                const now = new Date();
                totalPauseTime += (now - pausedTime);
            }
            
            // Converter de milissegundos para minutos
            return Math.round(totalPauseTime / (1000 * 60));
        }

        // Função para calcular tempo real de operação (excluindo pausas)
        function calculateRealOperationTime(operation) {
            if (!operation.startTime) return 0;
            
            const startTime = operation.startTime.toDate();
            const endTime = operation.endTime ? operation.endTime.toDate() : new Date();
            const totalTimeMs = endTime - startTime;
            const pauseTimeMs = (operation.calculatedData?.pauseTime || calculatePauseTime(operation)) * 60 * 1000;
            
            return Math.round((totalTimeMs - pauseTimeMs) / (1000 * 60)); // Retornar em minutos
        }

        // Função para calcular tempo total bruto (incluindo pausas)
        function calculateTotalTime(operation) {
            if (!operation.startTime) return 0;
            
            const startTime = operation.startTime.toDate();
            const endTime = operation.endTime ? operation.endTime.toDate() : new Date();
            return Math.round((endTime - startTime) / (1000 * 60)); // minutos
        }

        // Função para calcular atraso
        function calculateDelayTime(operation) {
            const timeLimit = getTimeLimitByType(operation.type);
            const realOperationTime = calculateRealOperationTime(operation);
            
            if (realOperationTime > timeLimit) {
                return realOperationTime - timeLimit;
            }
            return 0;
        }

        // Função para calcular eficiência
        function calculateEfficiency(operation) {
            const timeLimit = getTimeLimitByType(operation.type);
            const realOperationTime = calculateRealOperationTime(operation);
            
            if (realOperationTime > 0 && timeLimit > 0) {
                return Math.round((timeLimit / realOperationTime) * 100);
            }
            return 0;
        }

        // Exportar CSV consolidado - TODOS OS DADOS, SEM FILTRO
        async function exportConsolidatedCSV() {
            try {
                // Atualizar status
                statusText.textContent = "Coletando dados de todas as unidades...";
                progressFill.style.width = '0%';
                
                // Coletar dados de TODAS as unidades
                const allOperations = [];
                let totalDocuments = 0;
                let processedDocuments = 0;
                
                // Primeiro, contar documentos totais para progresso mais preciso
                for (let i = 0; i < allUnits.length; i++) {
                    const unit = allUnits[i];
                    subStatus.textContent = `Contando documentos de ${unit}... (${i + 1}/${allUnits.length})`;
                    
                    try {
                        const countSnapshot = await db.collection('operations')
                            .where('unit', '==', unit)
                            .count()
                            .get();
                        
                        totalDocuments += countSnapshot.data().count;
                    } catch (error) {
                        console.error(`Erro ao contar documentos de ${unit}:`, error);
                    }
                }
                
                statusText.textContent = `Processando ${totalDocuments} documentos...`;
                
                // Agora buscar os dados
                for (let i = 0; i < allUnits.length; i++) {
                    const unit = allUnits[i];
                    subStatus.textContent = `Coletando dados de ${unit}... (${i + 1}/${allUnits.length})`;
                    
                    try {
                        const querySnapshot = await db.collection('operations')
                            .where('unit', '==', unit)
                            .get();
                        
                        const unitOperations = [];
                        
                        for (const doc of querySnapshot.docs) {
                            const data = doc.data();
                            
                            // Buscar dados dos colaboradores adicionais
                            let additionalLoadersData = [];
                            if (data.additionalLoaders && Array.isArray(data.additionalLoaders) && data.additionalLoaders.length > 0) {
                                additionalLoadersData = await getAdditionalLoadersData(data.additionalLoaders);
                            }
                            
                            // Calcular todos os tempos
                            const totalTime = calculateTotalTime(data);
                            const pauseTime = calculatePauseTime(data);
                            const realOperationTime = calculateRealOperationTime(data);
                            const delayTime = calculateDelayTime(data);
                            const timeLimit = getTimeLimitByType(data.type);
                            const efficiency = calculateEfficiency(data);
                            
                            unitOperations.push({
                                ...data,
                                id: doc.id,
                                additionalLoadersData: additionalLoadersData,
                                calculatedData: {
                                    totalTime: totalTime,
                                    pauseTime: pauseTime,
                                    realOperationTime: realOperationTime,
                                    delayTime: delayTime,
                                    timeLimit: timeLimit,
                                    efficiency: efficiency
                                }
                            });
                            
                            processedDocuments++;
                            // Atualizar progresso
                            if (totalDocuments > 0) {
                                const progressPercent = Math.round((processedDocuments / totalDocuments) * 100);
                                progressFill.style.width = `${progressPercent}%`;
                            }
                        }
                        
                        allOperations.push(...unitOperations);
                    } catch (error) {
                        console.error(`Erro ao carregar dados de ${unit}:`, error);
                        subStatus.textContent = `Erro em ${unit}, continuando com outras unidades...`;
                    }
                }
                
                if (allOperations.length === 0) {
                    throw new Error("Nenhum dado encontrado para exportação.");
                }
                
                // Atualizar status final
                progressFill.style.width = '100%';
                statusText.textContent = "Gerando arquivo CSV...";
                subStatus.textContent = `Processando ${allOperations.length} registros...`;
                
                // Gerar CSV
                generateConsolidatedCSV(allOperations);
                
                // Mostrar mensagem de sucesso
                setTimeout(() => {
                    statusText.textContent = "Exportação concluída com sucesso!";
                    subStatus.textContent = `${allOperations.length} registros exportados.`;
                    successMessage.style.display = 'block';
                    progressBar.style.display = 'none';
                    isExportInProgress = false;
                }, 1000);
                
            } catch (error) {
                console.error("Erro durante a exportação:", error);
                showError(error.message || "Erro desconhecido durante a exportação.");
                isExportInProgress = false;
            }
        }

        // Gerar CSV consolidado - MANTENDO TODAS AS COLUNAS ORIGINAIS E ADICIONANDO NOVAS
        function generateConsolidatedCSV(operations) {
            // Definir cabeçalhos - mantendo os originais e adicionando novos
            const headers = [
                'ID',
                'Data/Hora Início',
                'Data/Hora Fim',
                'Colaborador Principal',
                'Colaborador Principal Código',
                'Outros Colaboradores (Códigos)',
                'Outros Colaboradores (Nomes)',
                'Tipo de Operação',
                'Status',
                'Doca',
                'Número DT',
                'Toneladas',
                'Mix de Material',
                'Tipo de Veículo',
                'Tempo Total (min)',                      // COLUNA ORIGINAL MANTIDA
                'Observações',
                'Motivo de Pausa',
                'Motivo do Atraso (>10min)',
                'Armazéns Utilizados',
                'Composição',
                'Carro Mantido em Doca',
                'Unidade',
                'Data de Criação',
                'Criado Por',
                'Completado Por',
                'ID Carro em Doca',
                // NOVAS COLUNAS ADICIONADAS
                'Tempo Limite Previsto (min)',
                'Tempo Real de Operação (min)',
                'Tempo Total de Pausas (min)',
                'Tempo de Atraso (min)',
                'Percentual de Atraso (%)',
                'Eficiência (%)'
            ];
            
            // Preparar dados
            const csvData = operations.map(operation => {
                const start = operation.startTime ? operation.startTime.toDate() : new Date(0);
                const end = operation.endTime ? operation.endTime.toDate() : new Date(0);
                const startStr = start.toLocaleString('pt-BR');
                const endStr = end > new Date(0) ? end.toLocaleString('pt-BR') : 'Em andamento';
                
                // Formatar tipo
                const typeMap = {
                    'carregamento': 'Carregamento',
                    'carregamento_Paletizado': 'Carregamento Paletizado',
                    'descarga': 'Descarga',
                    'separacao': 'Separação'
                };
                const formattedType = typeMap[operation.type] || operation.type;
                
                // Formatar status
                const statusMap = {
                    'completed': 'Concluído',
                    'active': 'Em Andamento',
                    'paused': 'Pausado'
                };
                const formattedStatus = statusMap[operation.status] || operation.status;
                
                // Calcular tempo total em minutos (coluna original)
                let totalMinutes = 0;
                if (operation.startTime && operation.endTime) {
                    const startDate = operation.startTime.toDate();
                    const endDate = operation.endTime.toDate();
                    totalMinutes = Math.round((endDate - startDate) / (1000 * 60));
                }
                
                // Dados calculados
                const timeLimit = operation.calculatedData?.timeLimit || getTimeLimitByType(operation.type);
                const pauseTime = operation.calculatedData?.pauseTime || 0;
                const realOperationTime = operation.calculatedData?.realOperationTime || calculateRealOperationTime(operation);
                const delayTime = operation.calculatedData?.delayTime || 0;
                const efficiency = operation.calculatedData?.efficiency || 0;
                
                // Calcular percentual de atraso
                let delayPercentage = 0;
                if (delayTime > 0 && timeLimit > 0) {
                    delayPercentage = Math.round((delayTime / timeLimit) * 100);
                }
                
                // Formatar lista de armazéns
                const warehouses = operation.warehouses ? 
                    operation.warehouses.join('; ') : 
                    'N/A';
                
                // Dados do colaborador principal
                const mainEmployeeName = operation.employeeName || operation.employeeCode || 'N/A';
                
                // Dados dos colaboradores adicionais
                const additionalCodes = operation.additionalLoaders ? 
                    operation.additionalLoaders.join('; ') : 
                    'Nenhum';
                
                const additionalNames = operation.additionalLoadersData && operation.additionalLoadersData.length > 0 ?
                    operation.additionalLoadersData.map(emp => emp.nome || emp.codigo || 'N/A').join('; ') :
                    'Nenhum';
                
                // Data de criação
                const createdAt = operation.createdAt ? 
                    operation.createdAt.toDate().toLocaleString('pt-BR') : 
                    'N/A';
                
                // Verificar se há atraso no início da operação (delayReason)
                const inicioAtraso = operation.delayReason ? 'Sim' : 'Não';
                
                return [
                    // COLUNAS ORIGINAIS (mantidas na ordem original)
                    operation.id,
                    `"${startStr}"`,
                    `"${endStr}"`,
                    `"${mainEmployeeName}"`,
                    operation.employeeCode || 'N/A',
                    `"${additionalCodes}"`,
                    `"${additionalNames}"`,
                    formattedType,
                    formattedStatus,
                    operation.dock || 'N/A',
                    operation.dockNumber || 'N/A',
                    operation.tonsLoaded || '0',
                    operation.materialMix || '0',
                    operation.vehicleType || 'N/A',
                    totalMinutes,  // Tempo Total (min) - COLUNA ORIGINAL
                    `"${operation.observation || ''}"`,
                    `"${operation.pauseReason || ''}"`,
                    `"${inicioAtraso}: ${operation.delayReason || ''}"`,
                    `"${warehouses}"`,
                    operation.compositionNumber || 'N/A',
                    operation.keepCarInDock ? 'Sim' : 'Não',
                    operation.unit || 'N/A',
                    `"${createdAt}"`,
                    operation.createdBy || 'N/A',
                    operation.completedBy || 'N/A',
                    operation.carInDockId || 'N/A',
                    // NOVAS COLUNAS ADICIONADAS
                    timeLimit,
                    realOperationTime,
                    pauseTime,
                    delayTime,
                    delayPercentage,
                    efficiency
                ];
            });
            
            // Criar conteúdo CSV
            let csvContent = headers.join(',') + '\n';
            csvData.forEach(row => {
                csvContent += row.join(',') + '\n';
            });
            
            // Criar blob e fazer download
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            // Nome do arquivo FIXO (SEM DATA)
            link.setAttribute('href', url);
            link.setAttribute('download', 'dados_consolidados_completos.csv'); // Nome fixo
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
        }

        // Mostrar erro
        function showError(message) {
            statusText.textContent = "Erro durante a exportação";
            subStatus.textContent = "Tente novamente mais tarde";
            errorText.textContent = message;
            errorMessage.style.display = 'block';
            progressBar.style.display = 'none';
        }
    </script>
</body>
</html>
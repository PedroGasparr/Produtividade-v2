<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle - Sistema de Opera√ß√£o</title>
    <!-- Importar Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <link rel="stylesheet" href="../css/painel_controle.css">
    <style>
        /* Estilos para a se√ß√£o de metas */
        .goals-section {
            background: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            border-left: 4px solid #4a6da7;
        }

        .goals-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .goals-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin: 0;
        }

        .goal-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .goal-card {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
            border-left: 4px solid #4a6da7;
        }

        .goal-card.achieved {
            border-left-color: #4CAF50;
            background: #f1f8e9;
        }

        .goal-card.not-achieved {
            border-left-color: #f44336;
            background: #ffebee;
        }

        .goal-card-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .goal-card-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .goal-progress {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        /* Estilos para os cards de tempo */
        .time-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .time-card {
            background: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #4a6da7;
            transition: transform 0.3s;
        }

        .time-card:hover {
            transform: translateY(-2px);
        }
        
        .time-card h3 {
            margin: 0 0 15px 0;
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .time-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .time-card .sub-value {
            font-size: 14px;
            color: #666;
        }

        /* Cards espec√≠ficos para tipos de opera√ß√£o */
        .time-card.carregamento {
            border-left-color: #4CAF50;
        }

        .time-card.carregamento-paletizado {
            border-left-color: #2196F3;
        }

        .time-card.descarga {
            border-left-color: #FF9800;
        }

        .time-card.separacao {
            border-left-color: #9C27B0;
        }

        @media (max-width: 768px) {
            .goal-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .time-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <span>Prod</span>Plan
            </div>
            
            <ul class="nav-links">
                <li><a href="operacao.html">Opera√ß√£o</a></li>
                <li><a href="cadastrar_funcionario.html">Cadastrar Funcion√°rio</a></li>
                <li><a href="buscar_funcionario.html">Buscar Funcion√°rio</a></li>
                <li><a href="ranking.html">Ranking</a></li>
                <li><a href="painel_controle.html" class="active">Painel de Controle</a></li>
                <li><a href="historico.html">Hist√≥rico</a></li>
            </ul>
            
            <div class="user-section">
                <div class="user-info">
                    <div class="user-name">Carregando...</div>
                    <div class="user-role"></div>
                </div>
                <button class="logout-btn">Sair</button>
            </div>
        </div>
    </nav>
    
    <div class="content">
        <h1 class="page-title">Painel de Controle</h1>
        
        <div class="user-unit-info" id="userUnitInfo">
            Carregando informa√ß√µes da unidade...
        </div>

        <!-- Se√ß√£o de Metas (APENAS EXIBI√á√ÉO) -->
        <div class="goals-section" id="goalsSection">
            <div class="goals-header">
                <h2 class="goals-title">Metas de Produ√ß√£o - Hoje</h2>
            </div>
            
            <div class="goal-cards" id="goalCards">
                <div class="goal-card" id="fixedGoalCard">
                    <div class="goal-card-value" id="fixedGoalValue">150</div>
                    <div class="goal-card-label">Meta Fixa</div>
                </div>
                
                <div class="goal-card" id="dailyGoalCard">
                    <div class="goal-card-value" id="dailyGoalValue">50</div>
                    <div class="goal-card-label">Meta do Dia</div>
                </div>
                
                <div class="goal-card" id="achievedCard">
                    <div class="goal-card-value" id="achievedValue">0</div>
                    <div class="goal-card-label">Realizado Hoje</div>
                </div>
                
                <div class="goal-card" id="progressCard">
                    <div class="goal-card-value" id="progressValue">0%</div>
                    <div class="goal-card-label">Progresso</div>
                </div>
            </div>
            
            <div class="goal-progress" id="goalProgress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="progressText">
                    Meta do dia: <span id="currentDailyGoal">50</span> toneladas | 
                    Realizado: <span id="currentAchieved">0</span> toneladas
                </div>
            </div>
        </div>

        <!-- Cards de Tempo -->
        <div class="time-cards" id="timeCards">
            <div class="time-card">
                <h3>Tempo Total</h3>
                <div class="value" id="totalTime">0h 0min</div>
                <div class="sub-value" id="totalMinutes">0 minutos</div>
            </div>
            
            <div class="time-card">
                <h3>Tempo M√©dio Geral</h3>
                <div class="value" id="avgTime">0h 0min</div>
                <div class="sub-value" id="avgMinutes">0 minutos</div>
            </div>
            
            <div class="time-card">
                <h3>Volume Total Carregado</h3>
                <div class="value" id="totalTons">0</div>
                <div class="sub-value">toneladas</div>
            </div>
            
            <div class="time-card">
                <h3>Total de Mix</h3>
                <div class="value" id="totalMix">0</div>
                <div class="sub-value">tipos de material</div>
            </div>
            
            <div class="time-card">
                <h3>Opera√ß√µes Realizadas</h3>
                <div class="value" id="totalOperations">0</div>
                <div class="sub-value">carregamentos</div>
            </div>

            <!-- Novos cards para tempo m√©dio por tipo de opera√ß√£o -->
            <div class="time-card carregamento">
                <h3>Tempo M√©dio - Carregamento</h3>
                <div class="value" id="avgTimeCarregamento">0h 0min</div>
                <div class="sub-value" id="avgMinutesCarregamento">0 minutos</div>
            </div>
            
            <div class="time-card carregamento-paletizado">
                <h3>Tempo M√©dio - Carreg. Paletizado</h3>
                <div class="value" id="avgTimePaletizado">0h 0min</div>
                <div class="sub-value" id="avgMinutesPaletizado">0 minutos</div>
            </div>
            
            <div class="time-card descarga">
                <h3>Tempo M√©dio - Descarga</h3>
                <div class="value" id="avgTimeDescarga">0h 0min</div>
                <div class="sub-value" id="avgMinutesDescarga">0 minutos</div>
            </div>
            
            <div class="time-card separacao">
                <h3>Tempo M√©dio - Separa√ß√£o</h3>
                <div class="value" id="avgTimeSeparacao">0h 0min</div>
                <div class="sub-value" id="avgMinutesSeparacao">0 minutos</div>
            </div>
        </div>
        
        <div class="dashboard-header">
            <h2>Status das Docas</h2>
            <p>Monitoramento em tempo real das docas de carregamento</p>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color legend-green"></div>
                <span>Normal (dentro do tempo)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-yellow"></div>
                <span>Alerta (faltando 20% do tempo)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-red"></div>
                <span>Cr√≠tico (tempo esgotado)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-gray"></div>
                <span>Pausado</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-blue"></div>
                <span>Carro em Doca (Aguardando)</span>
            </div>
        </div>
        
        <div class="stats-container" id="statsContainer">
            <div class="stat-card">
                <h3>Caminh√µes (Dia)</h3>
                <div class="stat-value" id="trucksDay"></div>
                <div class="stat-meta"><span id="trucksGoalDay"></span></div>
            </div>
            
            <div class="stat-card">
                <h3>Toneladas (Dia)</h3>
                <div class="stat-value" id="tonsDay"></div>
                <div class="stat-meta"><span id="tonsGoalDay"></span></div>
            </div>
            
            <div class="stat-card">
                <h3>Tempo M√©dio (Dia)</h3>
                <div class="stat-value" id="avgTimeDay"></div>
                <div class="stat-meta"><span id="timeLimitDay"></span></div>
            </div>
            
            <div class="stat-card">
                <h3>Mix M√©dio (Dia)</h3>
                <div class="stat-value" id="avgMixDay"></div>
                <div class="stat-meta"></div>
            </div>
        </div>
        
        <div class="docks-container" id="docksContainer">
            <div class="loading">
                <div class="loading-spinner"></div>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCMu17OV-5ST1rlg00zbpt6Hv37GKqkX4A",
            authDomain: "projetos-d868d.firebaseapp.com",
            databaseURL: "https://projetos-d868d-default-rtdb.firebaseio.com",
            projectId: "projetos-d868d",
            storageBucket: "projetos-d868d.firebasestorage.app",
            messagingSenderId: "420029352781",
            appId: "1:420029352781:web:05176699348e0ccdd78504",
            measurementId: "G-FXWXRX04WF"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Elementos da interface
        const userNameElement = document.querySelector('.user-name');
        const userUnitInfo = document.getElementById('userUnitInfo');
        const docksContainer = document.getElementById('docksContainer');
        
        // Elementos da se√ß√£o de metas (APENAS EXIBI√á√ÉO)
        const fixedGoalValue = document.getElementById('fixedGoalValue');
        const dailyGoalValue = document.getElementById('dailyGoalValue');
        const achievedValue = document.getElementById('achievedValue');
        const progressValue = document.getElementById('progressValue');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const currentDailyGoal = document.getElementById('currentDailyGoal');
        const currentAchieved = document.getElementById('currentAchieved');
        
        // Elementos dos cards de tempo
        const totalTimeElement = document.getElementById('totalTime');
        const totalMinutesElement = document.getElementById('totalMinutes');
        const avgTimeElement = document.getElementById('avgTime');
        const avgMinutesElement = document.getElementById('avgMinutes');
        const totalTonsElement = document.getElementById('totalTons');
        const totalMixElement = document.getElementById('totalMix');
        const totalOperationsElement = document.getElementById('totalOperations');
        const avgTimeCarregamentoElement = document.getElementById('avgTimeCarregamento');
        const avgMinutesCarregamentoElement = document.getElementById('avgMinutesCarregamento');
        const avgTimePaletizadoElement = document.getElementById('avgTimePaletizado');
        const avgMinutesPaletizadoElement = document.getElementById('avgMinutesPaletizado');
        const avgTimeDescargaElement = document.getElementById('avgTimeDescarga');
        const avgMinutesDescargaElement = document.getElementById('avgMinutesDescarga');
        const avgTimeSeparacaoElement = document.getElementById('avgTimeSeparacao');
        const avgMinutesSeparacaoElement = document.getElementById('avgMinutesSeparacao');
        
        // Estado da aplica√ß√£o
        let currentUser = null;
        let userData = null;
        let currentUnit = '';
        let operationsData = [];
        let carsInDockData = [];
        let employeesData = [];
        let operationsListener = null;
        let carsInDockListener = null;
        
        // Estado das metas
        let currentGoals = null;
        let todayAchieved = 0;
        
        // Tempos limite por tipo de opera√ß√£o (em minutos)
        const timeLimits = {
            'carregamento': 140,        // 2h 20min
            'carregamento_Paletizado': 60, // 1h
            'descarga': 90,             // 1h 30min
            'separacao': 40             // 40min
        };
        
        // Verificar autentica√ß√£o
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                userNameElement.textContent = 'Carregando...';
                
                // Buscar dados do usu√°rio no Firestore
                db.collection('users').doc(user.uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        userData = doc.data();
                        userNameElement.textContent = userData.name;
                        currentUnit = userData.unit;
                        userUnitInfo.textContent = `Unidade atual: ${currentUnit}`;
                        
                        // Carregar dados iniciais
                        loadEmployeesData();
                        loadGoals();
                        setupRealtimeListeners();
                    } else {
                        console.error("Documento do usu√°rio n√£o encontrado");
                    }
                })
                .catch((error) => {
                    console.error("Erro ao buscar dados do usu√°rio:", error);
                });
            } else {
                // Usu√°rio n√£o autenticado, redirecionar para login
                window.location.href = 'login.html';
            }
        });
        
        // Configurar listeners em tempo real
        function setupRealtimeListeners() {
            // Remover listeners anteriores se existirem
            if (operationsListener) {
                operationsListener();
            }
            if (carsInDockListener) {
                carsInDockListener();
            }
            
            // Escutar mudan√ßas em tempo real na cole√ß√£o operations
            operationsListener = db.collection('operations')
                .where('unit', '==', currentUnit)
                .onSnapshot((snapshot) => {
                    operationsData = [];
                    snapshot.forEach((doc) => {
                        operationsData.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Atualizar estat√≠sticas
                    updateStatistics();
                    updateTimeCards();
                    calculateTodayAchieved();
                    
                    // Atualizar docas
                    updateDocks();
                }, (error) => {
                    console.error("Erro em tempo real nas opera√ß√µes:", error);
                });
            
            // Escutar mudan√ßas em tempo real na cole√ß√£o carsInDock
            carsInDockListener = db.collection('carsInDock')
                .where('unit', '==', currentUnit)
                .where('status', 'in', ['available', 'in_use_partial'])
                .onSnapshot((snapshot) => {
                    carsInDockData = [];
                    snapshot.forEach((doc) => {
                        carsInDockData.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Atualizar docas
                    updateDocks();
                }, (error) => {
                    console.error("Erro em tempo real nos carros em doca:", error);
                });
        }
        
        // Carregar dados dos colaboradores
        function loadEmployeesData() {
            db.collection('colaboradores')
                .where('unidade', '==', currentUnit)
                .get()
                .then((querySnapshot) => {
                    employeesData = [];
                    querySnapshot.forEach((doc) => {
                        employeesData.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                })
                .catch((error) => {
                    console.error("Erro ao carregar colaboradores:", error);
                });
        }

        // ========== SISTEMA DE METAS (APENAS EXIBI√á√ÉO) ==========

        // Carregar metas do usu√°rio
        function loadGoals() {
            const today = new Date().toISOString().split('T')[0];
            
            db.collection('daily_goals')
                .where('unit', '==', currentUnit)
                .where('date', '==', today)
                .where('createdBy', '==', currentUser.uid)
                .get()
                .then((querySnapshot) => {
                    if (!querySnapshot.empty) {
                        // J√° existe meta para hoje
                        const doc = querySnapshot.docs[0];
                        currentGoals = {
                            id: doc.id,
                            ...doc.data()
                        };
                        
                        // Atualizar exibi√ß√£o das metas
                        updateGoalsDisplay();
                    } else {
                        // Usar metas padr√£o se n√£o existir
                        currentGoals = {
                            fixedGoal: 150,
                            dailyGoal: 50
                        };
                        updateGoalsDisplay();
                    }
                })
                .catch((error) => {
                    console.error("Erro ao carregar metas:", error);
                    // Usar metas padr√£o em caso de erro
                    currentGoals = {
                        fixedGoal: 150,
                        dailyGoal: 50
                    };
                    updateGoalsDisplay();
                });
        }

        // Calcular toneladas realizadas hoje
        function calculateTodayAchieved() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            // Filtrar opera√ß√µes completadas hoje
            const todayOperations = operationsData.filter(op => {
                if (op.status !== 'completed' || !op.endTime) return false;
                
                const opDate = op.endTime.toDate();
                return opDate >= today && opDate < tomorrow;
            });
            
            // Somar toneladas
            todayAchieved = todayOperations.reduce((sum, op) => sum + (op.tonsLoaded || 0), 0);
            
            // Atualizar interface
            updateGoalsDisplay();
        }

        // Atualizar exibi√ß√£o das metas
        function updateGoalsDisplay() {
            if (!currentGoals) return;
            
            const fixedGoal = currentGoals.fixedGoal || 150;
            const dailyGoal = currentGoals.dailyGoal || 50;
            const progress = dailyGoal > 0 ? (todayAchieved / dailyGoal) * 100 : 0;
            const isAchieved = todayAchieved >= dailyGoal;
            
            // Atualizar valores
            fixedGoalValue.textContent = fixedGoal;
            dailyGoalValue.textContent = dailyGoal;
            achievedValue.textContent = todayAchieved.toFixed(1);
            progressValue.textContent = `${Math.min(progress, 100).toFixed(1)}%`;
            currentDailyGoal.textContent = dailyGoal;
            currentAchieved.textContent = todayAchieved.toFixed(1);
            
            // Atualizar barra de progresso
            progressFill.style.width = `${Math.min(progress, 100)}%`;
            
            // Atualizar cores dos cards
            fixedGoalCard.className = 'goal-card';
            dailyGoalCard.className = 'goal-card';
            achievedCard.className = isAchieved ? 'goal-card achieved' : 'goal-card not-achieved';
            progressCard.className = isAchieved ? 'goal-card achieved' : 'goal-card not-achieved';
        }
        
        // ========== CARDS DE TEMPO ==========
        
        // Atualizar cards de tempo
        function updateTimeCards() {
            const completedOperations = operationsData.filter(op => op.status === 'completed');
            
            // Calcular totais gerais
            const totalTons = completedOperations.reduce((sum, op) => sum + (op.tonsLoaded || 0), 0);
            const totalMix = completedOperations.reduce((sum, op) => sum + (op.materialMix || 0), 0);
            const totalOperationsCount = completedOperations.length;
            
            // Calcular tempo total e m√©dio geral
            let totalMinutes = 0;
            completedOperations.forEach(op => {
                if (op.startTime && op.endTime) {
                    const start = op.startTime.toDate();
                    const end = op.endTime.toDate();
                    const duration = (end - start) / (1000 * 60); // minutos
                    totalMinutes += duration;
                }
            });
            
            const avgMinutes = totalOperationsCount > 0 ? totalMinutes / totalOperationsCount : 0;
            
            // Atualizar elementos gerais
            totalTonsElement.textContent = totalTons.toFixed(1);
            totalMixElement.textContent = totalMix;
            totalOperationsElement.textContent = totalOperationsCount;
            
            // Formatando tempo geral
            const totalHours = Math.floor(totalMinutes / 60);
            const totalMins = Math.round(totalMinutes % 60);
            totalTimeElement.textContent = `${totalHours}h ${totalMins}min`;
            totalMinutesElement.textContent = `${Math.round(totalMinutes)} minutos`;
            
            const avgHours = Math.floor(avgMinutes / 60);
            const avgMins = Math.round(avgMinutes % 60);
            avgTimeElement.textContent = `${avgHours}h ${avgMins}min`;
            avgMinutesElement.textContent = `${Math.round(avgMinutes)} minutos`;
            
            // Calcular tempo m√©dio por tipo de opera√ß√£o
            calculateAverageTimeByType(completedOperations);
        }
        
        // Calcular tempo m√©dio por tipo de opera√ß√£o
        function calculateAverageTimeByType(completedOperations) {
            const types = {
                'carregamento': { totalMinutes: 0, count: 0 },
                'carregamento_Paletizado': { totalMinutes: 0, count: 0 },
                'descarga': { totalMinutes: 0, count: 0 },
                'separacao': { totalMinutes: 0, count: 0 }
            };
            
            // Calcular tempo total para cada tipo
            completedOperations.forEach(op => {
                if (op.startTime && op.endTime && types[op.type]) {
                    const start = op.startTime.toDate();
                    const end = op.endTime.toDate();
                    const duration = (end - start) / (1000 * 60); // minutos
                    
                    types[op.type].totalMinutes += duration;
                    types[op.type].count += 1;
                }
            });
            
            // Atualizar cards para cada tipo
            updateTypeCard('carregamento', types.carregamento, avgTimeCarregamentoElement, avgMinutesCarregamentoElement);
            updateTypeCard('carregamento_Paletizado', types.carregamento_Paletizado, avgTimePaletizadoElement, avgMinutesPaletizadoElement);
            updateTypeCard('descarga', types.descarga, avgTimeDescargaElement, avgMinutesDescargaElement);
            updateTypeCard('separacao', types.separacao, avgTimeSeparacaoElement, avgMinutesSeparacaoElement);
        }
        
        // Atualizar card individual de tipo
        function updateTypeCard(typeName, typeData, timeElement, minutesElement) {
            const avgMinutes = typeData.count > 0 ? typeData.totalMinutes / typeData.count : 0;
            const avgHours = Math.floor(avgMinutes / 60);
            const avgMins = Math.round(avgMinutes % 60);
            
            timeElement.textContent = `${avgHours}h ${avgMins}min`;
            minutesElement.textContent = `${Math.round(avgMinutes)} minutos (${typeData.count} ops)`;
        }
        
        // Atualizar estat√≠sticas
        function updateStatistics() {
            // Filtrar opera√ß√µes do dia
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const todayOperations = operationsData.filter(op => {
                const opDate = op.createdAt ? op.createdAt.toDate() : new Date(0);
                return opDate >= today;
            });
            
            // Calcular estat√≠sticas do dia
            const trucksDay = todayOperations.length;
            const tonsDay = todayOperations.reduce((sum, op) => sum + (op.tonsLoaded || 0), 0);
            
            // Calcular tempo m√©dio do dia
            const totalTimeDay = todayOperations.reduce((sum, op) => {
                if (op.startTime && op.endTime) {
                    const start = op.startTime.toDate();
                    const end = op.endTime.toDate();
                    return sum + (end - start);
                }
                return sum;
            }, 0);
            
            const avgTimeDay = trucksDay > 0 ? totalTimeDay / (trucksDay * 60000) : 0; // em minutos
            
            // Calcular mix m√©dio do dia
            const avgMixDay = trucksDay > 0 ? tonsDay / trucksDay : 0;
            
            // Atualizar interface
            document.getElementById('trucksDay').textContent = trucksDay;
            document.getElementById('tonsDay').textContent = tonsDay.toFixed(1);
            document.getElementById('avgTimeDay').textContent = formatTime(avgTimeDay);
            document.getElementById('avgMixDay').textContent = avgMixDay.toFixed(1);
        }
        
        // Atualizar docas
        function updateDocks() {
            // Mapear todas as docas ocupadas (por opera√ß√µes e por carros em doca)
            const occupiedDocks = new Map();
            
            // Processar opera√ß√µes ativas
            operationsData.forEach(op => {
                if (op.status !== 'completed') {
                    const dockNumber = op.dock || op.dockNumber;
                    if (dockNumber) {
                        occupiedDocks.set(dockNumber, {
                            type: 'operation',
                            data: op
                        });
                    }
                }
            });
            
            // Processar carros em doca que n√£o est√£o em opera√ß√£o
            carsInDockData.forEach(car => {
                // Verificar se o carro n√£o est√° sendo usado em opera√ß√£o
                const isCarInOperation = operationsData.some(op => 
                    op.carInDockId === car.id && op.status !== 'completed'
                );
                
                if (!isCarInOperation) {
                    // Adicionar doca principal
                    if (car.dock) {
                        occupiedDocks.set(car.dock, {
                            type: 'car_in_dock',
                            data: car
                        });
                    }
                    
                    // Adicionar docas das composi√ß√µes se houver
                    if (car.compositionDocks) {
                        Object.values(car.compositionDocks).forEach(compositionDock => {
                            occupiedDocks.set(compositionDock, {
                                type: 'car_in_dock',
                                data: car
                            });
                        });
                    }
                }
            });
            
            // Gerar HTML para as docas
            let docksHTML = '';
            
            // Docas ocupadas
            for (const [dockNumber, dockInfo] of occupiedDocks) {
                if (dockInfo.type === 'operation') {
                    docksHTML += generateDockCard(dockNumber, dockInfo.data);
                } else if (dockInfo.type === 'car_in_dock') {
                    docksHTML += generateCarInDockCard(dockNumber, dockInfo.data);
                }
            }
            
            // Docas livres (de 1 a 11)
            for (let i = 1; i <= 11; i++) {
                if (!occupiedDocks.has(i.toString())) {
                    docksHTML += `
                        <div class="dock-card">
                            <div class="dock-header">
                                <div class="dock-name">Doca ${i}</div>
                                <div class="dock-status status-free">Livre üöõ</div>
                            </div>
                        </div>
                    `;
                }
            }
            
            docksContainer.innerHTML = docksHTML;
            
            // Iniciar atualiza√ß√£o em tempo real para as docas ocupadas
            startRealtimeUpdates();
        }
        
        // Gerar card para doca ocupada por opera√ß√£o
        function generateDockCard(dockNumber, operation) {
            const now = new Date();
            const startTime = operation.startTime ? operation.startTime.toDate() : now;
            const elapsedMs = now - startTime;
            const elapsedMins = Math.floor(elapsedMs / 60000);
            
            // Obter tempo limite baseado no tipo de opera√ß√£o
            const timeLimit = timeLimits[operation.type] || 140; // Padr√£o 140min se n√£o encontrado
            const remainingMins = timeLimit - elapsedMins;
            const warningThreshold = Math.floor(timeLimit * 0.2); // 20% do tempo restante para alerta
            
            // Determinar status da doca
            let statusClass = '';
            let statusText = '';
            let statusType = '';
            
            if (operation.status === 'paused') {
                statusClass = 'paused';
                statusText = 'Pausado';
                statusType = 'status-paused';
            } else if (remainingMins <= 0) {
                statusClass = 'danger';
                statusText = 'Estourado';
                statusType = 'status-danger';
            } else if (remainingMins <= warningThreshold) {
                statusClass = 'warning';
                statusText = 'Alerta';
                statusType = 'status-warning';
            } else {
                statusClass = '';
                statusText = 'Ocupada üööüí®';
                statusType = 'status-busy';
            }
            
            // Encontrar nome do colaborador principal
            let mainEmployeeName = operation.employeeName || 'Carregando...';
            const mainEmployee = employeesData.find(emp => emp.codigo === operation.employeeCode);
            if (mainEmployee) {
                mainEmployeeName = mainEmployee.nome;
            }
            
            // Encontrar nomes dos colaboradores adicionais
            const additionalEmployees = [];
            if (operation.additionalLoaders && Array.isArray(operation.additionalLoaders)) {
                operation.additionalLoaders.forEach(code => {
                    const employee = employeesData.find(emp => emp.codigo === code);
                    if (employee) {
                        additionalEmployees.push(employee.nome);
                    } else {
                        additionalEmployees.push(code); // Mostrar c√≥digo se n√£o encontrar nome
                    }
                });
            }
            
            // Formatar tipo de opera√ß√£o para exibi√ß√£o
            const operationTypeMap = {
                'carregamento': 'Carregamento',
                'carregamento_Paletizado': 'Carregamento Paletizado',
                'descarga': 'Descarga',
                'separacao': 'Separa√ß√£o'
            };
            
            const formattedType = operationTypeMap[operation.type] || operation.type;
            
            return `
                <div class="dock-card ${statusClass}" id="dock-${dockNumber}">
                    <div class="dock-header">
                        <div class="dock-name">Doca ${dockNumber}</div>
                        <div class="dock-status ${statusType}">${statusText}</div>
                    </div>
                    
                    <div class="dock-details">
                        <div class="dock-detail"><strong>Iniciado:</strong> ${formatDateTime(startTime)}</div>
                        <div class="dock-detail"><strong>Status:</strong> ${operation.status === 'paused' ? 'Pausado' : 'Em andamento'}</div>
                        <div class="dock-detail"><strong>Colaborador Principal:</strong> ${mainEmployeeName}</div>
                        
                        ${additionalEmployees.length > 0 ? `
                            <div class="dock-detail">
                                <strong>Carregadores Adicionais:</strong>
                                <ul class="employees-list">
                                    ${additionalEmployees.map(emp => `<li class="employee-item">${emp}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        <div class="dock-detail"><strong>Tipo:</strong> ${formattedType}</div>
                        <div class="dock-detail"><strong>Doca:</strong> ${dockNumber}</div>
                        <div class="dock-detail"><strong>DT:</strong> ${operation.dockNumber || 'N/A'}</div>
                        <div class="dock-detail"><strong>Ve√≠culo:</strong> ${operation.vehicleType || 'N/A'}</div>
                        <div class="dock-detail"><strong>Armaz√©m:</strong> ${operation.warehouse || 'N/A'}</div>
                        
                        ${operation.status === 'paused' ? `
                            <div class="dock-detail"><strong>Motivo Pausa:</strong> ${operation.pauseReason || 'N√£o especificado'}</div>
                        ` : ''}
                    </div>
                    
                    <div class="time-info">
                        <div class="dock-detail">
                            <strong>Tempo decorrido:</strong> 
                            <span class="time-value" id="time-${dockNumber}">${formatDuration(elapsedMins)}</span>
                        </div>
                        
                        <div class="dock-detail">
                            <strong>Tempo restante (${formatTimeLimit(timeLimit)}):</strong> 
                            <span class="time-value ${remainingMins <= warningThreshold ? remainingMins <= 0 ? 'time-danger' : 'time-warning' : ''}" id="remaining-${dockNumber}">
                                ${remainingMins <= 0 ? 
                                    `Estourou em ${formatDuration(Math.abs(remainingMins))}` : 
                                    `${formatDuration(remainingMins)} restantes`}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Gerar card para doca ocupada por carro aguardando
        function generateCarInDockCard(dockNumber, carData) {
            const arrivalTime = carData.arrivalTime ? carData.arrivalTime.toDate() : new Date();
            const now = new Date();
            const waitingTime = Math.floor((now - arrivalTime) / 60000); // em minutos
            
            return `
                <div class="dock-card waiting" id="dock-${dockNumber}">
                    <div class="dock-header">
                        <div class="dock-name">Doca ${dockNumber}</div>
                        <div class="dock-status status-waiting">Aguardando ‚è≥</div>
                    </div>
                    
                    <div class="dock-details">
                        <div class="dock-detail"><strong>Status:</strong> Carro em Doca (Aguardando In√≠cio)</div>
                        <div class="dock-detail"><strong>DT:</strong> ${carData.dockNumber || 'N/A'}</div>
                        <div class="dock-detail"><strong>Chegou em:</strong> ${formatDateTime(arrivalTime)}</div>
                        <div class="dock-detail"><strong>Tempo de espera:</strong> ${formatDuration(waitingTime)}</div>
                        
                        ${carData.compositionsCount > 1 ? `
                            <div class="dock-detail"><strong>Composi√ß√µes:</strong> ${carData.compositionsCount}</div>
                            <div class="dock-detail"><strong>Docas das Composi√ß√µes:</strong> 
                                ${Object.values(carData.compositionDocks || {}).join(', ')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="time-info">
                        <div class="dock-detail">
                            <strong>Aguardando in√≠cio h√°:</strong> 
                            <span class="time-value" id="waiting-${dockNumber}">${formatDuration(waitingTime)}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Iniciar atualiza√ß√µes em tempo real
        function startRealtimeUpdates() {
            // Atualizar tempos a cada minuto
            setInterval(() => {
                // Atualizar opera√ß√µes
                operationsData.forEach(op => {
                    if (op.status !== 'completed') {
                        const dockNumber = op.dock || op.dockNumber;
                        if (dockNumber) {
                            updateDockTime(dockNumber, op);
                        }
                    }
                });
                
                // Atualizar carros em doca
                carsInDockData.forEach(car => {
                    // Atualizar doca principal
                    if (car.dock) {
                        updateCarInDockTime(car.dock, car);
                    }
                    
                    // Atualizar docas das composi√ß√µes
                    if (car.compositionDocks) {
                        Object.values(car.compositionDocks).forEach(dockNumber => {
                            updateCarInDockTime(dockNumber, car);
                        });
                    }
                });
            }, 60000); // Atualizar a cada minuto
        }
        
        // Atualizar tempo da doca em opera√ß√£o
        function updateDockTime(dockNumber, operation) {
            const now = new Date();
            const startTime = operation.startTime ? operation.startTime.toDate() : now;
            const elapsedMs = now - startTime;
            const elapsedMins = Math.floor(elapsedMs / 60000);
            
            // Obter tempo limite baseado no tipo de opera√ß√£o
            const timeLimit = timeLimits[operation.type] || 140;
            const remainingMins = timeLimit - elapsedMins;
            const warningThreshold = Math.floor(timeLimit * 0.2); // 20% do tempo restante para alerta
            
            // Atualizar elementos da interface
            const timeElement = document.getElementById(`time-${dockNumber}`);
            const remainingElement = document.getElementById(`remaining-${dockNumber}`);
            const dockCard = document.getElementById(`dock-${dockNumber}`);
            
            if (timeElement) {
                timeElement.textContent = formatDuration(elapsedMins);
            }
            
            if (remainingElement) {
                remainingElement.textContent = remainingMins <= 0 ? 
                    `Estourou em ${formatDuration(Math.abs(remainingMins))}` : 
                    `${formatDuration(remainingMins)} restantes`;
                
                // Atualizar classes de cor
                remainingElement.classList.remove('time-warning', 'time-danger');
                if (remainingMins <= 0) {
                    remainingElement.classList.add('time-danger');
                } else if (remainingMins <= warningThreshold) {
                    remainingElement.classList.add('time-warning');
                }
            }
            
            // Atualizar cor do card se necess√°rio
            if (dockCard) {
                dockCard.classList.remove('warning', 'danger', 'paused');
                
                if (operation.status === 'paused') {
                    dockCard.classList.add('paused');
                } else if (remainingMins <= 0) {
                    dockCard.classList.add('danger');
                } else if (remainingMins <= warningThreshold) {
                    dockCard.classList.add('warning');
                }
            }
        }
        
        // Atualizar tempo de espera do carro em doca
        function updateCarInDockTime(dockNumber, carData) {
            const now = new Date();
            const arrivalTime = carData.arrivalTime ? carData.arrivalTime.toDate() : now;
            const waitingTime = Math.floor((now - arrivalTime) / 60000); // em minutos
            
            // Atualizar elemento da interface
            const waitingElement = document.getElementById(`waiting-${dockNumber}`);
            if (waitingElement) {
                waitingElement.textContent = formatDuration(waitingTime);
            }
        }
        
        // Fun√ß√µes auxiliares de formata√ß√£o
        function formatTime(minutes) {
            const hrs = Math.floor(minutes / 60);
            const mins = Math.floor(minutes % 60);
            return `${hrs}:${mins.toString().padStart(2, '0')}h`;
        }
        
        function formatTimeLimit(minutes) {
            const hrs = Math.floor(minutes / 60);
            const mins = Math.floor(minutes % 60);
            if (hrs > 0 && mins > 0) {
                return `${hrs}h ${mins}min`;
            } else if (hrs > 0) {
                return `${hrs}h`;
            } else {
                return `${mins}min`;
            }
        }
        
        function formatDateTime(date) {
            return date.toLocaleString('pt-BR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }
        
        function formatDuration(minutes) {
            const hrs = Math.floor(minutes / 60);
            const mins = Math.floor(minutes % 60);
            if (hrs > 0 && mins > 0) {
                return `${hrs}h ${mins}min`;
            } else if (hrs > 0) {
                return `${hrs}h`;
            } else {
                return `${mins}min`;
            }
        }
        
        // Destacar link ativo na navbar
        const currentPage = window.location.pathname.split('/').pop();
        const navLinks = document.querySelectorAll('.nav-links a');
        
        navLinks.forEach(link => {
            const linkPage = link.getAttribute('href');
            if (currentPage === linkPage) {
                link.classList.add('active');
            } else {
                link.classList.remove('active');
            }
        });
        
        // Simula√ß√£o de logout
        document.querySelector('.logout-btn').addEventListener('click', function() {
            if (confirm('Tem certeza que deseja sair do sistema?')) {
                auth.signOut().then(() => {
                    window.location.href = 'index.html';
                }).catch((error) => {
                    console.error('Erro ao fazer logout:', error);
                });
            }
        });
    </script>
</body>
</html>
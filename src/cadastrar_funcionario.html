<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastrar Funcionário - Sistema de Operação</title>
    <!-- Importar Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- Biblioteca para geração de QR Code -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <!-- Biblioteca para geração de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="../css/cadastrar_funcionario.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <span>Prod</span>Plan
            </div>
            
            <ul class="nav-links">
                <li><a href="operacao.html">Operação</a></li>
                <li><a href="cadastrar_funcionario.html" class="active">Cadastrar Funcionário</a></li>
                <li><a href="buscar_funcionario.html">Buscar Funcionário</a></li>
                <li><a href="ranking.html">Ranking</a></li>
                <li><a href="painel_controle.html">Painel de Controle</a></li>
                <li><a href="historico.html">Histórico</a></li>
            </ul>
            
            <div class="user-section">
                <div class="user-info">
                    <div class="user-name">Carregando...</div>
                    <div class="user-role"></div>
                </div>
                <button class="logout-btn">Sair</button>
            </div>
        </div>
    </nav>
    
    <div class="content">
        <h1 class="page-title">Cadastrar Funcionário</h1>
        
        <div class="user-unit-info" id="userUnitInfo">
            Carregando informações da unidade...
        </div>
        
        <div class="success-message" id="successMessage">
            Funcionário cadastrado com sucesso! Faça o download do QR Code abaixo.
        </div>
        
        <div class="error-message" id="errorMessage">
            Ocorreu um erro ao cadastrar o funcionário. Verifique os dados e tente novamente.
        </div>
        
        <div class="validation-message" id="validationMessage">
            <!-- Mensagens de validação em tempo real -->
        </div>
        
        <div class="form-container">
            <form id="employeeForm">
                <div class="form-group">
                    <label for="employeeName">Nome Completo do Funcionário</label>
                    <input type="text" id="employeeName" placeholder="Digite o nome completo" required>
                </div>
                
                <div class="form-group">
                    <label for="employeeCode">Código do Funcionário</label>
                    <input type="text" id="employeeCode" placeholder="Ex: GZL-EO-1234" required disabled>
                    <small>Formato: SIGLAUNIDADE-EO-NÚMERO (Ex: GZL-EO-1234)</small>
                    <div class="code-validation" id="codeValidation">
                        <!-- Status da validação do código -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="employeeUnit">Unidade</label>
                    <input type="text" id="employeeUnit" readonly disabled>
                </div>
                
                <div class="form-group">
                    <label for="employeeRole">Cargo/Função</label>
                    <select id="employeeRole" required>
                        <option value="">Selecione o cargo</option>
                        <option value="carregador">Carregador</option>
                        <option value="motorista">Motorista</option>
                        <option value="separador">Separador</option>
                        <option value="auxiliar">Auxiliar</option>
                        <option value="supervisor">Supervisor</option>
                        <option value="gerente">Gerente</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="employeeStatus">Status</label>
                    <select id="employeeStatus" required>
                        <option value="ativo">Ativo</option>
                        <option value="inativo">Inativo</option>
                        <option value="ferias">Férias</option>
                        <option value="afastado">Afastado</option>
                    </select>
                </div>
                
                <button type="submit" class="submit-button" id="submitBtn">Cadastrar Funcionário</button>
                <button type="button" class="generate-code-button" id="generateCodeBtn">Gerar Código Automático</button>
            </form>
        </div>
        
        <div class="qr-preview" id="qrPreview">
            <h3>QR Code do Funcionário</h3>
            <div id="qrcode"></div>
            <p>Escaneie este QR Code para registrar a presença do funcionário</p>
            <button class="download-btn" id="downloadBtn">Baixar QR Code em PDF</button>
        </div>
    </div>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCMu17OV-5ST1rlg00zbpt6Hv37GKqkX4A",
            authDomain: "projetos-d868d.firebaseapp.com",
            databaseURL: "https://projetos-d868d-default-rtdb.firebaseio.com",
            projectId: "projetos-d868d",
            storageBucket: "projetos-d868d.firebasestorage.app",
            messagingSenderId: "420029352781",
            appId: "1:420029352781:web:05176699348e0ccdd78504",
            measurementId: "G-FXWXRX04WF"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Elementos da interface
        const userUnitInfo = document.getElementById('userUnitInfo');
        const userNameElement = document.querySelector('.user-name');
        const employeeForm = document.getElementById('employeeForm');
        const employeeUnitInput = document.getElementById('employeeUnit');
        const employeeCodeInput = document.getElementById('employeeCode');
        const qrPreview = document.getElementById('qrPreview');
        const downloadBtn = document.getElementById('downloadBtn');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const validationMessage = document.getElementById('validationMessage');
        const codeValidation = document.getElementById('codeValidation');
        const submitBtn = document.getElementById('submitBtn');
        const generateCodeBtn = document.getElementById('generateCodeBtn');
        
        // Estado da aplicação
        let currentUser = null;
        let userData = null;
        let currentUnit = '';
        let currentEmployeeCode = '';
        let currentEmployeeData = null;
        let isCodeValid = false;
        let codeValidationTimeout = null;
        
        // Verificar autenticação
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                userNameElement.textContent = 'Carregando...';
                
                // Buscar dados do usuário no Firestore
                db.collection('users').doc(user.uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        userData = doc.data();
                        userNameElement.textContent = userData.name;
                        currentUnit = userData.unit;
                        userUnitInfo.textContent = `Unidade atual: ${currentUnit}`;
                        employeeUnitInput.value = currentUnit;
                        
                        // Gerar código automático inicial
                        generateEmployeeCode();
                    } else {
                        console.error("Documento do usuário não encontrado");
                    }
                })
                .catch((error) => {
                    console.error("Erro ao buscar dados do usuário:", error);
                });
            } else {
                // Usuário não autenticado, redirecionar para login
                window.location.href = 'login.html';
            }
        });
        
        // Gerar QR Code
        function generateQRCode(text) {
            // Limpar QR Code anterior
            const qrCodeElement = document.getElementById('qrcode');
            qrCodeElement.innerHTML = '';
            
            // Criar canvas para o QR Code
            const canvas = document.createElement('canvas');
            qrCodeElement.appendChild(canvas);
            
            // Gerar novo QR Code
            QRCode.toCanvas(canvas, text, {
                width: 200,
                margin: 1,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                }
            }, function(error) {
                if (error) {
                    console.error('Erro ao gerar QR Code:', error);
                    showError('Erro ao gerar QR Code. Tente novamente.');
                }
            });
        }
        
        // Gerar PDF com QR Code
        function generatePDF(employeeData) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Adicionar logo ou título
            doc.setFontSize(20);
            doc.setTextColor(40, 40, 40);
            doc.text('Identificação do Funcionário', 105, 20, { align: 'center' });
            
            // Adicionar linha divisória
            doc.setDrawColor(200, 200, 200);
            doc.line(20, 25, 190, 25);
            
            // Adicionar informações do funcionário
            doc.setFontSize(12);
            doc.setTextColor(80, 80, 80);
            doc.text(`Nome: ${employeeData.nome}`, 20, 40);
            doc.text(`Código: ${employeeData.codigo}`, 20, 50);
            doc.text(`Unidade: ${employeeData.unidade}`, 20, 60);
            doc.text(`Cargo: ${employeeData.funcao}`, 20, 70);
            doc.text(`Status: ${employeeData.status}`, 20, 80);
            doc.text(`Data de Cadastro: ${new Date().toLocaleDateString('pt-BR')}`, 20, 90);
            
            // Adicionar QR Code (convertendo canvas para imagem)
            const qrCodeCanvas = document.querySelector('#qrcode canvas');
            if (qrCodeCanvas) {
                const qrCodeImage = qrCodeCanvas.toDataURL('image/png');
                doc.addImage(qrCodeImage, 'PNG', 130, 35, 50, 50);
            }
            
            // Adicionar instruções
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text('Use este QR Code para registrar a presença em operações', 20, 110);
            doc.text('Este documento deve ser mantido em local visível', 20, 120);
            
            // Salvar PDF
            doc.save(`QRCode_${employeeData.codigo}.pdf`);
        }
        
        // Mostrar mensagem de sucesso
        function showSuccess() {
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            validationMessage.style.display = 'none';
        }
        
        // Mostrar mensagem de erro
        function showError(message) {
            errorMessage.textContent = message || 'Ocorreu um erro ao cadastrar o funcionário. Verifique os dados e tente novamente.';
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
            validationMessage.style.display = 'none';
        }
        
        // Mostrar mensagem de validação
        function showValidation(message, type = 'info') {
            validationMessage.textContent = message;
            validationMessage.className = `validation-message ${type}`;
            validationMessage.style.display = 'block';
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
        }
        
        // Mostrar status da validação do código
        function showCodeValidation(message, type = 'info') {
            codeValidation.textContent = message;
            codeValidation.className = `code-validation ${type}`;
            codeValidation.style.display = 'block';
        }
        
        // Esconder validação do código
        function hideCodeValidation() {
            codeValidation.style.display = 'none';
        }
        
        // Validar formato do código do funcionário
        function validateEmployeeCodeFormat(code) {
            // Verificar se o código segue o padrão: SIGLAUNIDADE-EO-NÚMERO
            const pattern = /^[A-Z]{3}-EO-\d{4,5}$/;
            return pattern.test(code);
        }
        
        // Verificar se código já existe no sistema
        function checkEmployeeCodeExists(code) {
            if (!code || !validateEmployeeCodeFormat(code)) {
                return Promise.resolve(false);
            }
            
            return db.collection('colaboradores')
                .where('codigo', '==', code)
                .get()
                .then((snapshot) => {
                    return !snapshot.empty;
                })
                .catch((error) => {
                    console.error("Erro ao verificar código:", error);
                    return false;
                });
        }
        
        // Validar código em tempo real
        function validateEmployeeCode(code) {
            // Limpar timeout anterior
            if (codeValidationTimeout) {
                clearTimeout(codeValidationTimeout);
            }
            
            // Validar formato
            if (!validateEmployeeCodeFormat(code)) {
                showCodeValidation('❌ Formato inválido. Use: SIGLAUNIDADE-EO-NÚMERO', 'error');
                isCodeValid = false;
                updateSubmitButton();
                return;
            }
            
            // Mostrar mensagem de verificação
            showCodeValidation('⏳ Verificando disponibilidade...', 'info');
            
            // Debounce para evitar muitas consultas
            codeValidationTimeout = setTimeout(() => {
                checkEmployeeCodeExists(code)
                    .then((exists) => {
                        if (exists) {
                            showCodeValidation('❌ Código já está em uso', 'error');
                            isCodeValid = false;
                        } else {
                            showCodeValidation('✅ Código disponível', 'success');
                            isCodeValid = true;
                        }
                        updateSubmitButton();
                    })
                    .catch(() => {
                        showCodeValidation('⚠️ Erro na verificação', 'warning');
                        isCodeValid = false;
                        updateSubmitButton();
                    });
            }, 500);
        }
        
        // Atualizar estado do botão de envio
        function updateSubmitButton() {
            const employeeName = document.getElementById('employeeName').value.trim();
            const employeeRole = document.getElementById('employeeRole').value;
            
            if (employeeName && employeeRole && isCodeValid) {
                submitBtn.disabled = false;
                submitBtn.style.opacity = '1';
            } else {
                submitBtn.disabled = true;
                submitBtn.style.opacity = '0.6';
            }
        }
        
        // Gerar código automático baseado na unidade
        function generateEmployeeCode() {
            if (!currentUnit) return '';
            
            // Obter sigla da unidade (primeiras 3 letras em maiúsculas)
            const unitPrefix = currentUnit.substring(0, 3).toUpperCase();
            
            // Gerar número aleatório de 4 dígitos
            const randomNumber = Math.floor(1000 + Math.random() * 9000);
            
            const newCode = `${unitPrefix}-EO-${randomNumber}`;
            employeeCodeInput.value = newCode;
            
            // Validar o código gerado
            validateEmployeeCode(newCode);
            
            return newCode;
        }
        
        // Evento de input no código do funcionário
        employeeCodeInput.addEventListener('input', function() {
            const code = this.value.trim();
            validateEmployeeCode(code);
            updateSubmitButton();
        });
        
        // Evento de input no nome do funcionário
        document.getElementById('employeeName').addEventListener('input', updateSubmitButton);
        
        // Evento de change no cargo
        document.getElementById('employeeRole').addEventListener('change', updateSubmitButton);
        
        // Evento de gerar código automático
        generateCodeBtn.addEventListener('click', function() {
            generateEmployeeCode();
        });
        
        // Evento de envio do formulário
        employeeForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Obter valores do formulário
            const employeeName = document.getElementById('employeeName').value.trim();
            const employeeCode = document.getElementById('employeeCode').value.trim();
            const employeeRole = document.getElementById('employeeRole').value;
            const employeeStatus = document.getElementById('employeeStatus').value;
            
            // Validar se o código ainda está disponível (dupla verificação)
            checkEmployeeCodeExists(employeeCode)
                .then((exists) => {
                    if (exists) {
                        showError('Este código já está em uso. Por favor, gere um novo código.');
                        validateEmployeeCode(employeeCode); // Atualizar a validação visual
                        return;
                    }
                    
                    // Salvar no Firestore
                    return db.collection('colaboradores').add({
                        nome: employeeName,
                        codigo: employeeCode,
                        unidade: currentUnit,
                        funcao: employeeRole,
                        status: employeeStatus,
                        dataCadastro: new Date(),
                        criadoPor: currentUser.uid
                    });
                })
                .then((docRef) => {
                    if (!docRef) return; // Se retornou undefined (código já existe)
                    
                    // Salvar dados do funcionário para uso posterior
                    currentEmployeeCode = employeeCode;
                    currentEmployeeData = {
                        nome: employeeName,
                        codigo: employeeCode,
                        unidade: currentUnit,
                        funcao: employeeRole,
                        status: employeeStatus
                    };
                    
                    // Gerar QR Code com o código do funcionário
                    generateQRCode(employeeCode);
                    
                    // Mostrar área de preview do QR Code
                    qrPreview.style.display = 'block';
                    
                    // Mostrar mensagem de sucesso
                    showSuccess();
                    
                    // Rolagem para a área do QR Code
                    qrPreview.scrollIntoView({ behavior: 'smooth' });
                    
                    // Limpar formulário (exceto unidade)
                    document.getElementById('employeeName').value = '';
                    document.getElementById('employeeRole').value = '';
                    document.getElementById('employeeStatus').value = 'ativo';
                    
                    // Gerar novo código automático
                    generateEmployeeCode();
                    
                    // Resetar validação
                    isCodeValid = false;
                    updateSubmitButton();
                    hideCodeValidation();
                })
                .catch((error) => {
                    console.error("Erro ao cadastrar funcionário:", error);
                    showError('Erro ao cadastrar funcionário. Tente novamente.');
                });
        });
        
        // Evento de download do PDF
        downloadBtn.addEventListener('click', function() {
            if (currentEmployeeData) {
                // Gerar PDF
                generatePDF(currentEmployeeData);
            }
        });
        
        // Destacar link ativo na navbar
        const currentPage = window.location.pathname.split('/').pop();
        const navLinks = document.querySelectorAll('.nav-links a');
        
        navLinks.forEach(link => {
            const linkPage = link.getAttribute('href');
            if (currentPage === linkPage) {
                link.classList.add('active');
            } else {
                link.classList.remove('active');
            }
        });
        
        // Simulação de logout
        document.querySelector('.logout-btn').addEventListener('click', function() {
            if (confirm('Tem certeza que deseja sair do sistema?')) {
                auth.signOut().then(() => {
                    window.location.href = 'index.html';
                }).catch((error) => {
                    console.error('Erro ao fazer logout:', error);
                });
            }
        });
    </script>

    <style>
        /* Estilos para as novas funcionalidades de validação */
        .validation-message {
            display: none;
            padding: 12px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .validation-message.info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            color: #1976d2;
        }
        
        .validation-message.success {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
        }
        
        .validation-message.error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
        }
        
        .validation-message.warning {
            background: #fff3e0;
            border: 1px solid #ff9800;
            color: #ef6c00;
        }
        
        .code-validation {
            display: none;
            margin-top: 5px;
            font-size: 0.9em;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .code-validation.success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }
        
        .code-validation.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #f44336;
        }
        
        .code-validation.info {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #2196f3;
        }
        
        .code-validation.warning {
            background: #fff3e0;
            color: #ef6c00;
            border: 1px solid #ff9800;
        }
        
        .generate-code-button {
            background: #ff9800;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
            transition: background-color 0.2s;
        }
        
        .generate-code-button:hover {
            background: #f57c00;
        }
        
        .submit-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .submit-button:disabled:hover {
            background-color: #cccccc;
        }
        
        .form-group {
            position: relative;
        }
    </style>
</body>
</html>
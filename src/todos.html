<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle - Todas as Unidades</title>
    <!-- Importar Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <link rel="stylesheet" href="../css/painel_controle.css">
    <style>
        /* Estilos espec√≠ficos para o painel de todas as unidades */
        .units-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .unit-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #4a6da7;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .unit-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .unit-card h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 18px;
        }
        
        .unit-card .unit-type {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .unit-stats {
            margin-top: 15px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .stat-value {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .progress {
            height: 8px;
            background-color: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-bar {
            height: 100%;
            background-color: #4a6da7;
            transition: width 0.3s;
        }
        
        .unit-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
        }
        
        .last-update {
            font-size: 12px;
            color: #999;
        }
        
        .btn-access {
            background: #4a6da7;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .btn-access:hover {
            background: #3a5a8f;
        }
        
        /* Compara√ß√£o entre unidades */
        .compare-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .compare-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
        }
        
        .compare-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .compare-vs {
            text-align: center;
            font-weight: bold;
            color: #666;
        }
        
        .btn-compare {
            background: #4a6da7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .btn-compare:hover {
            background: #3a5a8f;
        }
        
        .btn-compare:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* Container de compara√ß√£o */
        .compare-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .compare-header {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .compare-unit {
            font-weight: bold;
            font-size: 16px;
            color: #2c3e50;
        }
        
        .compare-metric {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 15px;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .compare-metric-label {
            color: #666;
            font-size: 14px;
        }
        
        .compare-metric-value {
            text-align: center;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
        }
        
        .better-value {
            background-color: #4CAF50;
            color: white;
        }
        
        .worse-value {
            background-color: #f44336;
            color: white;
        }
        
        .equal-value {
            background-color: #FF9800;
            color: white;
        }
        
        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4a6da7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Indicador de atualiza√ß√£o autom√°tica */
        .auto-update-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4a6da7;
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        /* Status badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .status-active {
            background-color: #2196f3;
            color: white;
        }
        
        .status-paused {
            background-color: #ff9800;
            color: white;
        }
        
        .status-completed {
            background-color: #4caf50;
            color: white;
        }

        /* Filtros */
        .filters-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }
        
        .filter-select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        /* Cards de tempo por tipo de opera√ß√£o */
        .time-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .time-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid;
        }
        
        .time-card.carregamento {
            border-left-color: #4CAF50;
        }
        
        .time-card.carregamento-paletizado {
            border-left-color: #2196F3;
        }
        
        .time-card.descarga {
            border-left-color: #FF9800;
        }
        
        .time-card.separacao {
            border-left-color: #9C27B0;
        }
        
        .time-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .time-card-title {
            font-weight: bold;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .time-card-count {
            background: #f0f0f0;
            color: #666;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .time-card-value {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .time-card-subvalue {
            font-size: 12px;
            color: #666;
        }

        /* Bot√£o de mudan√ßa de unidade */
        .change-unit-btn {
            background-color: #4a6da7;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
            transition: background-color 0.3s;
        }
        
        .change-unit-btn:hover {
            background-color: #3a5a8f;
        }
        
        /* Modal de mudan√ßa de unidade */
        .unit-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .unit-modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 25px;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .unit-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .unit-modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .unit-close-btn {
            font-size: 24px;
            cursor: pointer;
            color: #777;
            transition: color 0.3s;
        }
        
        .unit-close-btn:hover {
            color: #333;
        }
        
        .unit-select {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .unit-modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .unit-cancel-btn, .unit-confirm-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .unit-cancel-btn {
            background-color: #f0f0f0;
            color: #333;
        }

        .unit-cancel-btn:hover {
            background-color: #e0e0e0;
        }
        
        .unit-confirm-btn {
            background-color: #4a6da7;
            color: white;
        }
        
        .unit-confirm-btn:hover {
            background-color: #3a5a8f;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <span>Prod</span>Plan
            </div>
            
            <ul class="nav-links">
                <li><a href="operacao.html">Opera√ß√£o</a></li>
                <li><a href="cadastrar_funcionario.html">Cadastrar Funcion√°rio</a></li>
                <li><a href="buscar_funcionario.html">Buscar Funcion√°rio</a></li>
                <li><a href="ranking.html">Ranking</a></li>
                <li><a href="painel_controle.html">Painel da Unidade</a></li>
                <li><a href="todos.html" class="active">Todas as Unidades</a></li>
                <li><a href="historico.html">Hist√≥rico</a></li>
            </ul>
            
            <div class="user-section">
                <div class="user-info">
                    <div class="user-name">Carregando...</div>
                    <div class="user-role"></div>
                </div>
                <button class="change-unit-btn" id="changeUnitBtn">Mudar Unidade</button>
                <button class="logout-btn">Sair</button>
            </div>
        </div>
    </nav>
    
    <div class="content">
        <h1 class="page-title">Painel de Controle - Todas as Unidades</h1>
        
        <div class="user-unit-info" id="userUnitInfo">
            Carregando informa√ß√µes do usu√°rio...
        </div>

        <!-- Se√ß√£o de Filtros -->
        <div class="filters-section">
            <h3>Filtros</h3>
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">Ordenar por:</label>
                    <select id="sortBy" class="filter-select">
                        <option value="name">Nome da Unidade</option>
                        <option value="efficiency">Efici√™ncia</option>
                        <option value="completed">Opera√ß√µes Finalizadas</option>
                        <option value="tons">Toneladas</option>
                        <option value="time">Tempo M√©dio</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Tipo de Unidade:</label>
                    <select id="filterType" class="filter-select">
                        <option value="all">Todas</option>
                        <option value="operacao">Opera√ß√£o</option>
                        <option value="logistica">Log√≠stica</option>
                        <option value="producao">Produ√ß√£o</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Status:</label>
                    <select id="filterStatus" class="filter-select">
                        <option value="all">Todos</option>
                        <option value="active">Com opera√ß√µes ativas</option>
                        <option value="completed">Com opera√ß√µes finalizadas</option>
                        <option value="efficient">Efici√™ncia > 80%</option>
                        <option value="critical">Efici√™ncia < 60%</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Per√≠odo:</label>
                    <select id="filterPeriod" class="filter-select">
                        <option value="today">Hoje</option>
                        <option value="yesterday">Ontem</option>
                        <option value="week">Esta semana</option>
                        <option value="month">Este m√™s</option>
                        <option value="custom">Personalizado</option>
                    </select>
                </div>

                <div class="filter-group" id="customDateRange" style="display: none;">
                    <label class="filter-label">Data Inicial</label>
                    <input type="date" id="startDate" class="filter-select">
                </div>

                <div class="filter-group" id="customDateRangeEnd" style="display: none;">
                    <label class="filter-label">Data Final</label>
                    <input type="date" id="endDate" class="filter-select">
                </div>
            </div>
        </div>

        <!-- Cards de Tempo por Tipo de Opera√ß√£o -->
        <div class="time-cards" id="timeCards" style="display: none;">
            <div class="time-card carregamento">
                <div class="time-card-header">
                    <div class="time-card-title">Carregamento</div>
                    <div class="time-card-count" id="countCarregamento">0 ops</div>
                </div>
                <div class="time-card-value" id="timeCarregamento">0h 00min</div>
                <div class="time-card-subvalue" id="subtimeCarregamento">Tempo m√©dio</div>
            </div>
            
            <div class="time-card carregamento-paletizado">
                <div class="time-card-header">
                    <div class="time-card-title">Carreg. Paletizado</div>
                    <div class="time-card-count" id="countPaletizado">0 ops</div>
                </div>
                <div class="time-card-value" id="timePaletizado">0h 00min</div>
                <div class="time-card-subvalue" id="subtimePaletizado">Tempo m√©dio</div>
            </div>
            
            <div class="time-card descarga">
                <div class="time-card-header">
                    <div class="time-card-title">Descarga</div>
                    <div class="time-card-count" id="countDescarga">0 ops</div>
                </div>
                <div class="time-card-value" id="timeDescarga">0h 00min</div>
                <div class="time-card-subvalue" id="subtimeDescarga">Tempo m√©dio</div>
            </div>
            
            <div class="time-card separacao">
                <div class="time-card-header">
                    <div class="time-card-title">Separa√ß√£o</div>
                    <div class="time-card-count" id="countSeparacao">0 ops</div>
                </div>
                <div class="time-card-value" id="timeSeparacao">0h 00min</div>
                <div class="time-card-subvalue" id="subtimeSeparacao">Tempo m√©dio</div>
            </div>
        </div>

        <!-- Se√ß√£o de Compara√ß√£o -->
        <div class="compare-section">
            <h2>Comparar Unidades</h2>
            <div class="compare-grid">
                <select id="compareUnit1" class="compare-select">
                    <option value="">Selecione a 1¬™ unidade</option>
                </select>
                
                <div class="compare-vs">VS</div>
                
                <select id="compareUnit2" class="compare-select">
                    <option value="">Selecione a 2¬™ unidade</option>
                </select>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button id="btnCompare" class="btn-compare" disabled>
                    üìä Comparar Unidades
                </button>
            </div>
        </div>

        <!-- Container para compara√ß√£o -->
        <div id="compareContainer"></div>

        <!-- Grid de Unidades -->
        <div class="units-grid" id="unitsGrid">
            <div class="unit-card">
                <div class="loading">
                    <div class="loading-spinner"></div>
                </div>
                <p style="text-align: center; color: #666;">Carregando unidades...</p>
            </div>
        </div>
    </div>

    <!-- Modal de Mudan√ßa de Unidade -->
    <div class="unit-modal" id="unitModal">
        <div class="unit-modal-content">
            <div class="unit-modal-header">
                <h2 class="unit-modal-title">Mudar Unidade</h2>
                <span class="unit-close-btn" id="unitCloseBtn">&times;</span>
            </div>
            
            <div class="modal-body">
                <p>Selecione a unidade para a qual deseja mudar:</p>
                <select id="unitSelect" class="unit-select">
                    <option value="">Selecione uma unidade</option>
                </select>
            </div>
            
            <div class="unit-modal-actions">
                <button class="unit-cancel-btn" id="unitCancelBtn">Cancelar</button>
                <button class="unit-confirm-btn" id="unitConfirmBtn">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Indicador de atualiza√ß√£o autom√°tica -->
    <div id="autoUpdateIndicator" class="auto-update-indicator" style="display: none;">
        üîÑ Atualizando dados...
    </div>

    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCMu17OV-5ST1rlg00zbpt6Hv37GKqkX4A",
            authDomain: "projetos-d868d.firebaseapp.com",
            databaseURL: "https://projetos-d868d-default-rtdb.firebaseio.com",
            projectId: "projetos-d868d",
            storageBucket: "projetos-d868d.firebasestorage.app",
            messagingSenderId: "420029352781",
            appId: "1:420029352781:web:05176699348e0ccdd78504",
            measurementId: "G-FXWXRX04WF"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Configura√ß√£o das unidades - AGORA BUSCA DINAMICAMENTE
        const unitsConfig = {
            // Ser√° preenchido dinamicamente
        };

        // Estado da aplica√ß√£o
        let currentUser = null;
        let userData = null;
        let currentUnit = '';
        let unitsData = {};
        let dataUpdateInterval = null;
        let allUnitsList = [];
        let operationsData = [];

        // Elementos da interface
        const userNameElement = document.querySelector('.user-name');
        const userUnitInfo = document.getElementById('userUnitInfo');
        const unitsGrid = document.getElementById('unitsGrid');
        const compareUnit1 = document.getElementById('compareUnit1');
        const compareUnit2 = document.getElementById('compareUnit2');
        const btnCompare = document.getElementById('btnCompare');
        const compareContainer = document.getElementById('compareContainer');
        const autoUpdateIndicator = document.getElementById('autoUpdateIndicator');
        const sortBy = document.getElementById('sortBy');
        const filterType = document.getElementById('filterType');
        const filterStatus = document.getElementById('filterStatus');
        const filterPeriod = document.getElementById('filterPeriod');
        const timeCards = document.getElementById('timeCards');
        const changeUnitBtn = document.getElementById('changeUnitBtn');
        const unitModal = document.getElementById('unitModal');
        const unitSelect = document.getElementById('unitSelect');
        const unitCloseBtn = document.getElementById('unitCloseBtn');
        const unitCancelBtn = document.getElementById('unitCancelBtn');
        const unitConfirmBtn = document.getElementById('unitConfirmBtn');
        const startDate = document.getElementById('startDate');
        const endDate = document.getElementById('endDate');
        const customDateRange = document.getElementById('customDateRange');
        const customDateRangeEnd = document.getElementById('customDateRangeEnd');

        // Verificar autentica√ß√£o
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                userNameElement.textContent = 'Carregando...';
                
                // Buscar dados do usu√°rio no Firestore
                db.collection('users').doc(user.uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        userData = doc.data();
                        userNameElement.textContent = userData.name;
                        currentUnit = userData.unit;
                        userUnitInfo.textContent = `Usu√°rio: ${userData.name} | Unidade atual: ${currentUnit}`;
                        
                        // Primeiro carregar a lista de unidades
                        loadUnitsList().then(() => {
                            // Depois carregar os dados de todas as unidades
                            loadAllUnitsData();
                            
                            // Configurar atualiza√ß√£o autom√°tica
                            if (dataUpdateInterval) clearInterval(dataUpdateInterval);
                            dataUpdateInterval = setInterval(loadAllUnitsData, 30000); // 30 segundos
                        });
                        
                    } else {
                        console.error("Documento do usu√°rio n√£o encontrado");
                    }
                })
                .catch((error) => {
                    console.error("Erro ao buscar dados do usu√°rio:", error);
                });
            } else {
                // Usu√°rio n√£o autenticado, redirecionar para login
                window.location.href = 'login.html';
            }
        });

        // Carregar lista de unidades do banco de dados
        async function loadUnitsList() {
            try {
                console.log("Buscando lista de unidades...");
                
                // Buscar todas as opera√ß√µes para extrair unidades √∫nicas
                const operationsSnapshot = await db.collection('operations')
                    .where('createdAt', '>=', new Date(new Date().setDate(new Date().getDate() - 30))) // √öltimos 30 dias
                    .get();
                
                const unitsSet = new Set();
                
                operationsSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.unit) {
                        unitsSet.add(data.unit);
                    }
                });
                
                // Buscar tamb√©m de carsInDock
                const carsSnapshot = await db.collection('carsInDock').get();
                carsSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.unit) {
                        unitsSet.add(data.unit);
                    }
                });
                
                // Buscar tamb√©m de composi√ß√µes
                const compositionsSnapshot = await db.collection('compositions').get();
                compositionsSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.unit) {
                        unitsSet.add(data.unit);
                    }
                });
                
                allUnitsList = Array.from(unitsSet);
                console.log("Unidades encontradas:", allUnitsList);
                
                // Configurar unitsConfig dinamicamente
                allUnitsList.forEach(unitName => {
                    if (!unitsConfig[unitName]) {
                        unitsConfig[unitName] = {
                            name: unitName,
                            type: 'Opera√ß√£o', // Tipo padr√£o
                            color: getRandomColor(),
                            metaToneladas: 100 // Meta padr√£o
                        };
                    }
                });
                
                // Preencher select do modal de mudan√ßa de unidade
                populateUnitSelect();
                
                // Adicionar evento aos filtros
                setupFilters();
                
            } catch (error) {
                console.error("Erro ao carregar lista de unidades:", error);
            }
        }

        // Preencher select do modal de mudan√ßa de unidade
        function populateUnitSelect() {
            unitSelect.innerHTML = '<option value="">Selecione uma unidade</option>';
            allUnitsList.forEach(unitName => {
                const option = document.createElement('option');
                option.value = unitName;
                option.textContent = unitsConfig[unitName].name;
                unitSelect.appendChild(option);
            });
        }

        // Gerar cor aleat√≥ria para as unidades
        function getRandomColor() {
            const colors = ['#4a6da7', '#2c3e50', '#3498db', '#2980b9', '#1abc9c', '#16a085', '#27ae60', '#2ecc71'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // Configurar eventos dos filtros
        function setupFilters() {
            [sortBy, filterType, filterStatus, filterPeriod].forEach(filter => {
                filter.addEventListener('change', () => {
                    if (filterPeriod.value === 'custom') {
                        customDateRange.style.display = 'flex';
                        customDateRangeEnd.style.display = 'flex';
                    } else {
                        customDateRange.style.display = 'none';
                        customDateRangeEnd.style.display = 'none';
                    }
                    loadAllUnitsData();
                });
            });

            // Eventos para datas personalizadas
            [startDate, endDate].forEach(dateInput => {
                dateInput.addEventListener('change', loadAllUnitsData);
            });
        }

        // Obter per√≠odo de datas baseado no filtro
        function getDateRange() {
            const today = new Date();
            let start, end;

            switch(filterPeriod.value) {
                case 'today':
                    start = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                    end = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59);
                    break;
                case 'yesterday':
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    start = new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate());
                    end = new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate(), 23, 59, 59);
                    break;
                case 'week':
                    start = new Date(today);
                    start.setDate(today.getDate() - today.getDay());
                    end = new Date(today);
                    end.setDate(today.getDate() + (6 - today.getDay()));
                    end.setHours(23, 59, 59, 999);
                    break;
                case 'month':
                    start = new Date(today.getFullYear(), today.getMonth(), 1);
                    end = new Date(today.getFullYear(), today.getMonth() + 1, 0, 23, 59, 59);
                    break;
                case 'custom':
                    if (startDate.value && endDate.value) {
                        start = new Date(startDate.value);
                        end = new Date(endDate.value);
                        end.setHours(23, 59, 59, 999);
                    } else {
                        // Se n√£o h√° datas personalizadas, usar o m√™s atual
                        start = new Date(today.getFullYear(), today.getMonth(), 1);
                        end = new Date(today.getFullYear(), today.getMonth() + 1, 0, 23, 59, 59);
                    }
                    break;
                default:
                    start = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                    end = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59);
            }

            return { start, end };
        }

        // Carregar dados de todas as unidades
        async function loadAllUnitsData() {
            showAutoUpdateIndicator();
            
            try {
                const dateRange = getDateRange();
                console.log('Per√≠odo selecionado:', dateRange.start, 'at√©', dateRange.end);

                // Carregar todas as opera√ß√µes para calcular estat√≠sticas globais
                const operationsSnapshot = await db.collection('operations')
                    .where('createdAt', '>=', dateRange.start)
                    .where('createdAt', '<=', dateRange.end)
                    .get();
                
                operationsData = [];
                operationsSnapshot.forEach(doc => {
                    operationsData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                console.log(`Total de opera√ß√µes no per√≠odo: ${operationsData.length}`);

                // Atualizar cards de tempo por tipo
                updateTimeCards();

                const updatePromises = allUnitsList.map(async (unitName) => {
                    try {
                        console.log(`Carregando dados da unidade: ${unitName}`);
                        
                        // Buscar opera√ß√µes da unidade no per√≠odo selecionado
                        const unitOperations = operationsData.filter(op => op.unit === unitName);
                        
                        console.log(`${unitName}: ${unitOperations.length} opera√ß√µes encontradas`);
                        
                        // Buscar carros em doca ativos
                        const carsInDockSnapshot = await db.collection('carsInDock')
                            .where('unit', '==', unitName)
                            .where('status', 'in', ['available', 'in_use_partial'])
                            .get();
                        
                        const occupiedDocks = carsInDockSnapshot.size;
                        
                        // Buscar composi√ß√µes ativas
                        const compositionsSnapshot = await db.collection('compositions')
                            .where('unit', '==', unitName)
                            .where('status', 'in', ['available', 'in_use'])
                            .get();
                        
                        const activeCompositions = compositionsSnapshot.size;

                        // Calcular estat√≠sticas
                        const completedOperations = unitOperations.filter(op => op.status === 'completed');
                        const activeOperations = unitOperations.filter(op => op.status === 'active');
                        const pausedOperations = unitOperations.filter(op => op.status === 'paused');
                        
                        // Calcular tempo m√©dio
                        let totalMinutes = 0;
                        let completedCount = 0;
                        let exceededCount = 0;
                        let totalTons = 0;
                        let totalMix = 0;
                        
                        completedOperations.forEach(op => {
                            if (op.startTime && op.endTime) {
                                const start = op.startTime.toDate();
                                const end = op.endTime.toDate();
                                const duration = (end - start) / (1000 * 60); // minutos
                                totalMinutes += duration;
                                completedCount++;
                                
                                if (duration > 140) { // Mais de 2h20min
                                    exceededCount++;
                                }
                            }
                            
                            // Soma toneladas e mix
                            totalTons += op.tonsLoaded || 0;
                            totalMix += op.materialMix || 0;
                        });
                        
                        const avgMinutes = completedCount > 0 ? totalMinutes / completedCount : 0;
                        const exceededPercentage = completedCount > 0 ? (exceededCount / completedCount) * 100 : 0;
                        
                        // Calcular efici√™ncia
                        const efficiency = calculateEfficiency(avgMinutes);
                        
                        // Calcular progresso da meta
                        const unitConfig = unitsConfig[unitName];
                        const metaProgress = unitConfig.metaToneladas > 0 ? 
                            Math.min(100, (totalTons / unitConfig.metaToneladas) * 100) : 0;
                        
                        // Armazenar dados da unidade
                        unitsData[unitName] = {
                            name: unitConfig.name,
                            type: unitConfig.type,
                            completedOperations: completedOperations.length,
                            activeOperations: activeOperations.length,
                            pausedOperations: pausedOperations.length,
                            occupiedDocks: occupiedDocks,
                            activeCompositions: activeCompositions,
                            totalDocks: 11, // Padr√£o de 11 docas
                            avgTime: avgMinutes,
                            efficiency: efficiency,
                            totalTons: totalTons,
                            metaProgress: metaProgress,
                            metaToneladas: unitConfig.metaToneladas,
                            exceededPercentage: exceededPercentage,
                            totalMix: completedCount > 0 ? Math.round(totalMix / completedCount) : 0,
                            lastUpdate: new Date(),
                            operationsCount: unitOperations.length
                        };
                        
                    } catch (error) {
                        console.error(`Erro ao carregar dados da unidade ${unitName}:`, error);
                        // Inicializar com dados padr√£o em caso de erro
                        unitsData[unitName] = {
                            name: unitsConfig[unitName].name,
                            type: unitsConfig[unitName].type,
                            completedOperations: 0,
                            activeOperations: 0,
                            pausedOperations: 0,
                            occupiedDocks: 0,
                            activeCompositions: 0,
                            totalDocks: 11,
                            avgTime: 0,
                            efficiency: 0,
                            totalTons: 0,
                            metaProgress: 0,
                            metaToneladas: unitsConfig[unitName].metaToneladas,
                            exceededPercentage: 0,
                            totalMix: 0,
                            lastUpdate: new Date(),
                            error: true,
                            operationsCount: 0
                        };
                    }
                });
                
                await Promise.all(updatePromises);
                
                console.log('Dados de todas as unidades carregados:', unitsData);
                
                // Atualizar interface
                updateUnitsGrid();
                populateCompareSelects();
                
            } catch (error) {
                console.error("Erro ao carregar dados das unidades:", error);
            } finally {
                hideAutoUpdateIndicator();
            }
        }

        // Atualizar cards de tempo por tipo de opera√ß√£o - CORRE√á√ÉO DO ERRO
        function updateTimeCards() {
            try {
                const completedOperations = operationsData.filter(op => op.status === 'completed');
                
                // Calcular estat√≠sticas por tipo
                const types = {
                    'carregamento': { totalMinutes: 0, count: 0 },
                    'carregamento_Paletizado': { totalMinutes: 0, count: 0 },
                    'descarga': { totalMinutes: 0, count: 0 },
                    'separacao': { totalMinutes: 0, count: 0 }
                };
                
                completedOperations.forEach(op => {
                    if (op.startTime && op.endTime && types[op.type]) {
                        const start = op.startTime.toDate();
                        const end = op.endTime.toDate();
                        const duration = (end - start) / (1000 * 60); // minutos
                        
                        types[op.type].totalMinutes += duration;
                        types[op.type].count += 1;
                    }
                });
                
                // Atualizar cards com verifica√ß√£o de seguran√ßa
                updateTimeCard('carregamento', types.carregamento);
                updateTimeCard('carregamento_Paletizado', types.carregamento_Paletizado);
                updateTimeCard('descarga', types.descarga);
                updateTimeCard('separacao', types.separacao);
                
                // Mostrar cards se houver dados
                if (completedOperations.length > 0) {
                    timeCards.style.display = 'grid';
                } else {
                    timeCards.style.display = 'none';
                }
            } catch (error) {
                console.error('Erro ao atualizar cards de tempo:', error);
            }
        }
        
        // Atualizar card individual de tempo - CORRE√á√ÉO DO ERRO
        function updateTimeCard(type, data) {
            try {
                const avgMinutes = data.count > 0 ? data.totalMinutes / data.count : 0;
                const avgHours = Math.floor(avgMinutes / 60);
                const avgMins = Math.round(avgMinutes % 60);
                
                // Verificar se os elementos existem antes de atualizar
                const timeElement = document.getElementById(`time${getElementId(type)}`);
                const subtimeElement = document.getElementById(`subtime${getElementId(type)}`);
                const countElement = document.getElementById(`count${getElementId(type)}`);
                
                if (timeElement) {
                    timeElement.textContent = `${avgHours}h ${avgMins.toString().padStart(2, '0')}min`;
                }
                if (subtimeElement) {
                    subtimeElement.textContent = `M√©dia de ${data.count} opera√ß√µes`;
                }
                if (countElement) {
                    countElement.textContent = `${data.count} ops`;
                }
            } catch (error) {
                console.error(`Erro ao atualizar card ${type}:`, error);
            }
        }

        // Fun√ß√£o auxiliar para obter o ID correto do elemento
        function getElementId(type) {
            const typeMap = {
                'carregamento': 'Carregamento',
                'carregamento_Paletizado': 'Paletizado',
                'descarga': 'Descarga',
                'separacao': 'Separacao'
            };
            return typeMap[type] || type;
        }

        // Calcular efici√™ncia baseada no tempo m√©dio
        function calculateEfficiency(avgMinutes) {
            if (avgMinutes <= 0) return 0;
            
            // F√≥rmula de efici√™ncia: quanto menor o tempo, maior a efici√™ncia
            // Considerando 140 minutos como tempo ideal
            const idealTime = 140;
            const maxEfficiency = 100;
            
            if (avgMinutes <= idealTime) {
                return Math.round(maxEfficiency);
            } else {
                // Penaliza√ß√£o progressiva para tempos acima do ideal
                const penalty = Math.min(100, ((avgMinutes - idealTime) / idealTime) * 100);
                return Math.round(Math.max(0, maxEfficiency - penalty));
            }
        }

        // Formatador de tempo
        function formatMinutesToTime(minutes) {
            if (isNaN(minutes) || minutes <= 0) return '0h00min';
            
            const hours = Math.floor(minutes / 60);
            const mins = Math.round(minutes % 60);
            return `${hours}h${mins.toString().padStart(2, '0')}min`;
        }

        // Atualizar grid de unidades com filtros
        function updateUnitsGrid() {
            unitsGrid.innerHTML = '';
            
            let filteredUnits = Object.keys(unitsConfig);
            
            // Aplicar filtros
            const sortValue = sortBy.value;
            const typeFilter = filterType.value;
            const statusFilter = filterStatus.value;
            
            // Filtrar por tipo
            if (typeFilter !== 'all') {
                filteredUnits = filteredUnits.filter(unitName => 
                    unitsConfig[unitName].type.toLowerCase().includes(typeFilter.toLowerCase())
                );
            }
            
            // Filtrar por status
            if (statusFilter !== 'all') {
                filteredUnits = filteredUnits.filter(unitName => {
                    const unitData = unitsData[unitName];
                    if (!unitData) return false;
                    
                    switch(statusFilter) {
                        case 'active':
                            return unitData.activeOperations > 0;
                        case 'completed':
                            return unitData.completedOperations > 0;
                        case 'efficient':
                            return unitData.efficiency >= 80;
                        case 'critical':
                            return unitData.efficiency < 60;
                        default:
                            return true;
                    }
                });
            }
            
            // Ordenar unidades
            filteredUnits.sort((a, b) => {
                const dataA = unitsData[a];
                const dataB = unitsData[b];
                
                if (!dataA || !dataB) return 0;
                
                switch(sortValue) {
                    case 'efficiency':
                        return dataB.efficiency - dataA.efficiency;
                    case 'completed':
                        return dataB.completedOperations - dataA.completedOperations;
                    case 'tons':
                        return dataB.totalTons - dataA.totalTons;
                    case 'time':
                        return dataA.avgTime - dataB.avgTime;
                    case 'name':
                    default:
                        return dataA.name.localeCompare(dataB.name);
                }
            });
            
            // Criar cards para unidades filtradas
            filteredUnits.forEach(unitName => {
                const unitData = unitsData[unitName];
                if (!unitData) {
                    unitsGrid.innerHTML += `
                        <div class="unit-card">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                            </div>
                            <p style="text-align: center; color: #666;">Carregando ${unitName}...</p>
                        </div>
                    `;
                    return;
                }
                
                const unitCard = document.createElement('div');
                unitCard.className = 'unit-card';
                unitCard.style.borderLeftColor = unitsConfig[unitName].color;
                
                // Determinar cor baseada na efici√™ncia
                const efficiencyColor = unitData.efficiency >= 80 ? '#4CAF50' : 
                                      unitData.efficiency >= 60 ? '#FF9800' : '#f44336';
                
                unitCard.innerHTML = `
                    <h3>${unitData.name}</h3>
                    <div class="unit-type">${unitData.type}</div>
                    
                    <div class="unit-stats">
                        <div class="stat-row">
                            <span class="stat-label">üìä Finalizados:</span>
                            <span class="stat-value">${unitData.completedOperations}</span>
                        </div>
                        
                        <div class="stat-row">
                            <span class="stat-label">üöö Docas ocupadas:</span>
                            <span class="stat-value">${unitData.occupiedDocks}/${unitData.totalDocks}</span>
                        </div>
                        
                        <div class="stat-row">
                            <span class="stat-label">‚è±Ô∏è Tempo m√©dio:</span>
                            <span class="stat-value">${formatMinutesToTime(unitData.avgTime)}</span>
                        </div>
                        
                        <div class="stat-row">
                            <span class="stat-label">üìà Efici√™ncia:</span>
                            <span class="stat-value" style="color: ${efficiencyColor}">
                                ${unitData.efficiency}%
                            </span>
                        </div>
                        
                        <div class="stat-row">
                            <span class="stat-label">‚öñÔ∏è Toneladas:</span>
                            <span class="stat-value">${unitData.totalTons.toFixed(1)}/${unitData.metaToneladas}</span>
                        </div>
                        
                        <div class="stat-row">
                            <span class="stat-label">üîÑ Composi√ß√µes ativas:</span>
                            <span class="stat-value">${unitData.activeCompositions}</span>
                        </div>
                        
                        <div class="progress">
                            <div class="progress-bar" style="width: ${unitData.metaProgress}%; background-color: ${unitsConfig[unitName].color}"></div>
                        </div>
                        
                        <div style="margin-top: 10px; font-size: 12px; color: #666;">
                            <span class="status-badge status-completed">${unitData.completedOperations} finalizados</span>
                            <span class="status-badge status-active">${unitData.activeOperations} ativos</span>
                            <span class="status-badge status-paused">${unitData.pausedOperations} pausados</span>
                        </div>
                    </div>
                    
                    <div class="unit-footer">
                        <span class="last-update">üïí ${unitData.lastUpdate.toLocaleTimeString('pt-BR')}</span>
                        <button class="btn-access" onclick="accessUnit('${unitName}')">
                            üîç Detalhes
                        </button>
                    </div>
                `;
                
                unitsGrid.appendChild(unitCard);
            });

            // Mensagem se n√£o houver unidades
            if (filteredUnits.length === 0) {
                unitsGrid.innerHTML = `
                    <div class="unit-card" style="grid-column: 1 / -1; text-align: center;">
                        <h3>Nenhuma unidade encontrada</h3>
                        <p style="color: #666;">Tente ajustar os filtros para ver mais resultados.</p>
                    </div>
                `;
            }
        }

        // Preencher selects de compara√ß√£o
        function populateCompareSelects() {
            compareUnit1.innerHTML = '<option value="">Selecione a 1¬™ unidade</option>';
            compareUnit2.innerHTML = '<option value="">Selecione a 2¬™ unidade</option>';
            
            allUnitsList.forEach(unitName => {
                const option1 = document.createElement('option');
                option1.value = unitName;
                option1.textContent = unitsConfig[unitName].name;
                compareUnit1.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = unitName;
                option2.textContent = unitsConfig[unitName].name;
                compareUnit2.appendChild(option2);
            });
            
            // Habilitar/desabilitar bot√£o de compara√ß√£o
            [compareUnit1, compareUnit2].forEach(select => {
                select.addEventListener('change', () => {
                    btnCompare.disabled = !(compareUnit1.value && compareUnit2.value && compareUnit1.value !== compareUnit2.value);
                });
            });
        }

        // Acessar unidade espec√≠fica - AGORA MUDA A UNIDADE DO USU√ÅRIO
        async function accessUnit(unitName) {
            try {
                // Atualizar a unidade do usu√°rio no Firestore
                await db.collection('users').doc(currentUser.uid).update({
                    unit: unitName
                });
                
                // Atualizar localmente
                currentUnit = unitName;
                userData.unit = unitName;
                userUnitInfo.textContent = `Usu√°rio: ${userData.name} | Unidade atual: ${currentUnit}`;
                
                // Redirecionar para o painel da unidade espec√≠fica
                window.location.href = `painel_controle.html?unit=${encodeURIComponent(unitName)}`;
                
            } catch (error) {
                console.error("Erro ao mudar unidade:", error);
                alert('Erro ao mudar unidade. Tente novamente.');
            }
        }

        // Abrir modal de mudan√ßa de unidade
        function openUnitModal() {
            unitSelect.value = currentUnit;
            unitModal.style.display = 'block';
        }

        // Fechar modal de mudan√ßa de unidade
        function closeUnitModal() {
            unitModal.style.display = 'none';
        }

        // Confirmar mudan√ßa de unidade
        async function confirmUnitChange() {
            const selectedUnit = unitSelect.value;
            
            if (!selectedUnit) {
                alert('Por favor, selecione uma unidade.');
                return;
            }
            
            if (selectedUnit === currentUnit) {
                alert('Voc√™ j√° est√° nesta unidade.');
                closeUnitModal();
                return;
            }
            
            try {
                await db.collection('users').doc(currentUser.uid).update({
                    unit: selectedUnit
                });
                
                currentUnit = selectedUnit;
                userData.unit = selectedUnit;
                userUnitInfo.textContent = `Usu√°rio: ${userData.name} | Unidade atual: ${currentUnit}`;
                
                closeUnitModal();
                alert(`Unidade alterada para: ${selectedUnit}`);
                
                // Recarregar dados
                loadAllUnitsData();
                
            } catch (error) {
                console.error("Erro ao atualizar unidade:", error);
                alert('Erro ao alterar unidade. Tente novamente.');
            }
        }

        // Comparar unidades
        btnCompare.addEventListener('click', () => {
            const unit1 = compareUnit1.value;
            const unit2 = compareUnit2.value;
            
            if (unit1 && unit2 && unit1 !== unit2) {
                compareUnits(unit1, unit2);
            }
        });

        // Fun√ß√£o de compara√ß√£o entre unidades
        function compareUnits(unit1, unit2) {
            const data1 = unitsData[unit1];
            const data2 = unitsData[unit2];
            
            if (!data1 || !data2) {
                alert('Dados das unidades n√£o dispon√≠veis para compara√ß√£o');
                return;
            }
            
            // Fun√ß√£o auxiliar para determinar qual valor √© melhor
            function getComparisonClass(value1, value2, lowerIsBetter = false) {
                if (value1 === value2) return 'equal-value';
                if (lowerIsBetter) {
                    return value1 < value2 ? 'better-value' : 'worse-value';
                } else {
                    return value1 > value2 ? 'better-value' : 'worse-value';
                }
            }
            
            const comparisonHtml = `
                <div class="compare-container">
                    <div class="compare-header">
                        <div class="compare-unit">${data1.name}</div>
                        <div class="compare-unit">${data2.name}</div>
                    </div>
                    
                    <div class="compare-metric">
                        <div class="compare-metric-label">üìä Opera√ß√µes Finalizadas</div>
                        <div class="compare-metric-value ${getComparisonClass(data1.completedOperations, data2.completedOperations)}">
                            ${data1.completedOperations}
                        </div>
                        <div class="compare-metric-value ${getComparisonClass(data2.completedOperations, data1.completedOperations)}">
                            ${data2.completedOperations}
                        </div>
                    </div>
                    
                    <div class="compare-metric">
                        <div class="compare-metric-label">üöö Docas Ocupadas</div>
                        <div class="compare-metric-value ${getComparisonClass(data1.occupiedDocks, data2.occupiedDocks)}">
                            ${data1.occupiedDocks}/${data1.totalDocks}
                        </div>
                        <div class="compare-metric-value ${getComparisonClass(data2.occupiedDocks, data1.occupiedDocks)}">
                            ${data2.occupiedDocks}/${data2.totalDocks}
                        </div>
                    </div>
                    
                    <div class="compare-metric">
                        <div class="compare-metric-label">‚è±Ô∏è Tempo M√©dio</div>
                        <div class="compare-metric-value ${getComparisonClass(data1.avgTime, data2.avgTime, true)}">
                            ${formatMinutesToTime(data1.avgTime)}
                        </div>
                        <div class="compare-metric-value ${getComparisonClass(data2.avgTime, data1.avgTime, true)}">
                            ${formatMinutesToTime(data2.avgTime)}
                        </div>
                    </div>
                    
                    <div class="compare-metric">
                        <div class="compare-metric-label">üìà Efici√™ncia</div>
                        <div class="compare-metric-value ${getComparisonClass(data1.efficiency, data2.efficiency)}">
                            ${data1.efficiency}%
                        </div>
                        <div class="compare-metric-value ${getComparisonClass(data2.efficiency, data1.efficiency)}">
                            ${data2.efficiency}%
                        </div>
                    </div>
                    
                    <div class="compare-metric">
                        <div class="compare-metric-label">‚öñÔ∏è Toneladas</div>
                        <div class="compare-metric-value ${getComparisonClass(data1.totalTons, data2.totalTons)}">
                            ${data1.totalTons.toFixed(1)}
                        </div>
                        <div class="compare-metric-value ${getComparisonClass(data2.totalTons, data1.totalTons)}">
                            ${data2.totalTons.toFixed(1)}
                        </div>
                    </div>
                    
                    <div class="compare-metric">
                        <div class="compare-metric-label">üéØ Progresso da Meta</div>
                        <div class="compare-metric-value ${getComparisonClass(data1.metaProgress, data2.metaProgress)}">
                            ${data1.metaProgress.toFixed(1)}%
                        </div>
                        <div class="compare-metric-value ${getComparisonClass(data2.metaProgress, data1.metaProgress)}">
                            ${data2.metaProgress.toFixed(1)}%
                        </div>
                    </div>
                    
                    <div class="compare-metric">
                        <div class="compare-metric-label">üîÑ Composi√ß√µes Ativas</div>
                        <div class="compare-metric-value ${getComparisonClass(data1.activeCompositions, data2.activeCompositions)}">
                            ${data1.activeCompositions}
                        </div>
                        <div class="compare-metric-value ${getComparisonClass(data2.activeCompositions, data1.activeCompositions)}">
                            ${data2.activeCompositions}
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="closeComparison()" class="btn-compare" style="background: #666;">
                            ‚ùå Fechar Compara√ß√£o
                        </button>
                    </div>
                </div>
            `;
            
            compareContainer.innerHTML = comparisonHtml;
            
            // Scroll suave para a compara√ß√£o
            compareContainer.scrollIntoView({ behavior: 'smooth' });
        }

        // Fechar compara√ß√£o
        function closeComparison() {
            compareContainer.innerHTML = '';
        }

        // Mostrar indicador de atualiza√ß√£o
        function showAutoUpdateIndicator() {
            autoUpdateIndicator.style.display = 'block';
        }

        // Esconder indicador de atualiza√ß√£o
        function hideAutoUpdateIndicator() {
            autoUpdateIndicator.style.display = 'none';
        }

        // Event Listeners para mudan√ßa de unidade
        changeUnitBtn.addEventListener('click', openUnitModal);
        unitCloseBtn.addEventListener('click', closeUnitModal);
        unitCancelBtn.addEventListener('click', closeUnitModal);
        unitConfirmBtn.addEventListener('click', confirmUnitChange);

        // Fechar modal clicando fora
        window.addEventListener('click', (e) => {
            if (e.target === unitModal) {
                closeUnitModal();
            }
        });

        // Logout
        document.querySelector('.logout-btn').addEventListener('click', function() {
            if (confirm('Tem certeza que deseja sair do sistema?')) {
                auth.signOut().then(() => {
                    window.location.href = 'index.html';
                }).catch((error) => {
                    console.error('Erro ao fazer logout:', error);
                });
            }
        });

        // Destacar link ativo na navbar
        const currentPage = window.location.pathname.split('/').pop();
        const navLinks = document.querySelectorAll('.nav-links a');
        
        navLinks.forEach(link => {
            const linkPage = link.getAttribute('href');
            if (currentPage === linkPage) {
                link.classList.add('active');
            } else {
                link.classList.remove('active');
            }
        });
    </script>
</body>
</html>
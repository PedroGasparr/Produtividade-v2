<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Histórico - Sistema de Operação</title>
    <!-- Importar Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- Biblioteca para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="../css/historico.css">
    <style>
        /* Estilos para os cards de resumo */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #4a6da7;
            transition: transform 0.3s;
        }

        .summary-card:hover {
            transform: translateY(-2px);
        }
        
        .summary-card h3 {
            margin: 0 0 15px 0;
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .summary-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .summary-card .sub-value {
            font-size: 14px;
            color: #666;
        }

        /* Cards específicos para tipos de operação */
        .summary-card.carregamento {
            border-left-color: #4CAF50;
        }

        .summary-card.carregamento-paletizado {
            border-left-color: #2196F3;
        }

        .summary-card.descarga {
            border-left-color: #FF9800;
        }

        .summary-card.separacao {
            border-left-color: #9C27B0;
        }
        
        /* Estilos para a tabela */
        .table-container {
            overflow-x: auto;
            width: 100%;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }
        
        .history-table th,
        .history-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
        }
        
        .history-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }
        
        .history-table tr:hover {
            background-color: #f8f9fa;
        }
        
        /* Status badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
        }
        
        .status-completed {
            background-color: #4caf50;
            color: white;
        }
        
        .status-active {
            background-color: #2196f3;
            color: white;
        }
        
        .status-paused {
            background-color: #ff9800;
            color: white;
        }
        
        /* Botões de ação */
        .edit-btn {
            background: #4a6da7;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .edit-btn:hover {
            background: #3a5a8f;
        }

        .expand-btn {
            background: none;
            border: none;
            color: #4a6da7;
            cursor: pointer;
            font-size: 14px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Linha de detalhes */
        .details-row {
            background-color: #fafafa;
        }
        
        .details-content {
            padding: 20px;
            border-top: 1px solid #eee;
        }
        
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .detail-group {
            margin-bottom: 15px;
        }
        
        .detail-label {
            font-weight: 600;
            color: #2c3e50;
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .detail-value {
            color: #666;
            font-size: 14px;
        }
        
        /* Botão de PDF */
        .pdf-btn {
            background-color: #d32f2f;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .pdf-btn:hover {
            background-color: #b71c1c;
        }
        
        /* Botão de mudança de unidade */
        .change-unit-btn {
            background-color: #4a6da7;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
            transition: background-color 0.3s;
        }
        
        .change-unit-btn:hover {
            background-color: #3a5a8f;
        }
        
        /* Modal de mudança de unidade */
        .unit-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .unit-modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 25px;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .unit-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .unit-modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .unit-close-btn {
            font-size: 24px;
            cursor: pointer;
            color: #777;
            transition: color 0.3s;
        }
        
        .unit-close-btn:hover {
            color: #333;
        }
        
        .unit-select {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .unit-modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .unit-cancel-btn, .unit-confirm-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .unit-cancel-btn {
            background-color: #f0f0f0;
            color: #333;
        }

        .unit-cancel-btn:hover {
            background-color: #e0e0e0;
        }
        
        .unit-confirm-btn {
            background-color: #4a6da7;
            color: white;
        }
        
        .unit-confirm-btn:hover {
            background-color: #3a5a8f;
        }

        /* Modal de edição */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }

        .close-btn {
            font-size: 24px;
            cursor: pointer;
            color: #777;
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: #333;
        }

        .modal-body {
            padding: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: #4a6da7;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 20px 25px;
            border-top: 1px solid #eee;
        }

        .cancel-btn, .save-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .cancel-btn {
            background-color: #f0f0f0;
            color: #333;
        }

        .cancel-btn:hover {
            background-color: #e0e0e0;
        }

        .save-btn {
            background-color: #4a6da7;
            color: white;
        }

        .save-btn:hover {
            background-color: #3a5a8f;
        }

        @media (max-width: 768px) {
            .summary-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <span>Prod</span>Plan
            </div>
            
            <ul class="nav-links">
                <li><a href="operacao.html">Operação</a></li>
                <li><a href="cadastrar_funcionario.html">Cadastrar Funcionário</a></li>
                <li><a href="buscar_funcionario.html">Buscar Funcionário</a></li>
                <li><a href="ranking.html">Ranking</a></li>
                <li><a href="painel_controle.html">Painel de Controle</a></li>
                <li><a href="historico.html" class="active">Histórico</a></li>
            </ul>
            
            <div class="user-section">
                <div class="user-info">
                    <div class="user-name">Carregando...</div>
                    <div class="user-role"></div>
                </div>
                <button class="change-unit-btn" id="changeUnitBtn">Mudar Unidade</button>
                <button class="logout-btn">Sair</button>
            </div>
        </div>
    </nav>
    
    <div class="content">
        <h1 class="page-title">Histórico de Carregamentos</h1>
        
        <div class="user-unit-info" id="userUnitInfo">
            Carregando informações da unidade...
        </div>
        
        <div class="password-section" id="passwordSection">
            <h2>Acesso ao Histórico</h2>
            <p>Para acessar o histórico, digite a senha de administração:</p>
            <div style="margin: 20px 0;">
                <input type="password" id="passwordInput" class="password-input" placeholder="Digite a senha">
                <button id="passwordBtn" class="password-btn">Acessar</button>
            </div>
            <div class="error-message" id="passwordError"></div>
        </div>
        
        <div class="filters-container" id="filtersContainer" style="display: none;">
            <div class="filters-header">
                <h2 class="filters-title">Filtros</h2>
            </div>
            
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">Data Inicial</label>
                    <input type="date" id="startDate" class="filter-input">
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Data Final</label>
                    <input type="date" id="endDate" class="filter-input">
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Status</label>
                    <select id="statusFilter" class="filter-select">
                        <option value="">Todos</option>
                        <option value="completed">Concluído</option>
                        <option value="active">Em Andamento</option>
                        <option value="paused">Pausado</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Tipo</label>
                    <select id="typeFilter" class="filter-select">
                        <option value="">Todos</option>
                        <option value="carregamento">Carregamento</option>
                        <option value="carregamento_Paletizado">Carregamento Paletizado</option>
                        <option value="descarga">Descarga</option>
                        <option value="separacao">Separação</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Colaborador</label>
                    <select id="employeeFilter" class="filter-select">
                        <option value="">Todos</option>
                        <!-- Opções serão preenchidas via JavaScript -->
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Doca</label>
                    <input type="text" id="dockFilter" class="filter-input" placeholder="Número da doca">
                </div>
            </div>
            
            <div class="filter-buttons">
                <button id="clearFilters" class="filter-btn clear-btn">Limpar Filtros</button>
                <button id="applyFilters" class="filter-btn apply-btn">Aplicar Filtros</button>
                <button id="generatePDF" class="pdf-btn">Gerar PDF do Dia</button>
            </div>
        </div>

        <!-- Cards de Resumo -->
        <div class="summary-cards" id="summaryCards" style="display: none;">
            <div class="summary-card">
                <h3>Tempo Total</h3>
                <div class="value" id="totalTime">0h 0min</div>
                <div class="sub-value" id="totalMinutes">0 minutos</div>
            </div>
            
            <div class="summary-card">
                <h3>Tempo Médio Geral</h3>
                <div class="value" id="avgTime">0h 0min</div>
                <div class="sub-value" id="avgMinutes">0 minutos</div>
            </div>
            
            <div class="summary-card">
                <h3>Volume Total Carregado</h3>
                <div class="value" id="totalTons">0</div>
                <div class="sub-value">toneladas</div>
            </div>
            
            <div class="summary-card">
                <h3>Total de Mix</h3>
                <div class="value" id="totalMix">0</div>
                <div class="sub-value">tipos de material</div>
            </div>
            
            <div class="summary-card">
                <h3>Operações Realizadas</h3>
                <div class="value" id="totalOperations">0</div>
                <div class="sub-value">carregamentos</div>
            </div>

            <!-- Novos cards para tempo médio por tipo de operação -->
            <div class="summary-card carregamento">
                <h3>Tempo Médio - Carregamento</h3>
                <div class="value" id="avgTimeCarregamento">0h 0min</div>
                <div class="sub-value" id="avgMinutesCarregamento">0 minutos</div>
            </div>
            
            <div class="summary-card carregamento-paletizado">
                <h3>Tempo Médio - Carreg. Paletizado</h3>
                <div class="value" id="avgTimePaletizado">0h 0min</div>
                <div class="sub-value" id="avgMinutesPaletizado">0 minutos</div>
            </div>
            
            <div class="summary-card descarga">
                <h3>Tempo Médio - Descarga</h3>
                <div class="value" id="avgTimeDescarga">0h 0min</div>
                <div class="sub-value" id="avgMinutesDescarga">0 minutos</div>
            </div>
            
            <div class="summary-card separacao">
                <h3>Tempo Médio - Separação</h3>
                <div class="value" id="avgTimeSeparacao">0h 0min</div>
                <div class="sub-value" id="avgMinutesSeparacao">0 minutos</div>
            </div>
        </div>
        
        <div class="history-container" id="historyContainer" style="display: none;">
            <div class="history-header">
                <h2 class="history-title">Histórico de Carregamentos</h2>
                <div class="history-summary" id="historySummary">Mostrando 0 registros</div>
            </div>
            
            <div class="loading" id="historyLoading">
                <div class="loading-spinner"></div>
            </div>
            
            <div class="no-data" id="historyNoData" style="display: none;">
                Nenhum dado encontrado com os filtros aplicados.
            </div>
            
            <div class="table-container">
                <table class="history-table" id="historyTable" style="display: none;">
                    <thead>
                        <tr>
                            <th style="width: 40px;"></th>
                            <th>Data/Hora Início</th>
                            <th>Data/Hora Fim</th>
                            <th>Colaborador Principal</th>
                            <th>Outros Colaboradores</th>
                            <th>Tipo</th>
                            <th>Status</th>
                            <th>Doca</th>
                            <th>DT</th>
                            <th>Toneladas</th>
                            <th>Mix</th>
                            <th>Veículo</th>
                            <th>Tempo Total</th>
                            <th style="width: 80px;">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <!-- Dados serão preenchidos via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Modal de Edição -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Editar Carregamento</h2>
                <span class="close-btn" id="closeModal">&times;</span>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Número DT</label>
                    <input type="text" id="editDockNumber" class="form-input">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Toneladas</label>
                    <input type="number" id="editTons" class="form-input" step="0.1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Mix de Material</label>
                    <input type="number" id="editMix" class="form-input">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tipo de Veículo</label>
                    <input type="text" id="editVehicle" class="form-input">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Observações</label>
                    <textarea id="editObservation" class="form-input" rows="3"></textarea>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="cancel-btn" id="cancelEdit">Cancelar</button>
                <button class="save-btn" id="saveEdit">Salvar Alterações</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Mudança de Unidade -->
    <div class="unit-modal" id="unitModal">
        <div class="unit-modal-content">
            <div class="unit-modal-header">
                <h2 class="unit-modal-title">Mudar Unidade</h2>
                <span class="unit-close-btn" id="unitCloseBtn">&times;</span>
            </div>
            
            <div class="modal-body">
                <p>Selecione a unidade para a qual deseja mudar:</p>
                <select id="unitSelect" class="unit-select">
                    <option value="">Selecione uma unidade</option>
                    <option value="Unidade Maracanau">Unidade Maracanau</option>
                    <option value="Unidade Belem">Unidade Belem</option>
                    <option value="Unidade Mogi Das Cruzes">Unidade Mogi Das Cruzes</option>
                    <option value="Unidade Imperatriz">Unidade Imperatriz</option>
                    <option value="Unidade Cariacica">Unidade Cariacica</option>
                    <option value="Unidade Aracruz">Unidade Aracruz</option>
                    <option value="Unidade Teste">Unidade Teste</option>
                    <option value="Unidade Teste Jonh Dree">Unidade Teste Jonh Dree</option>
                </select>
            </div>
            
            <div class="unit-modal-actions">
                <button class="unit-cancel-btn" id="unitCancelBtn">Cancelar</button>
                <button class="unit-confirm-btn" id="unitConfirmBtn">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCMu17OV-5ST1rlg00zbpt6Hv37GKqkX4A",
            authDomain: "projetos-d868d.firebaseapp.com",
            databaseURL: "https://projetos-d868d-default-rtdb.firebaseio.com",
            projectId: "projetos-d868d",
            storageBucket: "projetos-d868d.firebasestorage.app",
            messagingSenderId: "420029352781",
            appId: "1:420029352781:web:05176699348e0ccdd78504",
            measurementId: "G-FXWXRX04WF"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Elementos da interface
        const userNameElement = document.querySelector('.user-name');
        const userUnitInfo = document.getElementById('userUnitInfo');
        const passwordSection = document.getElementById('passwordSection');
        const passwordInput = document.getElementById('passwordInput');
        const passwordBtn = document.getElementById('passwordBtn');
        const passwordError = document.getElementById('passwordError');
        const filtersContainer = document.getElementById('filtersContainer');
        const historyContainer = document.getElementById('historyContainer');
        const historyLoading = document.getElementById('historyLoading');
        const historyNoData = document.getElementById('historyNoData');
        const historyTable = document.getElementById('historyTable');
        const historyTableBody = document.getElementById('historyTableBody');
        const historySummary = document.getElementById('historySummary');
        const editModal = document.getElementById('editModal');
        const summaryCards = document.getElementById('summaryCards');
        const generatePDFBtn = document.getElementById('generatePDF');
        
        // Elementos do modal de mudança de unidade
        const changeUnitBtn = document.getElementById('changeUnitBtn');
        const unitModal = document.getElementById('unitModal');
        const unitSelect = document.getElementById('unitSelect');
        const unitCloseBtn = document.getElementById('unitCloseBtn');
        const unitCancelBtn = document.getElementById('unitCancelBtn');
        const unitConfirmBtn = document.getElementById('unitConfirmBtn');
        
        // Elementos dos cards de resumo
        const totalTimeElement = document.getElementById('totalTime');
        const totalMinutesElement = document.getElementById('totalMinutes');
        const avgTimeElement = document.getElementById('avgTime');
        const avgMinutesElement = document.getElementById('avgMinutes');
        const totalTonsElement = document.getElementById('totalTons');
        const totalMixElement = document.getElementById('totalMix');
        const totalOperationsElement = document.getElementById('totalOperations');
        
        // Novos elementos para cards de tempo médio por tipo
        const avgTimeCarregamentoElement = document.getElementById('avgTimeCarregamento');
        const avgMinutesCarregamentoElement = document.getElementById('avgMinutesCarregamento');
        const avgTimePaletizadoElement = document.getElementById('avgTimePaletizado');
        const avgMinutesPaletizadoElement = document.getElementById('avgMinutesPaletizado');
        const avgTimeDescargaElement = document.getElementById('avgTimeDescarga');
        const avgMinutesDescargaElement = document.getElementById('avgMinutesDescarga');
        const avgTimeSeparacaoElement = document.getElementById('avgTimeSeparacao');
        const avgMinutesSeparacaoElement = document.getElementById('avgMinutesSeparacao');
        
        // Estado da aplicação
        let currentUser = null;
        let userData = null;
        let currentUnit = '';
        let operationsData = [];
        let employeesData = [];
        let currentEditId = null;
        let expandedRows = new Set();
        const ADMIN_PASSWORD = "195#%$*7advan!7"; // Senha de administração
        
        // Verificar autenticação
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                userNameElement.textContent = 'Carregando...';
                
                // Buscar dados do usuário no Firestore
                db.collection('users').doc(user.uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        userData = doc.data();
                        userNameElement.textContent = userData.name;
                        currentUnit = userData.unit;
                        userUnitInfo.textContent = `Unidade atual: ${currentUnit}`;
                        
                        // Carregar dados dos colaboradores para o filtro
                        loadEmployeesData();
                    } else {
                        console.error("Documento do usuário não encontrado");
                    }
                })
                .catch((error) => {
                    console.error("Erro ao buscar dados do usuário:", error);
                });
            } else {
                // Usuário não autenticado, redirecionar para login
                window.location.href = 'login.html';
            }
        });
        
        // Carregar dados dos colaboradores
        function loadEmployeesData() {
            db.collection('colaboradores')
                .where('unidade', '==', currentUnit)
                .get()
                .then((querySnapshot) => {
                    employeesData = [];
                    const employeeFilter = document.getElementById('employeeFilter');
                    
                    // Adicionar opção "Todos"
                    employeeFilter.innerHTML = '<option value="">Todos</option>';
                    
                    querySnapshot.forEach((doc) => {
                        const employeeData = {
                            id: doc.id,
                            ...doc.data()
                        };
                        
                        employeesData.push(employeeData);
                        
                        // Adicionar ao filtro
                        const option = document.createElement('option');
                        option.value = employeeData.codigo;
                        option.textContent = employeeData.nome;
                        employeeFilter.appendChild(option);
                    });
                })
                .catch((error) => {
                    console.error("Erro ao carregar colaboradores:", error);
                });
        }
        
        // Verificar senha de administração
        function checkPassword() {
            const password = passwordInput.value.trim();
            
            if (password === ADMIN_PASSWORD) {
                passwordError.style.display = 'none';
                passwordSection.style.display = 'none';
                filtersContainer.style.display = 'block';
                historyContainer.style.display = 'block';
                summaryCards.style.display = 'grid';
                loadHistoryData();
            } else {
                passwordError.textContent = 'Senha incorreta. Tente novamente.';
                passwordError.style.display = 'block';
            }
        }
        
        // Carregar dados do histórico
        function loadHistoryData() {
            showHistoryLoading();
            
            // Buscar operações da unidade atual
            db.collection('operations')
                .where('unit', '==', currentUnit)
                .orderBy('createdAt', 'desc')
                .get()
                .then((querySnapshot) => {
                    operationsData = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        operationsData.push({
                            id: doc.id,
                            ...data
                        });
                    });
                    
                    // Aplicar filtros iniciais
                    applyFilters();
                })
                .catch((error) => {
                    console.error("Erro ao carregar histórico:", error);
                    showHistoryError('Erro ao carregar histórico.');
                });
        }
        
        // Função corrigida para filtrar datas
        function filterByDate(data, startDate, endDate) {
            return data.filter(operation => {
                const operationDate = operation.createdAt ? operation.createdAt.toDate() : new Date(0);
                
                // Se não há filtro de data, incluir todas as operações
                if (!startDate && !endDate) {
                    return true;
                }
                
                let include = true;
                
                // Filtro de data inicial
                if (startDate) {
                    const start = new Date(startDate);
                    start.setHours(0, 0, 0, 0); // Início do dia
                    if (operationDate < start) {
                        include = false;
                    }
                }
                
                // Filtro de data final
                if (endDate) {
                    const end = new Date(endDate);
                    end.setHours(23, 59, 59, 999); // Final do dia
                    if (operationDate > end) {
                        include = false;
                    }
                }
                
                return include;
            });
        }
        
        // Aplicar filtros
        function applyFilters() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const status = document.getElementById('statusFilter').value;
            const type = document.getElementById('typeFilter').value;
            const employee = document.getElementById('employeeFilter').value;
            const dock = document.getElementById('dockFilter').value.toLowerCase();
            
            let filteredData = operationsData;
            
            // Filtrar por data (função corrigida)
            filteredData = filterByDate(filteredData, startDate, endDate);
            
            // Filtrar por status
            if (status) {
                filteredData = filteredData.filter(op => op.status === status);
            }
            
            // Filtrar por tipo
            if (type) {
                filteredData = filteredData.filter(op => op.type === type);
            }
            
            // Filtrar por colaborador
            if (employee) {
                filteredData = filteredData.filter(op => 
                    op.employeeCode === employee || 
                    (op.additionalLoaders && op.additionalLoaders.includes(employee))
                );
            }
            
            // Filtrar por doca
            if (dock) {
                filteredData = filteredData.filter(op => 
                    (op.dock && op.dock.toLowerCase().includes(dock)) ||
                    (op.dockNumber && op.dockNumber.toLowerCase().includes(dock))
                );
            }
            
            // Exibir dados filtrados
            displayHistoryData(filteredData);
            updateSummaryCards(filteredData);
        }
        
        // Atualizar cards de resumo
        function updateSummaryCards(data) {
            const completedOperations = data.filter(op => op.status === 'completed');
            
            // Calcular totais gerais
            const totalTons = completedOperations.reduce((sum, op) => sum + (op.tonsLoaded || 0), 0);
            const totalMix = completedOperations.reduce((sum, op) => sum + (op.materialMix || 0), 0);
            const totalOperationsCount = completedOperations.length;
            
            // Calcular tempo total e médio geral
            let totalMinutes = 0;
            completedOperations.forEach(op => {
                if (op.startTime && op.endTime) {
                    const start = op.startTime.toDate();
                    const end = op.endTime.toDate();
                    const duration = (end - start) / (1000 * 60); // minutos
                    totalMinutes += duration;
                }
            });
            
            const avgMinutes = totalOperationsCount > 0 ? totalMinutes / totalOperationsCount : 0;
            
            // Atualizar elementos gerais
            totalTonsElement.textContent = totalTons.toFixed(1);
            totalMixElement.textContent = totalMix;
            totalOperationsElement.textContent = totalOperationsCount;
            
            // Formatando tempo geral
            const totalHours = Math.floor(totalMinutes / 60);
            const totalMins = Math.round(totalMinutes % 60);
            totalTimeElement.textContent = `${totalHours}h ${totalMins}min`;
            totalMinutesElement.textContent = `${Math.round(totalMinutes)} minutos`;
            
            const avgHours = Math.floor(avgMinutes / 60);
            const avgMins = Math.round(avgMinutes % 60);
            avgTimeElement.textContent = `${avgHours}h ${avgMins}min`;
            avgMinutesElement.textContent = `${Math.round(avgMinutes)} minutos`;
            
            // Calcular tempo médio por tipo de operação
            calculateAverageTimeByType(completedOperations);
        }
        
        // Calcular tempo médio por tipo de operação
        function calculateAverageTimeByType(completedOperations) {
            const types = {
                'carregamento': { totalMinutes: 0, count: 0 },
                'carregamento_Paletizado': { totalMinutes: 0, count: 0 },
                'descarga': { totalMinutes: 0, count: 0 },
                'separacao': { totalMinutes: 0, count: 0 }
            };
            
            // Calcular tempo total para cada tipo
            completedOperations.forEach(op => {
                if (op.startTime && op.endTime && types[op.type]) {
                    const start = op.startTime.toDate();
                    const end = op.endTime.toDate();
                    const duration = (end - start) / (1000 * 60); // minutos
                    
                    types[op.type].totalMinutes += duration;
                    types[op.type].count += 1;
                }
            });
            
            // Atualizar cards para cada tipo
            updateTypeCard('carregamento', types.carregamento, avgTimeCarregamentoElement, avgMinutesCarregamentoElement);
            updateTypeCard('carregamento_Paletizado', types.carregamento_Paletizado, avgTimePaletizadoElement, avgMinutesPaletizadoElement);
            updateTypeCard('descarga', types.descarga, avgTimeDescargaElement, avgMinutesDescargaElement);
            updateTypeCard('separacao', types.separacao, avgTimeSeparacaoElement, avgMinutesSeparacaoElement);
        }
        
        // Atualizar card individual de tipo
        function updateTypeCard(typeName, typeData, timeElement, minutesElement) {
            const avgMinutes = typeData.count > 0 ? typeData.totalMinutes / typeData.count : 0;
            const avgHours = Math.floor(avgMinutes / 60);
            const avgMins = Math.round(avgMinutes % 60);
            
            timeElement.textContent = `${avgHours}h ${avgMins}min`;
            minutesElement.textContent = `${Math.round(avgMinutes)} minutos (${typeData.count} ops)`;
        }
        
        // Exibir dados do histórico
        function displayHistoryData(data) {
            hideHistoryLoading();
            
            if (data.length === 0) {
                historyNoData.style.display = 'block';
                historyTable.style.display = 'none';
                historySummary.textContent = 'Nenhum registro encontrado';
                return;
            }
            
            historyNoData.style.display = 'none';
            historyTable.style.display = 'table';
            historySummary.textContent = `Mostrando ${data.length} de ${operationsData.length} registros`;
            
            // Limpar tabela
            historyTableBody.innerHTML = '';
            
            // Preencher tabela
            data.forEach(operation => {
                const isExpanded = expandedRows.has(operation.id);
                
                // Formatar datas
                const startDate = operation.startTime ? operation.startTime.toDate() : new Date(0);
                const endDate = operation.endTime ? operation.endTime.toDate() : new Date(0);
                const formattedStartDate = startDate.toLocaleString('pt-BR');
                const formattedEndDate = endDate > new Date(0) ? endDate.toLocaleString('pt-BR') : 'Em andamento';
                
                // Calcular tempo total
                let totalTime = 'N/A';
                if (operation.startTime && operation.endTime) {
                    const start = operation.startTime.toDate();
                    const end = operation.endTime.toDate();
                    const duration = (end - start) / (1000 * 60); // minutos
                    const hours = Math.floor(duration / 60);
                    const minutes = Math.round(duration % 60);
                    totalTime = `${hours}h ${minutes}min`;
                }
                
                // Encontrar nome do colaborador
                let employeeName = operation.employeeName || 'N/A';
                const employee = employeesData.find(emp => emp.codigo === operation.employeeCode);
                if (employee) {
                    employeeName = employee.nome;
                }
                
                // Formatar tipo de operação
                const typeMap = {
                    'carregamento': 'Carregamento',
                    'carregamento_Paletizado': 'Carreg. Paletizado',
                    'descarga': 'Descarga',
                    'separacao': 'Separação'
                };
                const formattedType = typeMap[operation.type] || operation.type;
                
                // Formatar status
                let statusClass = '';
                let statusText = '';
                
                switch (operation.status) {
                    case 'completed':
                        statusClass = 'status-completed';
                        statusText = 'Concluído';
                        break;
                    case 'active':
                        statusClass = 'status-active';
                        statusText = 'Em Andamento';
                        break;
                    case 'paused':
                        statusClass = 'status-paused';
                        statusText = 'Pausado';
                        break;
                    default:
                        statusClass = '';
                        statusText = operation.status || 'N/A';
                }
                
                // Linha principal
                const mainRow = document.createElement('tr');
                mainRow.innerHTML = `
                    <td>
                        <button class="expand-btn" data-id="${operation.id}">
                            ${isExpanded ? '▼' : '►'}
                        </button>
                    </td>
                    <td>${formattedStartDate}</td>
                    <td>${formattedEndDate}</td>
                    <td>${employeeName}</td>
                    <td>${operation.additionalLoaders ? operation.additionalLoaders.join(', ') : 'Nenhum'}</td>
                    <td>${formattedType}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>${operation.dock || 'N/A'}</td>
                    <td>${operation.dockNumber || 'N/A'}</td>
                    <td>${operation.tonsLoaded || '0'}</td>
                    <td>${operation.materialMix || '0'}</td>
                    <td>${operation.vehicleType || 'N/A'}</td>
                    <td>${totalTime}</td>
                    <td>
                        <button class="edit-btn" data-id="${operation.id}">Editar</button>
                    </td>
                `;
                
                historyTableBody.appendChild(mainRow);
                
                // Linha de detalhes (expandida)
                if (isExpanded) {
                    const detailsRow = document.createElement('tr');
                    detailsRow.className = 'details-row';
                    detailsRow.id = `details-${operation.id}`;
                    detailsRow.innerHTML = `
                        <td colspan="14">
                            <div class="details-content">
                                <div class="details-grid">
                                    <div class="detail-group">
                                        <span class="detail-label">Observações:</span>
                                        <span class="detail-value">${operation.observation || 'Nenhuma'}</span>
                                    </div>
                                    <div class="detail-group">
                                        <span class="detail-label">Motivo de Pausa:</span>
                                        <span class="detail-value">${operation.pauseReason || 'Nenhuma'}</span>
                                    </div>
                                    <div class="detail-group">
                                        <span class="detail-label">Motivo do Atraso (>10min):</span>
                                        <span class="detail-value">${operation.delayReason || 'Nenhum'}</span>
                                    </div>
                                    <div class="detail-group">
                                        <span class="detail-label">Armazéns Utilizados:</span>
                                        <span class="detail-value">${operation.warehouses ? operation.warehouses.join(', ') : 'N/A'}</span>
                                    </div>
                                    <div class="detail-group">
                                        <span class="detail-label">Composição:</span>
                                        <span class="detail-value">${operation.compositionNumber || 'N/A'}</span>
                                    </div>
                                    <div class="detail-group">
                                        <span class="detail-label">Carro Mantido em Doca:</span>
                                        <span class="detail-value">${operation.keepCarInDock ? 'Sim' : 'Não'}</span>
                                    </div>
                                </div>
                            </div>
                        </td>
                    `;
                    historyTableBody.appendChild(detailsRow);
                }
            });
            
            // Adicionar event listeners
            document.querySelectorAll('.expand-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const operationId = this.getAttribute('data-id');
                    toggleDetails(operationId);
                });
            });
            
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const operationId = this.getAttribute('data-id');
                    openEditModal(operationId);
                });
            });
        }
        
        // Alternar detalhes
        function toggleDetails(operationId) {
            if (expandedRows.has(operationId)) {
                expandedRows.delete(operationId);
            } else {
                expandedRows.add(operationId);
            }
            applyFilters();
        }
        
        // Abrir modal de edição
        function openEditModal(operationId) {
            const operation = operationsData.find(op => op.id === operationId);
            
            if (!operation) return;
            
            currentEditId = operationId;
            
            // Preencher formulário
            document.getElementById('editDockNumber').value = operation.dockNumber || '';
            document.getElementById('editTons').value = operation.tonsLoaded || '';
            document.getElementById('editMix').value = operation.materialMix || '';
            document.getElementById('editVehicle').value = operation.vehicleType || '';
            document.getElementById('editObservation').value = operation.observation || '';
            
            // Mostrar modal
            editModal.style.display = 'block';
        }
        
        // Fechar modal de edição
        function closeEditModal() {
            editModal.style.display = 'none';
            currentEditId = null;
        }
        
        // Salvar edição
        function saveEdit() {
            if (!currentEditId) return;
            
            const updates = {
                dockNumber: document.getElementById('editDockNumber').value,
                tonsLoaded: parseFloat(document.getElementById('editTons').value) || 0,
                materialMix: parseInt(document.getElementById('editMix').value) || 0,
                vehicleType: document.getElementById('editVehicle').value,
                observation: document.getElementById('editObservation').value
            };
            
            // Atualizar no Firestore
            db.collection('operations').doc(currentEditId).update(updates)
                .then(() => {
                    // Atualizar localmente
                    const operationIndex = operationsData.findIndex(op => op.id === currentEditId);
                    if (operationIndex !== -1) {
                        operationsData[operationIndex] = {
                            ...operationsData[operationIndex],
                            ...updates
                        };
                    }
                    
                    // Recarregar dados exibidos
                    applyFilters();
                    closeEditModal();
                })
                .catch((error) => {
                    console.error("Erro ao atualizar operação:", error);
                    alert('Erro ao salvar alterações. Tente novamente.');
                });
        }
        
        // Gerar PDF
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Título
            doc.setFontSize(20);
            doc.text('Relatório Diário de Carregamentos', 105, 15, { align: 'center' });
            
            // Informações da unidade e data
            doc.setFontSize(12);
            doc.text(`Unidade: ${currentUnit}`, 14, 25);
            doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 14, 32);
            
            // Filtros aplicados
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            let filtersText = 'Filtros: ';
            if (startDate) filtersText += `De ${startDate} `;
            if (endDate) filtersText += `Até ${endDate}`;
            if (!startDate && !endDate) filtersText += 'Todos os dados';
            doc.text(filtersText, 14, 39);
            
            // Dados para a tabela
            const filteredData = getFilteredData();
            const tableData = filteredData.map(op => {
                const start = op.startTime ? op.startTime.toDate().toLocaleString('pt-BR') : 'N/A';
                const end = op.endTime ? op.endTime.toDate().toLocaleString('pt-BR') : 'Em andamento';
                const employee = employeesData.find(emp => emp.codigo === op.employeeCode);
                const employeeName = employee ? employee.nome : op.employeeCode;
                
                return [
                    start,
                    end,
                    employeeName,
                    op.type,
                    op.dock || 'N/A',
                    op.dockNumber || 'N/A',
                    op.tonsLoaded || '0',
                    op.materialMix || '0',
                    op.vehicleType || 'N/A'
                ];
            });
            
            // Adicionar tabela
            doc.autoTable({
                startY: 45,
                head: [['Início', 'Fim', 'Colaborador', 'Tipo', 'Doca', 'DT', 'Toneladas', 'Mix', 'Veículo']],
                body: tableData,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [74, 109, 167] }
            });
            
            // Resumo
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(14);
            doc.text('Resumo', 14, finalY);
            
            doc.setFontSize(10);
            doc.text(`Total de Operações: ${totalOperationsElement.textContent}`, 14, finalY + 8);
            doc.text(`Volume Total: ${totalTonsElement.textContent} toneladas`, 14, finalY + 16);
            doc.text(`Mix Total: ${totalMixElement.textContent} tipos`, 14, finalY + 24);
            doc.text(`Tempo Total: ${totalTimeElement.textContent}`, 14, finalY + 32);
            doc.text(`Tempo Médio: ${avgTimeElement.textContent} por operação`, 14, finalY + 40);
            
            // Salvar PDF
            doc.save(`relatorio_carregamentos_${currentUnit}_${new Date().toISOString().split('T')[0]}.pdf`);
        }
        
        // Obter dados filtrados atuais
        function getFilteredData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const status = document.getElementById('statusFilter').value;
            const type = document.getElementById('typeFilter').value;
            const employee = document.getElementById('employeeFilter').value;
            const dock = document.getElementById('dockFilter').value.toLowerCase();
            
            let filteredData = operationsData;
            
            // Usar a função corrigida de filtro de data
            filteredData = filterByDate(filteredData, startDate, endDate);
            
            if (status) filteredData = filteredData.filter(op => op.status === status);
            if (type) filteredData = filteredData.filter(op => op.type === type);
            if (employee) {
                filteredData = filteredData.filter(op => 
                    op.employeeCode === employee || 
                    (op.additionalLoaders && op.additionalLoaders.includes(employee))
                );
            }
            if (dock) {
                filteredData = filteredData.filter(op => 
                    (op.dock && op.dock.toLowerCase().includes(dock)) ||
                    (op.dockNumber && op.dockNumber.toLowerCase().includes(dock))
                );
            }
            
            return filteredData;
        }
        
        // Mostrar loading do histórico
        function showHistoryLoading() {
            historyLoading.style.display = 'flex';
            historyNoData.style.display = 'none';
            historyTable.style.display = 'none';
        }
        
        // Ocultar loading do histórico
        function hideHistoryLoading() {
            historyLoading.style.display = 'none';
        }
        
        // Mostrar erro do histórico
        function showHistoryError(message) {
            historyLoading.style.display = 'none';
            historyNoData.textContent = message;
            historyNoData.style.display = 'block';
            historyTable.style.display = 'none';
        }
        
        // Limpar filtros
        function clearFilters() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('employeeFilter').value = '';
            document.getElementById('dockFilter').value = '';
            
            applyFilters();
        }
        
        // Funções para mudança de unidade
        function openUnitModal() {
            unitSelect.value = currentUnit;
            unitModal.style.display = 'block';
        }
        
        function closeUnitModal() {
            unitModal.style.display = 'none';
        }
        
        function confirmUnitChange() {
            const selectedUnit = unitSelect.value;
            
            if (!selectedUnit) {
                alert('Por favor, selecione uma unidade.');
                return;
            }
            
            if (selectedUnit === currentUnit) {
                alert('Você já está nesta unidade.');
                closeUnitModal();
                return;
            }
            
            db.collection('users').doc(currentUser.uid).update({
                unit: selectedUnit
            })
            .then(() => {
                currentUnit = selectedUnit;
                userUnitInfo.textContent = `Unidade atual: ${currentUnit}`;
                loadEmployeesData();
                
                if (historyContainer.style.display !== 'none') {
                    loadHistoryData();
                }
                
                closeUnitModal();
                alert(`Unidade alterada para: ${selectedUnit}`);
            })
            .catch((error) => {
                console.error("Erro ao atualizar unidade:", error);
                alert('Erro ao alterar unidade. Tente novamente.');
            });
        }
        
        // Event Listeners
        passwordBtn.addEventListener('click', checkPassword);
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') checkPassword();
        });
        
        document.getElementById('applyFilters').addEventListener('click', applyFilters);
        document.getElementById('clearFilters').addEventListener('click', clearFilters);
        generatePDFBtn.addEventListener('click', generatePDF);
        
        document.getElementById('closeModal').addEventListener('click', closeEditModal);
        document.getElementById('cancelEdit').addEventListener('click', closeEditModal);
        document.getElementById('saveEdit').addEventListener('click', saveEdit);
        
        changeUnitBtn.addEventListener('click', openUnitModal);
        unitCloseBtn.addEventListener('click', closeUnitModal);
        unitCancelBtn.addEventListener('click', closeUnitModal);
        unitConfirmBtn.addEventListener('click', confirmUnitChange);
        
        window.addEventListener('click', (e) => {
            if (e.target === editModal) closeEditModal();
            if (e.target === unitModal) closeUnitModal();
        });
        
        // Destacar link ativo na navbar
        const currentPage = window.location.pathname.split('/').pop();
        const navLinks = document.querySelectorAll('.nav-links a');
        
        navLinks.forEach(link => {
            const linkPage = link.getAttribute('href');
            if (currentPage === linkPage) {
                link.classList.add('active');
            } else {
                link.classList.remove('active');
            }
        });
        
        // Logout
        document.querySelector('.logout-btn').addEventListener('click', function() {
            if (confirm('Tem certeza que deseja sair do sistema?')) {
                auth.signOut().then(() => {
                    window.location.href = 'index.html';
                }).catch((error) => {
                    console.error('Erro ao fazer logout:', error);
                });
            }
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise de Carregamentos - CD Cariacica</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            padding: 20px;
        }
        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            margin-bottom: 2rem;
        }
        .card {
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        .card-header {
            background-color: #1e40af;
            color: white;
            font-weight: 600;
        }
        .stats-card {
            text-align: center;
            padding: 1.5rem;
            border-radius: 0.5rem;
            background-color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .stats-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1e40af;
        }
        .stats-label {
            font-size: 0.9rem;
            color: #6b7280;
        }
        .excedido {
            background-color: #ffcccc;
        }
        .normal {
            background-color: #ffffff;
        }
        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
        }
        .table th {
            position: sticky;
            top: 0;
            background-color: #1e40af;
            color: white;
            z-index: 10;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            flex-direction: column;
        }
        .filter-section {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .btn-filter {
            background-color: #1e40af;
            color: white;
        }
        .btn-filter:hover {
            background-color: #1e3a8a;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="header text-center">
            <h1><i class="bi bi-box-seam"></i> Análise de Carregamentos - CD Cariacica</h1>
            <p class="mb-0">Carregamentos dos meses 07/2025 e 08/2025</p>
        </div>
        
        <div class="filter-section">
            <div class="row">
                <div class="col-md-12 mb-3">
                    <h4><i class="bi bi-funnel"></i> Filtros</h4>
                </div>
                <div class="col-md-4">
                    <label for="placaFilter" class="form-label">Filtrar por Placa:</label>
                    <input type="text" class="form-control" id="placaFilter" placeholder="Digite a placa...">
                </div>
                <div class="col-md-4">
                    <label for="excedenteFilter" class="form-label">Filtrar por Tempo:</label>
                    <select class="form-select" id="excedenteFilter">
                        <option value="all">Todos</option>
                        <option value="excedido">Excederam 2:20h</option>
                        <option value="normal">Dentro do tempo</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button class="btn btn-filter w-100" id="applyFilters">
                        <i class="bi bi-filter"></i> Aplicar Filtros
                    </button>
                </div>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-value" id="totalCarregamentos">0</div>
                    <div class="stats-label">Total de Carregamentos</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-value" id="excedentes">0</div>
                    <div class="stats-label">Carregamentos com Tempo Excedido</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-value" id="percentualExcedentes">0%</div>
                    <div class="stats-label">Percentual de Excedentes</div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-table"></i> Carregamentos - Julho e Agosto 2025
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped" id="carregamentosTable">
                                <thead>
                                    <tr>
                                        <th>Placa</th>
                                        <th>Carregadores</th>
                                        <th>Tempo Total</th>
                                        <th>Excedeu 2:20h</th>
                                        <th>Data</th>
                                        <th>Doca</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="loading">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Carregando...</span>
                                                </div>
                                                <p class="mt-2">Carregando dados...</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    
    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBAH_sO68BD_vt9J40Hf8rdgLTNQEuEEBc",
            authDomain: "produtividade-bc.firebaseapp.com",
            projectId: "produtividade-bc",
            storageBucket: "produtividade-bc.appspot.com",
            messagingSenderId: "665932698083",
            appId: "1:665932698083:web:1c807c6b1571e3024bd0d6",
            measurementId: "G-608P3H613B"
        };

        // Inicializa o Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database(app);
        
        // Variáveis globais
        let allCarregamentosData = [];
        let filteredCarregamentosData = [];
        
        // Calcula o tempo em horas e minutos entre dois timestamps
        function calculateTimeHoursMinutes(start, end) {
            if (!start || !end) return { horas: 0, minutos: 0, totalMinutos: 0 };
            
            const diffMs = end - start;
            const totalMinutos = Math.round(diffMs / (1000 * 60));
            const horas = Math.floor(totalMinutos / 60);
            const minutos = totalMinutos % 60;
            
            return { horas, minutos, totalMinutos };
        }
        
        // Formata o tempo para exibição (HH:MM)
        function formatTime(horas, minutos) {
            return `${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}`;
        }
        
        // Verifica se o tempo excedeu 2:20h (140 minutos)
        function isTimeExceeded(totalMinutos) {
            return totalMinutos > 140; // 2h20 = 140 minutos
        }
        
        // Formata a data para exibição (DD/MM/YYYY)
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
        }
        
        // Obtém o mês e ano de um timestamp (MM/YYYY)
        function getMonthYear(timestamp) {
            const date = new Date(timestamp);
            return `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
        }
        
        // Extrai os nomes dos carregadores
        function extractCarregadores(participantes) {
            if (!participantes) return "N/A";
            
            const carregadores = [];
            for (const key in participantes) {
                if (participantes[key].nome) {
                    carregadores.push(participantes[key].nome);
                }
            }
            
            return carregadores.length > 0 ? carregadores.join(", ") : "N/A";
        }
        
        // Processa os dados dos carregamentos
        function processCarregamentosData(data) {
            return Object.values(data).filter(op => {
                // Filtra apenas carregamentos da CD Cariacica finalizados
                if (op.unidade !== 'cd_cariacica' || op.finalizado !== true || !op.inicio || !op.fim) {
                    return false;
                }
                
                // Filtra apenas carregamentos (não descarregamentos)
                if (op.tipoOperacao !== 'carregamento') {
                    return false;
                }
                
                // Filtra apenas os meses 07/2025 e 08/2025
                const monthYear = getMonthYear(op.inicio);
                return monthYear === '07/2025' || monthYear === '08/2025';
            }).map(op => {
                const { horas, minutos, totalMinutos } = calculateTimeHoursMinutes(op.inicio, op.fim);
                const tempoFormatado = formatTime(horas, minutos);
                const excedeu = isTimeExceeded(totalMinutos);
                const dataFormatada = formatDate(op.inicio);
                const carregadores = extractCarregadores(op.participantes);
                
                return {
                    placa: op.placa || 'N/A',
                    carregadores: carregadores,
                    tempo: tempoFormatado,
                    excedeu: excedeu ? 'SIM' : 'NÃO',
                    data: dataFormatada,
                    doca: op.doca || 'N/A',
                    totalMinutos: totalMinutos,
                    classe: excedeu ? 'excedido' : 'normal',
                    rawData: op // Mantém os dados brutos para referência
                };
            });
        }
        
        // Aplica os filtros
        function applyFilters() {
            const placaFilter = document.getElementById('placaFilter').value.toLowerCase();
            const excedenteFilter = document.getElementById('excedenteFilter').value;
            
            filteredCarregamentosData = allCarregamentosData.filter(op => {
                // Filtro por placa
                if (placaFilter && !op.placa.toLowerCase().includes(placaFilter)) {
                    return false;
                }
                
                // Filtro por tempo excedido
                if (excedenteFilter === 'excedido' && op.excedeu === 'NÃO') {
                    return false;
                }
                
                if (excedenteFilter === 'normal' && op.excedeu === 'SIM') {
                    return false;
                }
                
                return true;
            });
            
            updateCarregamentosTable(filteredCarregamentosData);
            updateStats(filteredCarregamentosData);
        }
        
        // Atualiza as estatísticas
        function updateStats(data) {
            if (data.length === 0) {
                document.getElementById('totalCarregamentos').textContent = '0';
                document.getElementById('excedentes').textContent = '0';
                document.getElementById('percentualExcedentes').textContent = '0%';
                return;
            }
            
            // Total de carregamentos
            document.getElementById('totalCarregamentos').textContent = data.length;
            
            // Carregamentos com tempo excedido
            const excedentes = data.filter(op => op.excedeu === 'SIM').length;
            document.getElementById('excedentes').textContent = excedentes;
            
            // Percentual de excedentes
            const percentual = Math.round((excedentes / data.length) * 100);
            document.getElementById('percentualExcedentes').textContent = `${percentual}%`;
        }
        
        // Atualiza a tabela de carregamentos
        function updateCarregamentosTable(data) {
            const tableBody = document.querySelector('#carregamentosTable tbody');
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center">Nenhum carregamento encontrado para os filtros aplicados</td>
                    </tr>
                `;
                return;
            }
            
            // Ordena por data (mais recente primeiro)
            const sortedData = [...data].sort((a, b) => {
                // Converte as datas para o formato YYYYMMDD para ordenação
                const dateA = a.data.split('/').reverse().join('');
                const dateB = b.data.split('/').reverse().join('');
                return dateB.localeCompare(dateA);
            });
            
            sortedData.forEach(op => {
                const row = document.createElement('tr');
                row.className = op.classe;
                row.innerHTML = `
                    <td>${op.placa}</td>
                    <td>${op.carregadores}</td>
                    <td>${op.tempo}</td>
                    <td>${op.excedeu}</td>
                    <td>${op.data}</td>
                    <td>${op.doca}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Carrega os dados do Firebase
        async function loadData() {
            try {
                const snapshot = await database.ref('carregamentos').once('value');
                const rawData = snapshot.val() || {};
                allCarregamentosData = processCarregamentosData(rawData);
                
                // Aplica filtros iniciais
                applyFilters();
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                
                const tableBody = document.querySelector('#carregamentosTable tbody');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger">
                            <i class="bi bi-exclamation-triangle"></i>
                            Erro ao carregar dados. Tente novamente.
                        </td>
                    </tr>
                `;
            }
        }
        
        // Inicializa a aplicação
        function init() {
            // Configura event listeners para os filtros
            document.getElementById('applyFilters').addEventListener('click', applyFilters);
            document.getElementById('placaFilter').addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    applyFilters();
                }
            });
            
            // Carrega os dados
            loadData();
        }
        
        // Inicia quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
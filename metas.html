<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Carregamentos e Diário</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/metas.css">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1000px;
            margin-top: 20px;
        }
        .card {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .form-control:disabled {
            background-color: #e9ecef;
            opacity: 1;
        }
        #loginContainer {
            display: block;
        }
        #mainContainer {
            display: none;
        }
        .nav-tabs {
            margin-bottom: 20px;
        }
        #diarioEntries {
            max-height: 400px;
            overflow-y: auto;
        }
        .diario-entry {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }
        .diario-entry:last-child {
            border-bottom: none;
        }
        .carregamento-item {
            cursor: pointer;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .carregamento-item:hover {
            background-color: #f0f0f0;
        }
        #carregamentosList {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        .export-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- Container de Login -->
    <div class="container" id="loginContainer">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Login</h4>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="unidade" class="form-label">Unidade:</label>
                    <select class="form-select" id="unidade">
                        <option value="">Selecione uma unidade</option>
                        <option value="cd_cariacica">CD Cariacica</option>
                        <option value="fabrica_belem">Fábrica Belém</option>
                        <option value="fabrica_maracanau">Fábrica Maracanaú</option>
                        <option value="fabrica_imperatriz">Fábrica Imperatriz</option>
                        <option value="fabrica_Mogi_Das_Cruzes">Fábrica Mogi das Cruzes</option>
                        <option value="fabrica_aracruz">Fábrica Aracruz</option>
                        <option value="teste">Teste</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="senha" class="form-label">Senha:</label>
                    <input type="password" class="form-control" id="senha" placeholder="Digite a senha">
                </div>
                <div id="loginError" class="alert alert-danger d-none"></div>
                <button class="btn btn-primary w-100" id="btnLogin">Entrar</button>
            </div>
        </div>
    </div>

    <!-- Container Principal (após login) -->
    <div class="container" id="mainContainer">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="carregamentos-tab" data-bs-toggle="tab" data-bs-target="#carregamentos" type="button" role="tab">Carregamentos</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="diario-tab" data-bs-toggle="tab" data-bs-target="#diario" type="button" role="tab">Dia a Dia</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="exportar-tab" data-bs-toggle="tab" data-bs-target="#exportar" type="button" role="tab">Exportar Dados</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- Aba Carregamentos -->
            <div class="tab-pane fade show active" id="carregamentos" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">Editor de Carregamentos</h4>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="inputDT" class="form-label">Digite a DT para buscar:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="inputDT" placeholder="Número da DT" autocomplete="off">
                                <button class="btn btn-primary" id="btnBuscar">Buscar</button>
                            </div>
                        </div>
                        
                        <div id="carregamentosList" style="display: none;"></div>
                        
                        <div id="resultContainer" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Unidade:</label>
                                <input type="text" class="form-control" id="unidadeCarregamento" disabled>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Tipo de Operação:</label>
                                <input type="text" class="form-control" id="tipoOperacao" disabled>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Tipo de Veículo:</label>
                                <input type="text" class="form-control" id="tipoVeiculo" disabled>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Doca:</label>
                                <input type="text" class="form-control" id="doca" disabled>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Data/Hora Início:</label>
                                <input type="text" class="form-control" id="dataHoraInicio" disabled>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">DT (Placa):</label>
                                <input type="text" class="form-control" id="placa" autocomplete="off">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Toneladas:</label>
                                <input type="number" step="0.1" class="form-control" id="toneladas" autocomplete="off">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Mix de Material:</label>
                                <input type="number" class="form-control" id="mixMaterial" autocomplete="off">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Status:</label>
                                <input type="text" class="form-control" id="status" disabled>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Tempo Total:</label>
                                <input type="text" class="form-control" id="tempoTotal" disabled>
                            </div>
                            
                            <div class="action-buttons">
                                <button class="btn btn-primary" id="btnSalvar">Salvar Alterações</button>
                                <button class="btn btn-danger" id="btnRemoverCarregamento">Remover Carregamento</button>
                            </div>
                        </div>
                        
                        <div id="loading" class="text-center" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p>Buscando dados...</p>
                        </div>
                        
                        <div id="noResults" class="alert alert-warning mt-3" style="display: none;">
                            Nenhum carregamento encontrado com esta DT.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aba Diário -->
            <div class="tab-pane fade" id="diario" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">Registro Diário</h4>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="diarioData" class="form-label">Data:</label>
                            <input type="date" class="form-control" id="diarioData" value="">
                        </div>
                        <div class="mb-3">
                            <label for="diarioTitulo" class="form-label">Título:</label>
                            <input type="text" class="form-control" id="diarioTitulo" placeholder="Título do registro">
                        </div>
                        <div class="mb-3">
                            <label for="diarioDescricao" class="form-label">Descrição:</label>
                            <textarea class="form-control" id="diarioDescricao" rows="3" placeholder="Descreva o que aconteceu"></textarea>
                        </div>
                        <button class="btn btn-primary" id="btnSalvarDiario">Salvar Registro</button>
                        
                        <hr>
                        
                        <h5>Registros Anteriores</h5>
                        <div id="diarioEntries">
                            <div class="text-center">
                                <p>Carregando registros...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aba Exportar Dados -->
            <div class="tab-pane fade" id="exportar" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">Exportar Dados</h4>
                    </div>
                    <div class="card-body">
                        <h5>Exportar Carregamentos</h5>
                        <div class="mb-3">
                            <label for="dataInicio" class="form-label">Data Início:</label>
                            <input type="date" class="form-control" id="dataInicio">
                        </div>
                        <div class="mb-3">
                            <label for="dataFim" class="form-label">Data Fim:</label>
                            <input type="date" class="form-control" id="dataFim">
                        </div>
                        <button class="btn btn-primary" id="btnExportarCarregamentos">Exportar Carregamentos</button>
                        
                        <hr>
                        
                        <h5>Exportar Registros Diários</h5>
                        <div class="mb-3">
                            <label for="diarioDataInicio" class="form-label">Data Início:</label>
                            <input type="date" class="form-control" id="diarioDataInicio">
                        </div>
                        <div class="mb-3">
                            <label for="diarioDataFim" class="form-label">Data Fim:</label>
                            <input type="date" class="form-control" id="diarioDataFim">
                        </div>
                        <button class="btn btn-primary" id="btnExportarDiario">Exportar Diário</button>
                        
                        <div id="exportStatus" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Biblioteca para exportar CSV -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>

    <script>
        // Variáveis globais
        let carregamentoAtual = null;
        let carregamentoKey = null;
        let database = null;
        let auth = null;
        let carregamentosEncontrados = [];

        // Função para carregar scripts dinamicamente
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const s = document.createElement('script');
                s.src = src;
                s.onload = resolve;
                s.onerror = reject;
                document.head.appendChild(s);
            });
        }

        // Evento de login
        document.getElementById('btnLogin').addEventListener('click', async () => {
            const unidade = document.getElementById('unidade').value;
            const senha = document.getElementById('senha').value;
            const erroDiv = document.getElementById('loginError');

            erroDiv.classList.add('d-none');
            if (!unidade || !senha) {
                erroDiv.textContent = 'Preencha unidade e senha.';
                erroDiv.classList.remove('d-none');
                return;
            }
            if (senha !== '123456') {
                erroDiv.textContent = 'Senha incorreta.';
                erroDiv.classList.remove('d-none');
                return;
            }

            // Define a unidade atual
            window.unidadeAtual = unidade;

            // Mapeamento de configurações por unidade
            const configFiles = {
                'cd_cariacica': './js/firebase_config_cariacica.js',
                'fabrica_belem': './js/firebase_config_belem.js',
                'fabrica_maracanau': './js/firebase_config_maracanau.js',
                'teste': './js/firebase_config_teste.js',
                'fabrica_Mogi_Das_Cruzes': './js/firebase_config_Mogi_Das_Cruzes.js',
                'fabrica_aracruz': './js/firebase_config_aracruz.js',
                'fabrica_imperatriz': './js/firebase_config_imperatriz.js'
            };

            const configFile = configFiles[unidade] || './js/firebase_config_imperatriz.js';

            try {
                // Carrega a configuração específica
                await loadScript(configFile);
                
                // Inicializa o Firebase
                const app = firebase.initializeApp(firebaseConfig);
                database = firebase.database(app);
                auth = firebase.auth(app);

                // Esconde login e mostra app
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';

                // Carrega a data atual no campo de data do diário
                const hoje = new Date().toISOString().split('T')[0];
                document.getElementById('diarioData').value = hoje;
                document.getElementById('dataInicio').value = hoje;
                document.getElementById('dataFim').value = hoje;
                document.getElementById('diarioDataInicio').value = hoje;
                document.getElementById('diarioDataFim').value = hoje;

                // Carrega os registros do diário
                carregarDiario();

            } catch (err) {
                console.error('Erro ao inicializar Firebase:', err);
                erroDiv.textContent = 'Erro ao conectar ao banco de dados.';
                erroDiv.classList.remove('d-none');
            }
        });

        // Funções para Carregamentos
        function formatarData(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleString('pt-BR');
        }
        
        function calcularTempoTotal(inicio, fim) {
            if (!inicio) return 'N/A';
            const fimTime = fim || new Date().getTime();
            const minutos = Math.floor((fimTime - inicio) / 60000);
            const horas = Math.floor(minutos / 60);
            const min = minutos % 60;
            return `${horas}h ${min}min`;
        }
        
        function buscarCarregamentoPorDT(dt) {
            const dtNormalizada = dt.trim().toUpperCase();
            const loadingElement = document.getElementById('loading');
            const resultContainer = document.getElementById('resultContainer');
            const noResultsElement = document.getElementById('noResults');
            const carregamentosList = document.getElementById('carregamentosList');

            loadingElement.style.display = 'block';
            resultContainer.style.display = 'none';
            noResultsElement.style.display = 'none';
            carregamentosList.style.display = 'none';
            carregamentosList.innerHTML = '';

            database.ref('carregamentos')
                .orderByChild('placa')
                .equalTo(dtNormalizada)
                .once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        carregamentosEncontrados = [];
                        snapshot.forEach(childSnapshot => {
                            const carregamento = childSnapshot.val();
                            carregamento.key = childSnapshot.key;
                            carregamentosEncontrados.push(carregamento);
                        });

                        if (carregamentosEncontrados.length === 1) {
                            // Se houver apenas um carregamento, mostra diretamente
                            exibirCarregamento(carregamentosEncontrados[0], carregamentosEncontrados[0].key);
                        } else if (carregamentosEncontrados.length > 1) {
                            // Se houver múltiplos carregamentos, mostra a lista para seleção
                            mostrarListaCarregamentos(carregamentosEncontrados);
                        } else {
                            noResultsElement.style.display = 'block';
                        }
                    } else {
                        noResultsElement.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Erro na busca:', error);
                    alert('Erro ao buscar carregamento. Verifique o console para detalhes.');
                })
                .finally(() => {
                    loadingElement.style.display = 'none';
                });
        }
        
        function mostrarListaCarregamentos(carregamentos) {
            const carregamentosList = document.getElementById('carregamentosList');
            carregamentosList.style.display = 'block';
            
            let html = '<h5>Selecione o carregamento:</h5>';
            html += '<div class="list-group">';
            
            carregamentos.forEach((carregamento, index) => {
                const status = carregamento.finalizado ? 'Finalizado' : 
                              carregamento.pausado ? 'Pausado' : 'Em andamento';
                const tempoTotal = calcularTempoTotal(carregamento.inicio, carregamento.fim);
                const dataInicio = formatarData(carregamento.inicio);
                
                html += `
                <div class="carregamento-item list-group-item list-group-item-action" 
                     data-index="${index}" 
                     onclick="selecionarCarregamento(${index})">
                    <div class="d-flex justify-content-between">
                        <strong>${carregamento.placa}</strong>
                        <span class="badge bg-${status === 'Finalizado' ? 'success' : 
                                           status === 'Pausado' ? 'warning' : 'primary'}">
                            ${status}
                        </span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <small>Doca: ${carregamento.doca || 'N/A'}</small>
                        <small>Início: ${dataInicio}</small>
                    </div>
                    <div class="d-flex justify-content-between">
                        <small>Tipo: ${carregamento.tipoVeiculo || 'N/A'}</small>
                        <small>Tempo: ${tempoTotal}</small>
                    </div>
                    <div class="d-flex justify-content-between">
                        <small>Mix: ${carregamento.mixMaterial || 'N/A'}</small>
                    </div>
                </div>
                `;
            });
            
            html += '</div>';
            carregamentosList.innerHTML = html;
        }
        
        function selecionarCarregamento(index) {
            const carregamento = carregamentosEncontrados[index];
            exibirCarregamento(carregamento, carregamento.key);
            document.getElementById('carregamentosList').style.display = 'none';
        }
        
        function exibirCarregamento(carregamento, key) {
            carregamentoAtual = carregamento;
            carregamentoKey = key;
            
            const resultContainer = document.getElementById('resultContainer');
            
            // Preenche os campos do formulário
            document.getElementById('unidadeCarregamento').value = 
                window.unidadeAtual.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            document.getElementById('tipoOperacao').value = carregamentoAtual.tipoOperacao || 'N/A';
            document.getElementById('tipoVeiculo').value = carregamentoAtual.tipoVeiculo || 'N/A';
            document.getElementById('doca').value = carregamentoAtual.doca || 'N/A';
            document.getElementById('dataHoraInicio').value = formatarData(carregamentoAtual.inicio);
            document.getElementById('placa').value = carregamentoAtual.placa || '';
            document.getElementById('toneladas').value = carregamentoAtual.toneladas || '';
            document.getElementById('mixMaterial').value = carregamentoAtual.mixMaterial || '';

            // Calcula status
            let status = 'Finalizado';
            if (!carregamentoAtual.finalizado) {
                status = carregamentoAtual.pausado ? 'Pausado' : 'Em andamento';
            }
            document.getElementById('status').value = status;

            // Calcula tempo total
            document.getElementById('tempoTotal').value = calcularTempoTotal(
                carregamentoAtual.inicio, 
                carregamentoAtual.fim
            );

            resultContainer.style.display = 'block';
        }
        
        function salvarAlteracoes() {
            if (!carregamentoAtual || !carregamentoKey) {
                alert('Nenhum carregamento selecionado para editar!');
                return;
            }
            
            const placa = document.getElementById('placa').value.trim().toUpperCase();
            const toneladas = document.getElementById('toneladas').value.trim();
            const mixMaterial = document.getElementById('mixMaterial').value.trim();
            
            if (!placa) {
                alert('Informe a DT (Placa)!');
                return;
            }
            
            if (!toneladas || isNaN(parseFloat(toneladas))) {
                alert('Informe um valor válido para toneladas!');
                return;
            }
            
            if (mixMaterial && isNaN(parseInt(mixMaterial))) {
                alert('Informe um valor válido para mix de material!');
                return;
            }
            
            const updates = {
                placa: placa,
                toneladas: parseFloat(toneladas).toFixed(1)
            };
            
            // Adiciona mixMaterial apenas se foi informado
            if (mixMaterial) {
                updates.mixMaterial = parseInt(mixMaterial);
            }
            
            database.ref(`carregamentos/${carregamentoKey}`)
                .update(updates)
                .then(() => {
                    alert('Alterações salvas com sucesso!');
                    carregamentoAtual.placa = placa;
                    carregamentoAtual.toneladas = updates.toneladas;
                    if (mixMaterial) {
                        carregamentoAtual.mixMaterial = updates.mixMaterial;
                    }
                })
                .catch(error => {
                    console.error('Erro ao salvar:', error);
                    alert('Erro ao salvar alterações: ' + error.message);
                });
        }

        function removerCarregamento() {
            if (!carregamentoAtual || !carregamentoKey) {
                alert('Nenhum carregamento selecionado para remover!');
                return;
            }
            
            if (!confirm('Tem certeza que deseja remover este carregamento? Esta ação não pode ser desfeita.')) {
                return;
            }
            
            database.ref(`carregamentos/${carregamentoKey}`)
                .remove()
                .then(() => {
                    alert('Carregamento removido com sucesso!');
                    document.getElementById('resultContainer').style.display = 'none';
                    document.getElementById('inputDT').value = '';
                    carregamentoAtual = null;
                    carregamentoKey = null;
                })
                .catch(error => {
                    console.error('Erro ao remover:', error);
                    alert('Erro ao remover carregamento: ' + error.message);
                });
        }

        // Funções para o Diário
        function carregarDiario() {
            const diarioEntries = document.getElementById('diarioEntries');
            diarioEntries.innerHTML = '<div class="text-center"><p>Carregando registros...</p></div>';
            
            database.ref('diario')
                .orderByChild('data')
                .limitToLast(50) // Limita aos últimos 50 registros
                .once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const entries = [];
                        snapshot.forEach(childSnapshot => {
                            const entry = childSnapshot.val();
                            entry.key = childSnapshot.key;
                            entries.push(entry);
                        });
                        
                        // Ordena do mais recente para o mais antigo
                        entries.sort((a, b) => b.timestamp - a.timestamp);
                        
                        renderDiarioEntries(entries);
                    } else {
                        diarioEntries.innerHTML = '<div class="alert alert-info">Nenhum registro encontrado.</div>';
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar diário:', error);
                    diarioEntries.innerHTML = '<div class="alert alert-danger">Erro ao carregar registros.</div>';
                });
        }

        function renderDiarioEntries(entries) {
            const diarioEntries = document.getElementById('diarioEntries');
            
            if (entries.length === 0) {
                diarioEntries.innerHTML = '<div class="alert alert-info">Nenhum registro encontrado.</div>';
                return;
            }
            
            let html = '';
            entries.forEach(entry => {
                const data = new Date(entry.timestamp).toLocaleDateString('pt-BR');
                const hora = new Date(entry.timestamp).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
                
                html += `
                <div class="diario-entry">
                    <div class="d-flex justify-content-between">
                        <strong>${entry.titulo}</strong>
                        <small class="text-muted">${data} às ${hora}</small>
                    </div>
                    <p class="mb-1">${entry.descricao}</p>
                    <button class="btn btn-sm btn-outline-danger btn-remover-diario" data-key="${entry.key}">Remover</button>
                </div>
                `;
            });
            
            diarioEntries.innerHTML = html;
            
            // Adiciona eventos aos botões de remover
            document.querySelectorAll('.btn-remover-diario').forEach(btn => {
                btn.addEventListener('click', function() {
                    const key = this.getAttribute('data-key');
                    if (confirm('Tem certeza que deseja remover este registro?')) {
                        removerRegistroDiario(key);
                    }
                });
            });
        }

        function salvarRegistroDiario() {
            const data = document.getElementById('diarioData').value;
            const titulo = document.getElementById('diarioTitulo').value.trim();
            const descricao = document.getElementById('diarioDescricao').value.trim();
            
            if (!data) {
                alert('Informe a data!');
                return;
            }
            
            if (!titulo) {
                alert('Informe o título!');
                return;
            }
            
            if (!descricao) {
                alert('Informe a descrição!');
                return;
            }
            
            // Converte a data para timestamp
            const dataObj = new Date(data);
            const timestamp = dataObj.getTime();
            
            const novoRegistro = {
                data: data,
                titulo: titulo,
                descricao: descricao,
                timestamp: timestamp,
                unidade: window.unidadeAtual,
                criadoPor: 'Usuário' // Você pode substituir por um nome de usuário real
            };
            
            database.ref('diario').push(novoRegistro)
                .then(() => {
                    alert('Registro salvo com sucesso!');
                    document.getElementById('diarioTitulo').value = '';
                    document.getElementById('diarioDescricao').value = '';
                    carregarDiario();
                })
                .catch(error => {
                    console.error('Erro ao salvar registro:', error);
                    alert('Erro ao salvar registro: ' + error.message);
                });
        }

        function removerRegistroDiario(key) {
            database.ref(`diario/${key}`).remove()
                .then(() => {
                    alert('Registro removido com sucesso!');
                    carregarDiario();
                })
                .catch(error => {
                    console.error('Erro ao remover registro:', error);
                    alert('Erro ao remover registro: ' + error.message);
                });
        }

        // Funções para Exportar Dados
        function exportarParaCSV(dados, nomeArquivo) {
            const csv = Papa.unparse(dados);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', nomeArquivo);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportarCarregamentos() {
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            
            if (!dataInicio || !dataFim) {
                alert('Informe as datas de início e fim!');
                return;
            }
            
            const inicioTimestamp = new Date(dataInicio).getTime();
            const fimTimestamp = new Date(dataFim + 'T23:59:59').getTime();
            
            const exportStatus = document.getElementById('exportStatus');
            exportStatus.innerHTML = '<div class="alert alert-info">Buscando carregamentos...</div>';
            
            database.ref('carregamentos')
                .orderByChild('inicio')
                .startAt(inicioTimestamp)
                .endAt(fimTimestamp)
                .once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const carregamentos = [];
                        snapshot.forEach(childSnapshot => {
                            const carregamento = childSnapshot.val();
                            carregamento.key = childSnapshot.key;
                            
                            // Formata os dados para exportação
                            const dadosFormatados = {
                                'DT': carregamento.placa || '',
                                'Unidade': window.unidadeAtual.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                                'Tipo Operação': carregamento.tipoOperacao || '',
                                'Tipo Veículo': carregamento.tipoVeiculo || '',
                                'Doca': carregamento.doca || '',
                                'Data/Hora Início': carregamento.inicio ? formatarData(carregamento.inicio) : '',
                                'Data/Hora Fim': carregamento.fim ? formatarData(carregamento.fim) : '',
                                'Toneladas': carregamento.toneladas || '',
                                'Mix Material': carregamento.mixMaterial || '',
                                'Status': carregamento.finalizado ? 'Finalizado' : 
                                          carregamento.pausado ? 'Pausado' : 'Em andamento',
                                'Tempo Total': calcularTempoTotal(carregamento.inicio, carregamento.fim)
                            };
                            
                            carregamentos.push(dadosFormatados);
                        });
                        
                        // Ordena por data de início
                        carregamentos.sort((a, b) => {
                            const aTime = a['Data/Hora Início'] ? new Date(a['Data/Hora Início']).getTime() : 0;
                            const bTime = b['Data/Hora Início'] ? new Date(b['Data/Hora Início']).getTime() : 0;
                            return aTime - bTime;
                        });
                        
                        exportarParaCSV(carregamentos, `carregamentos_${dataInicio}_a_${dataFim}.csv`);
                        exportStatus.innerHTML = `<div class="alert alert-success">Exportados ${carregamentos.length} carregamentos com sucesso!</div>`;
                    } else {
                        exportStatus.innerHTML = '<div class="alert alert-warning">Nenhum carregamento encontrado no período selecionado.</div>';
                    }
                })
                .catch(error => {
                    console.error('Erro ao exportar carregamentos:', error);
                    exportStatus.innerHTML = '<div class="alert alert-danger">Erro ao exportar carregamentos. Verifique o console para detalhes.</div>';
                });
        }

        function exportarDiario() {
            const dataInicio = document.getElementById('diarioDataInicio').value;
            const dataFim = document.getElementById('diarioDataFim').value;
            
            if (!dataInicio || !dataFim) {
                alert('Informe as datas de início e fim!');
                return;
            }
            
            const inicioTimestamp = new Date(dataInicio).getTime();
            const fimTimestamp = new Date(dataFim + 'T23:59:59').getTime();
            
            const exportStatus = document.getElementById('exportStatus');
            exportStatus.innerHTML = '<div class="alert alert-info">Buscando registros do diário...</div>';
            
            database.ref('diario')
                .orderByChild('timestamp')
                .startAt(inicioTimestamp)
                .endAt(fimTimestamp)
                .once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const registros = [];
                        snapshot.forEach(childSnapshot => {
                            const registro = childSnapshot.val();
                            registro.key = childSnapshot.key;
                            
                            // Formata os dados para exportação
                            const dadosFormatados = {
                                'Data': registro.data,
                                'Título': registro.titulo || '',
                                'Descrição': registro.descricao || '',
                                'Data/Hora Completa': registro.timestamp ? formatarData(registro.timestamp) : '',
                                'Unidade': registro.unidade.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                                'Criado Por': registro.criadoPor || ''
                            };
                            
                            registros.push(dadosFormatados);
                        });
                        
                        // Ordena por data (mais recente primeiro)
                        registros.sort((a, b) => {
                            return new Date(b['Data/Hora Completa']).getTime() - new Date(a['Data/Hora Completa']).getTime();
                        });
                        
                        exportarParaCSV(registros, `diario_${dataInicio}_a_${dataFim}.csv`);
                        exportStatus.innerHTML = `<div class="alert alert-success">Exportados ${registros.length} registros do diário com sucesso!</div>`;
                    } else {
                        exportStatus.innerHTML = '<div class="alert alert-warning">Nenhum registro encontrado no período selecionado.</div>';
                    }
                })
                .catch(error => {
                    console.error('Erro ao exportar diário:', error);
                    exportStatus.innerHTML = '<div class="alert alert-danger">Erro ao exportar diário. Verifique o console para detalhes.</div>';
                });
        }

        // Event listeners
        document.getElementById('btnBuscar').addEventListener('click', () => {
            const dt = document.getElementById('inputDT').value.trim();
            if (dt) {
                buscarCarregamentoPorDT(dt);
            } else {
                alert('Informe o número da DT!');
            }
        });
        
        document.getElementById('btnSalvar').addEventListener('click', salvarAlteracoes);
        
        document.getElementById('btnRemoverCarregamento').addEventListener('click', removerCarregamento);
        
        document.getElementById('inputDT').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('btnBuscar').click();
            }
        });
        
        document.getElementById('btnSalvarDiario').addEventListener('click', salvarRegistroDiario);
        
        document.getElementById('btnExportarCarregamentos').addEventListener('click', exportarCarregamentos);
        
        document.getElementById('btnExportarDiario').addEventListener('click', exportarDiario);
    </script>
</body>
</html>
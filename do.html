<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise Completa de Diversidade de Materiais (Mix)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
    :root {
        --primary-color: #4361ee;
        --primary-dark: #3a56d4;
        --secondary-color: #3f37c9;
        --accent-color: #4895ef;
        --danger-color: #f72585;
        --warning-color: #f77f00;
        --success-color: #4cc9f0;
        --dark-color: #2b2d42;
        --light-color: #f8f9fa;
        --gray-color: #303030;
        --bg-gradient: linear-gradient(135deg, #4361ee 0%, #3f37c9 100%);
    }
    
    body {
        font-family: 'Poppins', sans-serif;
        background-color: #f8f9fa;
        color: #495057;
        line-height: 1.6;
    }
    
    .header {
        background: var(--bg-gradient);
        color: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(67, 97, 238, 0.15);
        position: relative;
        overflow: hidden;
    }
    
    .header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 100%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
        transform: rotate(30deg);
    }
    
    .header h1 {
        font-weight: 700;
        position: relative;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .header p {
        opacity: 0.9;
        position: relative;
    }
    
    .card {
        border: none;
        border-radius: 0.75rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        margin-bottom: 1.5rem;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        overflow: hidden;
        background-color: white;
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    
    .card-header {
        background: var(--bg-gradient);
        color: white;
        font-weight: 600;
        border-radius: 0.75rem 0.75rem 0 0 !important;
        padding: 1rem 1.5rem;
        border-bottom: none;
        position: relative;
    }
    
    .card-header i {
        margin-right: 0.5rem;
        font-size: 1.1em;
    }
    
    .card-body {
        padding: 1.5rem;
    }
    
    .form-select {
        border: 1px solid #e9ecef;
        border-radius: 0.5rem;
        padding: 0.5rem 1rem;
        box-shadow: none;
        transition: all 0.3s;
    }
    
    .form-select:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 0.25rem rgba(72, 149, 239, 0.25);
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 1rem;
    }
    
    .stats-card {
        text-align: center;
        padding: 1.5rem;
        border-radius: 0.75rem;
        background-color: white;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        transition: all 0.3s;
    }
    
    .stats-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    
    .stats-value {
        font-size: 2.25rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
        line-height: 1;
    }
    
    .stats-label {
        font-size: 0.9rem;
        color: var(--gray-color);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .table-responsive {
        border-radius: 0.75rem;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }
    
    .table {
        margin-bottom: 0;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .table th {
        background-color: var(--dark-color);
        color: white;
        font-weight: 600;
        padding: 1rem;
        border: none;
    }
    
    .table td {
        padding: 0.75rem 1rem;
        vertical-align: middle;
        border-top: 1px solid #f1f3f5;
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(67, 97, 238, 0.05);
    }
    
    .table-active {
        background-color: rgba(67, 97, 238, 0.1) !important;
    }
    
    .alert {
        border-radius: 0.5rem;
        padding: 0.75rem 1.25rem;
    }
    
    .alert-info {
        background-color: rgba(72, 149, 239, 0.1);
        border-color: rgba(72, 149, 239, 0.2);
        color: var(--dark-color);
    }
    
    .loader {
        border: 4px solid rgba(67, 97, 238, 0.1);
        border-top: 4px solid var(--primary-color);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .badge {
        padding: 0.35em 0.65em;
        font-weight: 600;
        letter-spacing: 0.5px;
        border-radius: 0.375rem;
    }
    
    .badge-mix {
        background-color: var(--primary-color);
        color: white;
    }
    
    .data-info {
        font-size: 0.85rem;
        color: var(--gray-color);
        margin-top: 0.5rem;
        font-style: italic;
    }
    
    /* Animations */
    .animate-fadeIn {
        animation: fadeIn 0.5s cubic-bezier(0.22, 1, 0.36, 1);
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    
    ::-webkit-scrollbar-track {
        background: #f1f3f5;
    }
    
    ::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
        background: var(--primary-dark);
    }
    
    /* Tooltip customization */
    .chart-tooltip {
        background-color: var(--dark-color) !important;
        border-radius: 0.5rem !important;
        padding: 0.5rem 1rem !important;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15) !important;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .header {
            padding: 1rem;
        }
        
        .header h1 {
            font-size: 1.75rem;
        }
        
        .stats-card {
            padding: 1rem;
        }
        
        .stats-value {
            font-size: 1.75rem;
        }
    }
    
    /* Special effects for presentation mode */
    .presentation-mode .card {
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    
    .presentation-mode .header {
        box-shadow: 0 10px 30px rgba(67, 97, 238, 0.2);
    }
    
    /* Floating animation for important elements */
    .float-animation {
        animation: float 6s ease-in-out infinite;
    }
    
    @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
    }
</style>
</head>
<body>
    <div class="container py-4">
        <div class="header text-center">
            <h1><i class="bi bi-boxes"></i> Análise Completa de Diversidade de Materiais (Mix)</h1>
            <p class="mb-0">Histórico completo de materiais diferentes por carregamento</p>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-building"></i> Selecione a Unidade
                    </div>
                    <div class="card-body">
                        <select id="unitSelector" class="form-select unit-selector">
                            <option value="all">Todas as Unidades</option>
                            <option value="cd_cariacica">CD Cariacica</option>
                            <option value="fabrica_belem">Fábrica Belém</option>
                            <option value="fabrica_maracanau">Fábrica Maracanau</option>
                            <option value="fabrica_imperatriz">Fábrica Imperatriz</option>
                            <option value="fabrica_Mogi_Das_Cruzes">Fábrica Mogi das Cruzes</option>
                            <option value="fabrica_Aracruz">Fábrica Aracruz</option>
                            <option value="teste">Ambiente de Teste</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-calendar-range"></i> Período de Análise
                    </div>
                    <div class="card-body">
                        <div class="date-range-selector">
                            <label for="dateRange" class="form-label">Selecione o período:</label>
                            <select id="dateRange" class="form-select">
                                <option value="today">Hoje</option>
                                <option value="yesterday">Ontem</option>
                                <option value="week">Últimos 7 dias</option>
                                <option value="month" selected>Últimos 30 dias</option>
                                <option value="all">Todo o histórico</option>
                            </select>
                        </div>
                        <div class="data-info" id="dataRangeInfo">
                            Carregando informações do período...
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-sliders"></i> Intervalo de Mix
                    </div>
                    <div class="card-body">
                        <div class="range-selector">
                            <label for="mixRange" class="form-label">Agrupar por faixa de:</label>
                            <select id="mixRange" class="form-select">
                                <option value="1">1 (Valor exato)</option>
                                <option value="5" selected>5</option>
                                <option value="10">10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        <div class="alert alert-info mt-2">
                            <i class="bi bi-info-circle"></i> Mix = Quantidade de materiais diferentes no carregamento
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-value" id="totalCarregamentos">0</div>
                    <div class="stats-label">Total de Carregamentos</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-value" id="avgMix">0</div>
                    <div class="stats-label">Média de Mix</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-value" id="maxMix">0</div>
                    <div class="stats-label">Mix Máximo</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-value" id="minMix">0</div>
                    <div class="stats-label">Mix Mínimo</div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-bar-chart"></i> Distribuição de Frequência
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="mixChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-table"></i> Dados Detalhados
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="mixTable">
                                <thead>
                                    <tr>
                                        <th>Faixa de Mix</th>
                                        <th>Quantidade</th>
                                        <th>Porcentagem</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="3" class="text-center">
                                            <div class="loader"></div>
                                            <p>Carregando dados...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-grid"></i> Comparação Entre Unidades
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 400px;">
                            <canvas id="comparisonChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="chart-container2" style="height: 00px;">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <script>
        // Configurações do Firebase para cada unidade
        const unitsConfig = {
            cd_cariacica: {
                name: "CD Cariacica",
                firebaseConfig: {
                    apiKey: "AIzaSyBAH_sO68BD_vt9J40Hf8rdgLTNQEuEEBc",
                    authDomain: "produtividade-bc.firebaseapp.com",
                    projectId: "produtividade-bc",
                    storageBucket: "produtividade-bc.appspot.com",
                    messagingSenderId: "665932698083",
                    appId: "1:665932698083:web:1c807c6b1571e3024bd0d6",
                    measurementId: "G-608P3H613B"
                }
            },
            fabrica_belem: {
                name: "Fábrica Belém",
                firebaseConfig: {
                    apiKey: "AIzaSyDZWkYdfV2Qy6Nhi9wUkmtkr-NjeWioLRA",
                    authDomain: "produtividade-bc-belem.firebaseapp.com",
                    projectId: "produtividade-bc-belem",
                    storageBucket: "produtividade-bc-belem.firebasestorage.app",
                    messagingSenderId: "798674110784",
                    appId: "1:798674110784:web:10988b89bd1ff5d9f652a5",
                    measurementId: "G-GF1C65E0MK"
                }
            },
            fabrica_maracanau: {
                name: "Fábrica Maracanau",
                firebaseConfig: {
                    apiKey: "AIzaSyD7Qbw6l9O_R2WIj6kr7AvGUFYk2WBfclA",
                    authDomain: "produtividade-bc-maracanau.firebaseapp.com",
                    projectId: "produtividade-bc-maracanau",
                    storageBucket: "produtividade-bc-maracanau.firebasestorage.app",
                    messagingSenderId: "615712010394",
                    appId: "1:615712010394:web:e483c645d7c69aa92b6f23",
                    measurementId: "G-LHM2NDR1YT"
                }
            },
            fabrica_imperatriz: {
                name: "Fábrica Imperatriz",
                firebaseConfig: {
                    apiKey: "AIzaSyCZxLrGt4BvU4GOhD5I4LqxyFYm1hpJwLk",
                    authDomain: "produtividade-bc-imperatriz.firebaseapp.com",
                    projectId: "produtividade-bc-imperatriz",
                    storageBucket: "produtividade-bc-imperatriz.firebasestorage.app",
                    messagingSenderId: "1065541326945",
                    appId: "1:1065541326945:web:7096abb2900b6547e1f220",
                    measurementId: "G-8R9M8RETYJ"
                }
            },
            fabrica_Mogi_Das_Cruzes: {
                name: "Fábrica Mogi das Cruzes",
                firebaseConfig: {
                    apiKey: "AIzaSyCuA2lYrKEAzqePDEFyfDp9L4Mh2chH8jk",
                    authDomain: "produtividade-bc-mogi-cruzes.firebaseapp.com",
                    projectId: "produtividade-bc-mogi-cruzes",
                    storageBucket: "produtividade-bc-mogi-cruzes.firebasestorage.app",
                    messagingSenderId: "867117239625",
                    appId: "1:867117239625:web:463314856226302e585e98",
                    measurementId: "G-CQ3LQ1SM0M"
                }
            },

        };

        // Variáveis globais
        let databaseRefs = {};
        let mixChart = null;
        let comparisonChart = null;
        let trendChart = null;
        let allMixData = {};
        let isInitialized = false;
        let currentRange = 5;
        let currentDateRange = 'month';
        let allCarregamentosData = {};

        // Inicializa todas as conexões Firebase
        function initializeFirebaseConnections() {
            if (isInitialized) return;
            
            Object.keys(unitsConfig).forEach(unit => {
                try {
                    const app = firebase.initializeApp(unitsConfig[unit].firebaseConfig, unit);
                    databaseRefs[unit] = firebase.database(app);
                } catch (error) {
                    console.error(`Erro ao inicializar Firebase para ${unit}:`, error);
                }
            });
            
            isInitialized = true;
        }

        // Formata porcentagem
        function formatPercentage(value, total) {
            return total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
        }

        // Cria faixas de mix baseado no intervalo selecionado
        function createMixRanges(mixValues, range) {
            const ranges = {};
            
            if (mixValues.length === 0) return ranges;
            
            const maxMix = Math.max(...mixValues);
            const minMix = Math.min(...mixValues);
            
            // Cria faixas baseadas no intervalo
            for (let i = 1; i <= maxMix + range; i += range) {
                const start = i;
                const end = i + range - 1;
                const label = range === 1 ? `${start}` : `${start}-${end}`;
                ranges[label] = {
                    start: start,
                    end: end,
                    count: 0,
                    label: label
                };
            }
            
            // Conta os valores em cada faixa
            mixValues.forEach(value => {
                for (const key in ranges) {
                    const range = ranges[key];
                    if (value >= range.start && value <= range.end) {
                        range.count++;
                        break;
                    }
                }
            });
            
            // Remove faixas com 0 ocorrências
            Object.keys(ranges).forEach(key => {
                if (ranges[key].count === 0) {
                    delete ranges[key];
                }
            });
            
            return ranges;
        }

        // Calcula estatísticas do mix
        function calculateMixStats(carregamentos) {
            const mixValues = [];
            let total = 0;
            let sum = 0;
            let max = 0;
            let min = Infinity;
            
            carregamentos.forEach(c => {
                if (c.mixMaterial && !isNaN(c.mixMaterial)) {
                    const mix = parseInt(c.mixMaterial);
                    mixValues.push(mix);
                    total++;
                    sum += mix;
                    if (mix > max) max = mix;
                    if (mix < min) min = mix;
                }
            });
            
            const avg = total > 0 ? (sum / total).toFixed(1) : 0;
            const ranges = createMixRanges(mixValues, currentRange);
            
            return {
                total,
                avg,
                max,
                min: min === Infinity ? 0 : min,
                mixValues,
                ranges,
                carregamentos: carregamentos.filter(c => c.mixMaterial && !isNaN(c.mixMaterial))
            };
        }

        // Atualiza a tabela com os dados
        function updateTable(stats) {
            const tableBody = document.querySelector('#mixTable tbody');
            tableBody.innerHTML = '';
            
            if (stats.total === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="3" class="text-center">Nenhum dado disponível para o período selecionado</td>
                `;
                tableBody.appendChild(emptyRow);
                return;
            }
            
            // Ordena as faixas pelo valor inicial
            const sortedRanges = Object.values(stats.ranges).sort((a, b) => a.start - b.start);
            
            sortedRanges.forEach(range => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${range.label}</td>
                    <td>${range.count}</td>
                    <td>${formatPercentage(range.count, stats.total)}</td>
                `;
                tableBody.appendChild(row);
            });
            
            // Adiciona linha de total
            const totalRow = document.createElement('tr');
            totalRow.className = 'table-active';
            totalRow.innerHTML = `
                <td><strong>Total</strong></td>
                <td><strong>${stats.total}</strong></td>
                <td><strong>100%</strong></td>
            `;
            tableBody.appendChild(totalRow);
        }

        // Atualiza os cards de estatísticas
        function updateStatsCards(stats) {
            document.getElementById('totalCarregamentos').textContent = stats.total;
            document.getElementById('avgMix').textContent = stats.avg;
            document.getElementById('maxMix').textContent = stats.max;
            document.getElementById('minMix').textContent = stats.min === Infinity ? 0 : stats.min;
        }

        // Atualiza o gráfico de barras
        function updateBarChart(stats) {
            const ctx = document.getElementById('mixChart').getContext('2d');
            
            // Destrói o gráfico anterior se existir
            if (mixChart) {
                mixChart.destroy();
            }
            
            if (stats.total === 0) {
                // Mostra mensagem quando não há dados
                document.getElementById('mixChart').innerHTML = `
                    <div class="text-center text-muted" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                        <i class="bi bi-exclamation-circle" style="font-size: 2rem;"></i>
                        <p>Nenhum dado disponível para o período selecionado</p>
                    </div>
                `;
                return;
            }
            
            // Ordena as faixas pelo valor inicial
            const sortedRanges = Object.values(stats.ranges).sort((a, b) => a.start - b.start);
            
            const labels = sortedRanges.map(range => range.label);
            const data = sortedRanges.map(range => range.count);
            const backgroundColors = sortedRanges.map((range, index) => {
                // Gera cores em um gradiente
                const hue = (index * 30) % 360;
                return `hsl(${hue}, 70%, 60%)`;
            });
            
            const chartData = {
                labels: labels,
                datasets: [{
                    label: 'Quantidade de Carregamentos',
                    data: data,
                    backgroundColor: backgroundColors,
                    borderColor: backgroundColors.map(color => color.replace('60%)', '40%)')),
                    borderWidth: 1
                }]
            };
            
            mixChart = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Faixa de Mix (Quantidade de Materiais)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Atualiza o gráfico de comparação entre unidades
        function updateComparisonChart(allData) {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            
            // Destrói o gráfico anterior se existir
            if (comparisonChart) {
                comparisonChart.destroy();
            }
            
            // Prepara os dados para o gráfico
            const labels = [];
            const datasets = [];
            
            // Obtém todas as faixas de mix possíveis
            const allRanges = new Set();
            Object.values(allData).forEach(unitData => {
                if (unitData.ranges) {
                    Object.keys(unitData.ranges).forEach(range => {
                        allRanges.add(range);
                    });
                }
            });
            
            if (allRanges.size === 0) {
                // Mostra mensagem quando não há dados
                document.getElementById('comparisonChart').innerHTML = `
                    <div class="text-center text-muted" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                        <i class="bi bi-exclamation-circle" style="font-size: 2rem;"></i>
                        <p>Nenhum dado disponível para o período selecionado</p>
                    </div>
                `;
                return;
            }
            
            // Ordena as faixas
            const sortedRanges = Array.from(allRanges).sort((a, b) => {
                return parseInt(a.split('-')[0]) - parseInt(b.split('-')[0]);
            });
            
            // Cria um dataset para cada unidade
            Object.keys(allData).forEach(unit => {
                if (unit !== 'all' && allData[unit].ranges && allData[unit].total > 0) {
                    const unitData = allData[unit];
                    const data = [];
                    
                    // Preenche os dados para cada faixa
                    sortedRanges.forEach(range => {
                        data.push(unitData.ranges[range] ? unitData.ranges[range].count : 0);
                    });
                    
                    // Adiciona o dataset
                    datasets.push({
                        label: unitsConfig[unit].name,
                        data: data,
                        backgroundColor: getUnitColor(unit),
                        borderColor: getUnitColor(unit, true),
                        borderWidth: 1
                    });
                }
            });
            
            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedRanges,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: false,
                            title: {
                                display: true,
                                text: 'Faixa de Mix'
                            }
                        },
                        y: {
                            stacked: false,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade de Carregamentos'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Atualiza o gráfico de tendência ao longo do tempo
        function updateTrendChart(unitData) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            // Destrói o gráfico anterior se existir
            if (trendChart) {
                trendChart.destroy();
            }
            
            if (!unitData || !unitData.carregamentos || unitData.carregamentos.length === 0) {
                // Mostra mensagem quando não há dados
                document.getElementById('trendChart').innerHTML = `
                    <div class="text-center text-muted" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                        <i class="bi bi-exclamation-circle" style="font-size: 2rem;"></i>
                        <p>Nenhum dado disponível para o período selecionado</p>
                    </div>
                `;
                return;
            }
            
            // Agrupa os dados por dia
            const dailyData = {};
            unitData.carregamentos.forEach(c => {
                if (c.inicio) {
                    const date = new Date(c.inicio);
                    const dateStr = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
                    
                    if (!dailyData[dateStr]) {
                        dailyData[dateStr] = {
                            date: date,
                            count: 0,
                            sum: 0,
                            max: 0,
                            min: Infinity,
                            carregamentos: []
                        };
                    }
                    
                    const mix = parseInt(c.mixMaterial);
                    dailyData[dateStr].count++;
                    dailyData[dateStr].sum += mix;
                    dailyData[dateStr].carregamentos.push(mix);
                    if (mix > dailyData[dateStr].max) dailyData[dateStr].max = mix;
                    if (mix < dailyData[dateStr].min) dailyData[dateStr].min = mix;
                }
            });
            
            // Ordena as datas
            const sortedDates = Object.keys(dailyData).sort((a, b) => {
                return dailyData[a].date - dailyData[b].date;
            });
            
            // Prepara os dados para o gráfico
            const labels = sortedDates;
            const avgData = sortedDates.map(date => {
                return (dailyData[date].sum / dailyData[date].count).toFixed(1);
            });
            const maxData = sortedDates.map(date => dailyData[date].max);
            const minData = sortedDates.map(date => dailyData[date].min === Infinity ? 0 : dailyData[date].min);
            
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Média de Mix',
                            data: avgData,
                            borderColor: 'rgba(52, 152, 219, 1)',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Mix Máximo',
                            data: maxData,
                            borderColor: 'rgba(231, 76, 60, 1)',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            tension: 0.1
                        },
                        {
                            label: 'Mix Mínimo',
                            data: minData,
                            borderColor: 'rgba(46, 204, 113, 1)',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade de Materiais'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Data'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.raw || 0;
                                    const date = labels[context.dataIndex];
                                    const total = dailyData[date].count;
                                    
                                    if (context.dataset.label === 'Média de Mix') {
                                        return `${label}: ${value} (${total} carregamentos)`;
                                    }
                                    return `${label}: ${value}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Retorna uma cor única para cada unidade
        function getUnitColor(unit, darker = false) {
            const unitIndex = Object.keys(unitsConfig).indexOf(unit);
            const hue = (unitIndex * 60) % 360;
            return darker ? `hsl(${hue}, 70%, 40%)` : `hsl(${hue}, 70%, 60%)`;
        }

        // Calcula a data de início com base no período selecionado
        function getStartDate(range) {
            const now = new Date();
            
            switch(range) {
                case 'today':
                    return new Date(now.getFullYear(), now.getMonth(), now.getDate());
                case 'yesterday':
                    const yesterday = new Date(now);
                    yesterday.setDate(yesterday.getDate() - 1);
                    return new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate());
                case 'week':
                    const lastWeek = new Date(now);
                    lastWeek.setDate(lastWeek.getDate() - 7);
                    return lastWeek;
                case 'month':
                    const lastMonth = new Date(now);
                    lastMonth.setMonth(lastMonth.getMonth() - 1);
                    return lastMonth;
                case 'all':
                    return new Date(0); // Data mínima
                default:
                    return new Date(now.getFullYear(), now.getMonth(), now.getDate());
            }
        }

        // Formata a informação do período selecionado
        function formatDateRangeInfo(range) {
            const now = new Date();
            const startDate = getStartDate(range);
            
            switch(range) {
                case 'today':
                    return `Exibindo dados de hoje (${now.getDate()}/${now.getMonth() + 1}/${now.getFullYear()})`;
                case 'yesterday':
                    return `Exibindo dados de ontem (${startDate.getDate()}/${startDate.getMonth() + 1}/${startDate.getFullYear()})`;
                case 'week':
                    return `Exibindo dados dos últimos 7 dias (de ${startDate.getDate()}/${startDate.getMonth() + 1} até ${now.getDate()}/${now.getMonth() + 1})`;
                case 'month':
                    return `Exibindo dados dos últimos 30 dias (de ${startDate.getDate()}/${startDate.getMonth() + 1} até ${now.getDate()}/${now.getMonth() + 1})`;
                case 'all':
                    return `Exibindo todo o histórico disponível`;
                default:
                    return `Exibindo dados do período selecionado`;
            }
        }

        // Carrega os dados de uma unidade específica
        async function loadUnitData(unit) {
            try {
                const startDate = getStartDate(currentDateRange);
                const endDate = new Date(); // Data atual
                
                // Se for hoje, ajusta para pegar até o final do dia
                if (currentDateRange === 'today' || currentDateRange === 'yesterday') {
                    endDate.setHours(23, 59, 59, 999);
                }
                
                const snapshot = await databaseRefs[unit].ref('carregamentos')
                    .orderByChild('inicio')
                    .startAt(startDate.getTime())
                    .endAt(endDate.getTime())
                    .once('value');
                
                const carregamentos = snapshot.val() || {};
                const carregamentosArray = Object.values(carregamentos);
                
                return calculateMixStats(carregamentosArray);
            } catch (error) {
                console.error(`Erro ao carregar dados da unidade ${unit}:`, error);
                return {
                    total: 0,
                    avg: 0,
                    max: 0,
                    min: 0,
                    mixValues: [],
                    ranges: {},
                    carregamentos: []
                };
            }
        }

        // Carrega os dados de todas as unidades
        async function loadAllData() {
            try {
                const promises = Object.keys(unitsConfig).map(unit => loadUnitData(unit));
                const results = await Promise.all(promises);
                
                // Armazena os dados por unidade
                Object.keys(unitsConfig).forEach((unit, index) => {
                    allMixData[unit] = results[index];
                });
                
                // Calcula os dados agregados (todas as unidades)
                const aggregated = {
                    total: 0,
                    avg: 0,
                    max: 0,
                    min: Infinity,
                    mixValues: [],
                    ranges: {},
                    carregamentos: []
                };
                
                // Combina todos os valores de mix
                Object.values(allMixData).forEach(stats => {
                    aggregated.total += stats.total;
                    aggregated.mixValues = aggregated.mixValues.concat(stats.mixValues);
                    aggregated.carregamentos = aggregated.carregamentos.concat(stats.carregamentos);
                    if (stats.max > aggregated.max) aggregated.max = stats.max;
                    if (stats.min < aggregated.min) aggregated.min = stats.min;
                });
                
                // Calcula média geral
                aggregated.avg = aggregated.mixValues.length > 0 ? 
                    (aggregated.mixValues.reduce((a, b) => a + b, 0) / aggregated.mixValues.length).toFixed(1) : 0;
                
                // Ajusta mínimo se não houver dados
                aggregated.min = aggregated.min === Infinity ? 0 : aggregated.min;
                
                // Cria faixas agregadas
                aggregated.ranges = createMixRanges(aggregated.mixValues, currentRange);
                
                allMixData.all = aggregated;
                
                // Atualiza o gráfico de comparação
                updateComparisonChart(allMixData);
                
                return allMixData;
            } catch (error) {
                console.error('Erro ao carregar dados de todas as unidades:', error);
                return null;
            }
        }

        // Atualiza a exibição com base na unidade selecionada
        async function updateDisplay(unit) {
            try {
                // Mostra loader
                const tableBody = document.querySelector('#mixTable tbody');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center">
                            <div class="loader"></div>
                            <p>Carregando dados...</p>
                        </td>
                    </tr>
                `;
                
                // Atualiza a informação do período
                document.getElementById('dataRangeInfo').textContent = formatDateRangeInfo(currentDateRange);
                
                // Carrega os dados se necessário
                if (Object.keys(allMixData).length === 0) {
                    await loadAllData();
                }
                
                // Obtém os dados da unidade selecionada
                const stats = unit === 'all' ? allMixData.all : allMixData[unit];
                
                // Atualiza a tabela, gráfico e cards
                updateTable(stats);
                updateBarChart(stats);
                updateStatsCards(stats);
                
                // Atualiza o gráfico de tendência se não for "Todas as Unidades"
                if (unit !== 'all') {
                    updateTrendChart(stats);
                } else {
                    document.getElementById('trendChart').innerHTML = `
                        <div class="text-center text-muted" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                            <i class="bi bi-info-circle" style="font-size: 2rem;"></i>
                            <p>Selecione uma unidade específica para visualizar a evolução do Mix</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Erro ao atualizar exibição:', error);
                
                const tableBody = document.querySelector('#mixTable tbody');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-danger">
                            <i class="bi bi-exclamation-triangle"></i>
                            Erro ao carregar dados. Tente novamente.
                        </td>
                    </tr>
                `;
            }
        }

        // Event Listeners
        function setupEventListeners() {
            // Seletor de unidade
            document.getElementById('unitSelector').addEventListener('change', function() {
                const selectedUnit = this.value;
                updateDisplay(selectedUnit);
            });
            
            // Seletor de intervalo
            document.getElementById('mixRange').addEventListener('change', function() {
                currentRange = parseInt(this.value);
                
                // Recarrega todos os dados com o novo intervalo
                allMixData = {};
                const selectedUnit = document.getElementById('unitSelector').value;
                updateDisplay(selectedUnit);
            });
            
            // Seletor de período
            document.getElementById('dateRange').addEventListener('change', function() {
                currentDateRange = this.value;
                
                // Recarrega todos os dados com o novo período
                allMixData = {};
                const selectedUnit = document.getElementById('unitSelector').value;
                updateDisplay(selectedUnit);
            });
        }

        // Inicializa a aplicação
        function init() {
            initializeFirebaseConnections();
            setupEventListeners();
            
            // Carrega os dados iniciais (todas as unidades)
            updateDisplay('all');
        }

        // Inicia quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>